<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TES Case Record Forms - 42 Days Follow-up (Sierra Leone)</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            font-family: 'Oswald', Arial, sans-serif;
            color: #000000;
            font-weight: 700;
            padding: 20px;
        }

        /* ============================================ */
        /* LOGIN SCREEN */
        /* ============================================ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
        }

        .login-header {
            background-color: #004080;
            color: #ffffff;
            padding: 25px 30px;
            text-align: center;
        }

        .login-header img {
            width: 140px;
            vertical-align: middle;
            border: none;
            border-radius: 8px;
        }

        .login-header h3 {
            margin: 12px 0 5px;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
        }

        .login-header p {
            margin: 0;
            font-size: 10px;
            font-weight: 700;
            color: #ffffff;
        }

        .login-body {
            border: 4px double #004080;
            border-radius: 12px;
            padding: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .login-content {
            padding: 35px;
        }

        .login-title {
            font-size: 17px;
            color: #000000;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }

        .login-subtitle {
            font-size: 16px;
            color: #000000;
            line-height: 1.8;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #000000;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 6px;
            color: #000000;
            font-size: 16px;
            font-family: 'Oswald', Arial, sans-serif;
            font-weight: 700;
        }

        .login-input:focus {
            outline: none;
            border-color: #28a745;
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: #004080;
            color: #ffffff;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            font-family: 'Oswald', Arial, sans-serif;
        }

        .login-btn:hover {
            background: #0056b3;
            color: #ffffff;
        }

        .login-error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #dc3545;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            font-weight: 700;
        }

        .login-error.show {
            display: block;
        }

        .login-footer {
            background-color: #004080;
            color: #ffffff;
            padding: 20px 30px;
            text-align: center;
            font-size: 13px;
            line-height: 1.7;
            font-weight: 700;
            margin-top: 10px;
        }

        .login-footer p {
            margin: 6px 0 0;
            font-size: 12px;
            color: #ffffff;
        }

        /* ============================================ */
        /* MAIN CONTENT */
        /* ============================================ */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .page-container {
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
        }

        /* HEADER */
        .page-header {
            background-color: #004080;
            color: #ffffff;
            padding: 25px 30px;
            text-align: center;
            margin-bottom: 10px;
        }

        .page-header img {
            width: 100px;
            vertical-align: middle;
            border: none;
            border-radius: 8px;
        }

        .page-header h3 {
            margin: 12px 0 5px;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
        }

        .page-header .tagline {
            margin: 0;
            font-size: 10px;
            font-weight: 700;
            color: #ffffff;
        }

        .page-header h1 {
            margin: 20px 0 10px;
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 1px;
        }

        .page-header .subtitle {
            font-size: 13px;
            color: #ffffff;
            font-weight: 700;
        }

        /* CONTROLS */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #004080;
            color: #ffffff;
            border: 2px solid #004080;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Oswald', Arial, sans-serif;
            letter-spacing: 0.5px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .control-btn:hover {
            background: #0056b3;
            border-color: #0056b3;
            color: #ffffff;
        }

        .control-btn.scan-btn {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .control-btn.scan-btn:hover {
            background: #138496;
            border-color: #138496;
        }

        .control-btn.new-btn {
            background: #28a745;
            border-color: #28a745;
        }

        .control-btn.new-btn:hover {
            background: #218838;
            border-color: #218838;
        }

        /* STATUS BAR */
        .status-bar {
            background: #ffffff;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.online {
            background: #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .status-text {
            font-weight: 700;
            font-size: 14px;
            color: #000000;
        }

        .pending-count {
            background: #004080;
            color: #ffffff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid #004080;
        }

        .patients-count {
            background: #28a745;
            color: #ffffff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid #28a745;
        }

        /* FORM MODE SELECTOR */
        .mode-selector {
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
        }

        .mode-title {
            font-size: 16px;
            font-weight: 700;
            color: #004080;
            margin-bottom: 15px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mode-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            border: 2px solid #004080;
            border-radius: 8px;
            background: #ffffff;
            color: #004080;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            text-align: center;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: #004080;
            color: #ffffff;
        }

        .mode-btn.active {
            background: #004080;
            color: #ffffff;
        }

        .mode-btn.enrollment {
            border-color: #28a745;
            color: #28a745;
        }

        .mode-btn.enrollment:hover,
        .mode-btn.enrollment.active {
            background: #28a745;
            color: #ffffff;
        }

        .mode-btn.followup {
            border-color: #17a2b8;
            color: #17a2b8;
        }

        .mode-btn.followup:hover,
        .mode-btn.followup.active {
            background: #17a2b8;
            color: #ffffff;
        }

        /* DAY SELECTOR */
        .day-selector {
            background: #e7f3ff;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            display: none;
        }

        .day-selector.show {
            display: block;
        }

        .day-selector-title {
            font-size: 14px;
            font-weight: 700;
            color: #004080;
            margin-bottom: 15px;
        }

        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .day-btn {
            padding: 10px 15px;
            border: 2px solid #004080;
            border-radius: 6px;
            background: #ffffff;
            color: #004080;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            min-width: 60px;
            text-align: center;
        }

        .day-btn:hover:not(:disabled) {
            background: #004080;
            color: #ffffff;
        }

        .day-btn.active {
            background: #004080;
            color: #ffffff;
        }

        .day-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e9ecef;
        }

        .day-btn.completed {
            background: #28a745;
            border-color: #28a745;
            color: #ffffff;
        }

        .day-btn.locked {
            background: #dc3545;
            border-color: #dc3545;
            color: #ffffff;
            opacity: 0.6;
        }

        /* FORM CARD */
        .form-card {
            border: 4px double #004080;
            border-radius: 12px;
            padding: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .form-content {
            padding: 25px;
        }

        /* PROGRESS */
        .progress-bar {
            background: #f8f9fa;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 2px solid #004080;
        }

        .progress-fill {
            background: linear-gradient(90deg, #004080, #0056b3);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #000000;
            font-size: 12px;
            margin-bottom: 25px;
            font-weight: 700;
        }

        /* SECTION */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #004080;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #004080;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .section-description {
            color: #000000;
            font-size: 12px;
            font-weight: 700;
        }

        /* FORM ELEMENTS */
        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #000000;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .form-label .required {
            color: #dc3545;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 6px;
            color: #000000;
            font-size: 14px;
            font-family: 'Oswald', Arial, sans-serif;
            font-weight: 700;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #004080;
        }

        .form-input:disabled,
        .form-select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #e9ecef;
        }

        .form-input.prefilled {
            background: #d4edda;
            border-color: #28a745;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* CHECKBOX GROUP */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        /* RADIO GROUP */
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .radio-group.vertical {
            flex-direction: column;
            gap: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-item label {
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        /* CRITERIA BOX */
        .criteria-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .criteria-box.inclusion {
            background: #d4edda;
            border-color: #28a745;
        }

        .criteria-box.exclusion {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .criteria-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #000000;
        }

        .criteria-list {
            list-style: none;
            padding: 0;
        }

        .criteria-list li {
            font-size: 12px;
            margin-bottom: 6px;
            padding-left: 20px;
            position: relative;
        }

        .criteria-list li::before {
            content: "â€¢";
            position: absolute;
            left: 5px;
            color: #004080;
        }

        /* SIGNATURE PAD */
        .signature-container {
            border: 2px solid #004080;
            border-radius: 6px;
            background: #ffffff;
            padding: 10px;
            margin-top: 10px;
        }

        .signature-canvas {
            width: 100%;
            height: 120px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #ffffff;
            touch-action: none;
            cursor: crosshair;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .signature-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            letter-spacing: 0.5px;
        }

        .signature-btn:hover {
            background: #c82333;
        }

        /* GPS LOCATION */
        .gps-container {
            background: #e7f3ff;
            border: 2px solid #004080;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }

        .gps-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .gps-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6c757d;
        }

        .gps-icon.loading {
            background: #ffc107;
            animation: pulse 1s ease-in-out infinite;
        }

        .gps-icon.success {
            background: #28a745;
        }

        .gps-icon.error {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .gps-info {
            font-size: 12px;
            color: #000000;
            font-weight: 700;
        }

        .gps-coords {
            font-size: 11px;
            color: #004080;
            font-weight: 700;
            font-family: monospace;
        }

        .gps-btn {
            padding: 8px 16px;
            background: #004080;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        .gps-btn:hover {
            background: #0056b3;
        }

        .gps-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* NAVIGATION */
        .navigation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-nav {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Oswald', Arial, sans-serif;
            min-width: 100px;
        }

        .btn-back {
            background: #ffffff;
            color: #004080;
        }

        .btn-back:hover {
            background: #004080;
            color: #ffffff;
        }

        .btn-next {
            background: #004080;
            color: #ffffff;
        }

        .btn-next:hover {
            background: #0056b3;
            border-color: #0056b3;
            color: #ffffff;
        }

        .btn-submit {
            background: #28a745;
            color: #ffffff;
            border-color: #28a745;
        }

        .btn-submit:hover:not(:disabled) {
            background: #218838;
            border-color: #218838;
            color: #ffffff;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* VOUCHER STYLES */
        .voucher-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
            overflow-y: auto;
        }

        .voucher-modal.show {
            display: flex;
        }

        .voucher-container {
            background: #ffffff;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            border: 4px double #004080;
            max-height: 90vh;
            overflow-y: auto;
        }

        .voucher-header {
            background: #004080;
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .voucher-title {
            font-size: 16px;
            font-weight: 700;
        }

        .voucher-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            font-weight: 700;
        }

        .voucher-content {
            padding: 30px;
            text-align: center;
        }

        .voucher-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .vouchers-preview-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .vouchers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        /* Individual Voucher Card */
        .voucher-card {
            width: 100%;
            background: linear-gradient(135deg, #004080 0%, #0056b3 100%);
            border-radius: 10px;
            overflow: hidden;
            font-family: 'Oswald', Arial, sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: grid;
            grid-template-columns: 1fr 80px;
            min-height: 160px;
        }

        .voucher-card-main {
            padding: 12px 15px;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .voucher-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .voucher-card-logo {
            width: 35px;
            height: 35px;
            background: #ffffff;
            border-radius: 6px;
            padding: 3px;
            flex-shrink: 0;
        }

        .voucher-card-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .voucher-card-study {
            font-size: 9px;
            opacity: 0.9;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .voucher-card-patient-id {
            font-size: 14px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 5px 0;
            display: inline-block;
        }

        .voucher-card-info {
            font-size: 9px;
            line-height: 1.4;
            opacity: 0.95;
        }

        .voucher-card-info-row {
            display: flex;
            gap: 5px;
        }

        .voucher-card-info-label {
            opacity: 0.8;
        }

        .voucher-card-schedule {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed rgba(255,255,255,0.3);
        }

        .voucher-card-schedule-title {
            font-size: 8px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .voucher-card-days {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .voucher-card-day {
            font-size: 7px;
            background: rgba(255,255,255,0.2);
            padding: 2px 4px;
            border-radius: 2px;
        }

        .voucher-card-qr-section {
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-left: 2px dashed rgba(0,64,128,0.3);
        }

        .voucher-card-qr {
            width: 60px;
            height: 60px;
        }

        .voucher-card-qr canvas {
            width: 60px !important;
            height: 60px !important;
        }

        .voucher-card-qr-label {
            font-size: 7px;
            color: #004080;
            margin-top: 5px;
            text-transform: uppercase;
            font-weight: 700;
        }

        /* PDF Grid Styles */
        .vouchers-pdf-grid {
            width: 794px; /* A4 width in pixels at 96dpi */
            padding: 20px;
            background: #ffffff;
        }

        .vouchers-pdf-page {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            page-break-after: always;
        }

        .voucher-pdf-card {
            width: 370px;
            background: linear-gradient(135deg, #004080 0%, #0056b3 100%);
            border-radius: 12px;
            overflow: hidden;
            font-family: 'Oswald', Arial, sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: grid;
            grid-template-columns: 1fr 100px;
            min-height: 180px;
        }

        .voucher-pdf-main {
            padding: 15px 18px;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .voucher-pdf-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .voucher-pdf-logo {
            width: 45px;
            height: 45px;
            background: #ffffff;
            border-radius: 8px;
            padding: 4px;
            flex-shrink: 0;
        }

        .voucher-pdf-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .voucher-pdf-study {
            font-size: 10px;
            opacity: 0.9;
            letter-spacing: 0.5px;
            line-height: 1.3;
        }

        .voucher-pdf-patient-id {
            font-size: 18px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            margin: 8px 0;
            display: inline-block;
        }

        .voucher-pdf-info {
            font-size: 10px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .voucher-pdf-info-row {
            display: flex;
            gap: 5px;
        }

        .voucher-pdf-info-label {
            opacity: 0.8;
            min-width: 45px;
        }

        .voucher-pdf-schedule {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(255,255,255,0.3);
        }

        .voucher-pdf-schedule-title {
            font-size: 9px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .voucher-pdf-days {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .voucher-pdf-day {
            font-size: 8px;
            background: rgba(255,255,255,0.2);
            padding: 2px 5px;
            border-radius: 3px;
        }

        .voucher-pdf-qr-section {
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-left: 2px dashed rgba(0,64,128,0.3);
        }

        .voucher-pdf-qr {
            width: 75px;
            height: 75px;
        }

        .voucher-pdf-qr canvas,
        .voucher-pdf-qr img {
            width: 75px !important;
            height: 75px !important;
        }

        .voucher-pdf-qr-label {
            font-size: 8px;
            color: #004080;
            margin-top: 6px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .voucher-pdf-code {
            font-size: 7px;
            color: #004080;
            font-weight: 600;
            margin-top: 3px;
            word-break: break-all;
            max-width: 75px;
            text-align: center;
        }

        .voucher-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            text-transform: uppercase;
            border: 2px solid;
            min-width: 150px;
        }

        .voucher-btn.print {
            background: #004080;
            color: #ffffff;
            border-color: #004080;
        }

        .voucher-btn.print:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        .voucher-btn.download {
            background: #28a745;
            color: #ffffff;
            border-color: #28a745;
        }

        .voucher-btn.download:hover {
            background: #218838;
            border-color: #218838;
        }

        /* QR SCANNER MODAL */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
        }

        .scanner-modal.show {
            display: flex;
        }

        .scanner-container {
            background: #ffffff;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            border: 4px double #004080;
        }

        .scanner-header {
            background: #17a2b8;
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-title {
            font-size: 16px;
            font-weight: 700;
        }

        .scanner-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            font-weight: 700;
        }

        .scanner-body {
            padding: 20px;
        }

        #qr-reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }

        #qr-reader video {
            border-radius: 8px;
        }

        .scanner-instructions {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
        }

        /* PATIENT LIST MODAL */
        .patients-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .patients-modal.show {
            display: flex;
        }

        .patients-content {
            background: #ffffff;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 4px double #004080;
        }

        .patients-header {
            background: #004080;
            color: #ffffff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .patients-title {
            font-size: 18px;
            font-weight: 700;
        }

        .patients-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            font-weight: 700;
        }

        .patients-body {
            padding: 20px;
        }

        .patient-card {
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .patient-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .patient-id {
            font-weight: 700;
            color: #004080;
            font-size: 16px;
        }

        .patient-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }

        .patient-status.active {
            background: #28a745;
            color: #ffffff;
        }

        .patient-status.completed {
            background: #17a2b8;
            color: #ffffff;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 12px;
        }

        .patient-info-item {
            display: flex;
            flex-direction: column;
        }

        .patient-info-label {
            color: #666;
            font-size: 10px;
        }

        .patient-info-value {
            font-weight: 700;
        }

        .patient-days-progress {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .day-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
        }

        .day-badge.completed {
            background: #28a745;
            color: #ffffff;
        }

        .day-badge.pending {
            background: #ffc107;
            color: #000000;
        }

        .day-badge.locked {
            background: #e9ecef;
            color: #666;
        }

        .patient-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .patient-action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            border: none;
        }

        .patient-action-btn.followup {
            background: #17a2b8;
            color: #ffffff;
        }

        .patient-action-btn.voucher {
            background: #004080;
            color: #ffffff;
        }

        .no-patients {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            font-size: 14px;
        }

        /* FOOTER */
        .page-footer {
            background-color: #004080;
            color: #ffffff;
            padding: 20px 30px;
            text-align: center;
            font-size: 13px;
            line-height: 1.7;
            font-weight: 700;
        }

        .page-footer p {
            margin: 6px 0 0;
            font-size: 12px;
            color: #ffffff;
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border: 2px solid #004080;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 4000;
            max-width: 400px;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.info {
            border-left: 4px solid #004080;
        }

        .notification.warning {
            border-left: 4px solid #ffc107;
        }

        .notification-text {
            color: #000000;
            font-size: 14px;
            font-weight: 700;
        }

        /* ALERT BOX */
        .alert-box {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            font-weight: 700;
        }

        .alert-box.info {
            background: #e7f3ff;
            border: 2px solid #004080;
            color: #004080;
        }

        .alert-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .alert-box.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .alert-box.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        /* ELIGIBILITY SUMMARY BOX */
        .eligibility-summary-box {
            border: 3px solid #004080;
            border-radius: 10px;
            overflow: hidden;
            background: #ffffff;
        }

        .eligibility-section {
            padding: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .eligibility-section:last-of-type {
            border-bottom: none;
        }

        .eligibility-title {
            font-size: 14px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 12px;
        }

        .eligibility-title.inclusion {
            background: #d4edda;
            color: #155724;
        }

        .eligibility-title.exclusion {
            background: #f8d7da;
            color: #721c24;
        }

        .eligibility-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .eligibility-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
        }

        .eligibility-item .status-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .eligibility-item.met .status-icon {
            color: #28a745;
        }

        .eligibility-item.met .status-icon::before {
            content: "âœ“";
        }

        .eligibility-item.not-met .status-icon {
            color: #dc3545;
        }

        .eligibility-item.not-met .status-icon::before {
            content: "âœ—";
        }

        .eligibility-item.pending .status-icon {
            color: #6c757d;
        }

        .eligibility-item.pending .status-icon::before {
            content: "â—‹";
        }

        .eligibility-item .status-value {
            margin-left: auto;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
        }

        .eligibility-item.met .status-value {
            background: #d4edda;
            color: #155724;
        }

        .eligibility-item.not-met .status-value {
            background: #f8d7da;
            color: #721c24;
        }

        .eligibility-item.pending .status-value {
            background: #e9ecef;
            color: #6c757d;
        }

        .eligibility-result {
            padding: 20px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
        }

        .eligibility-result .result-pending {
            color: #6c757d;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .eligibility-result .result-eligible {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .eligibility-result .result-not-eligible {
            color: #721c24;
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dc3545;
        }

        /* CONDITIONAL FIELD ANIMATION */
        .form-group[data-group] {
            transition: all 0.3s ease;
        }

        .form-group.conditional-show {
            display: block !important;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* PRINT STYLES */
        @media print {
            body * {
                visibility: hidden;
            }
            .vouchers-grid, .vouchers-grid * {
                visibility: visible;
            }
            .vouchers-grid {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5mm;
                padding: 5mm;
            }
            .voucher-card {
                page-break-inside: avoid;
            }
            .voucher-modal, .voucher-header, .voucher-actions {
                display: none !important;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .form-content {
                padding: 20px;
            }

            .controls-bar {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
            }

            .form-row {
                flex-direction: column;
            }

            .form-row .form-group {
                min-width: 100%;
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .btn-nav {
                width: 100%;
            }

            .voucher-buttons {
                flex-direction: column;
            }

            .day-buttons {
                justify-content: center;
            }

            .notification {
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================ -->
    <!-- LOGIN SCREEN -->
    <!-- ============================================ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                <h3>Informatics Consultancy Firm-Sierra Leone<br>(ICF-SL)</h3>
                <p><em>Driving Data-Driven Solutions for Health and Development</em></p>
            </div>

            <div class="login-body">
                <div class="login-content">
                    <h2 class="login-title">TES CASE RECORD FORMS</h2>
                    <p class="login-subtitle">Therapeutic Efficacy Study<br>42 Days Follow-up - Sierra Leone 2026</p>

                    <div class="login-error" id="loginError">Invalid username or password</div>

                    <form id="loginForm">
                        <div class="login-form-group">
                            <label class="login-label">USERNAME</label>
                            <input type="text" class="login-input" id="username" required autocomplete="username">
                        </div>

                        <div class="login-form-group">
                            <label class="login-label">PASSWORD</label>
                            <input type="password" class="login-input" id="password" required autocomplete="current-password">
                        </div>

                        <button type="submit" class="login-btn">LOGIN</button>
                    </form>
                </div>
            </div>

            <div class="login-footer">
                <p style="margin: 0;">Therapeutic Efficacy Study (TES) 2026</p>
                <p>Study Number: SL TES 2026</p>
                <p style="font-size: 11px;">National Malaria Control Programme - Sierra Leone</p>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MAIN CONTENT -->
    <!-- ============================================ -->
    <div class="main-content" id="mainContent">
        <div class="page-container">
            <div class="page-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                <h3>Study Number: SL TES 2026</h3>
                <p class="tagline"><em>National Malaria Control Programme</em></p>
                <h1>TES CASE RECORD FORMS</h1>
                <p class="subtitle">42 Days Follow-up</p>
            </div>

            <!-- CONTROLS -->
            <div class="controls-bar">
                <button class="control-btn new-btn" id="newScreeningBtn">+ NEW SCREENING</button>
                <button class="control-btn scan-btn" id="scanQRBtn">ðŸ“· SCAN VOUCHER</button>
                <button class="control-btn" id="viewPatientsBtn">ðŸ‘¥ PATIENTS (<span id="patientCountBadge">0</span>)</button>
                <button class="control-btn" id="viewDataBtn">ðŸ“Š VIEW DATA</button>
                <button class="control-btn" id="logoutBtn">LOGOUT</button>
            </div>

            <!-- STATUS BAR -->
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span class="status-text" id="statusText">CHECKING...</span>
                </div>
                <div class="status-item">
                    <span style="color: #000000; font-size: 12px;">ENROLLED:</span>
                    <span class="patients-count" id="enrolledCount">0</span>
                </div>
                <div class="status-item">
                    <span style="color: #000000; font-size: 12px;">PENDING SYNC:</span>
                    <span class="pending-count" id="pendingCount">0</span>
                </div>
            </div>

            <!-- MODE SELECTOR -->
            <div class="mode-selector" id="modeSelector">
                <div class="mode-title">SELECT FORM TYPE</div>
                <div class="mode-buttons">
                    <button class="mode-btn enrollment" id="enrollmentModeBtn" onclick="setMode('screening')">
                        ðŸ“‹ PATIENT SCREENING
                    </button>
                    <button class="mode-btn followup" id="followupModeBtn" onclick="setMode('followup')">
                        ðŸ“… FOLLOW-UP (Day 0-42)
                    </button>
                </div>
            </div>

            <!-- DAY SELECTOR (for follow-up) -->
            <div class="day-selector" id="daySelector">
                <div class="day-selector-title">SELECT FOLLOW-UP DAY FOR PATIENT: <span id="selectedPatientId">---</span></div>
                <div class="day-buttons" id="dayButtons">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- FORM CARD -->
            <div class="form-card" id="formCard" style="display: none;">
                <div class="form-content">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">SECTION 1 OF 6</div>

                    <form id="dataForm">
                        <input type="hidden" name="form_type" id="form_type" value="enrollment">
                        <input type="hidden" name="patient_id" id="patient_id" value="">
                        <input type="hidden" name="follow_up_day" id="follow_up_day" value="0">
                        <input type="hidden" name="study_number" value="SL TES 2026">
                        <div id="dynamicSections"></div>
                    </form>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="page-footer">
                <p style="margin: 0;">Therapeutic Efficacy Study (TES) 2026</p>
                <p>National Malaria Control Programme - Sierra Leone</p>
                <p style="font-size: 10px;">Â© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            </div>
        </div>
    </div>

    <!-- VOUCHER MODAL -->
    <div class="voucher-modal" id="voucherModal">
        <div class="voucher-container" style="max-width: 900px;">
            <div class="voucher-header">
                <span class="voucher-title">ðŸŽ« PATIENT VOUCHERS (10 COPIES)</span>
                <button class="voucher-close" onclick="closeVoucherModal()">&times;</button>
            </div>
            <div class="voucher-content" style="padding: 20px;">
                <div class="voucher-actions" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="voucher-btn download" onclick="downloadVouchersPDF()">ðŸ“„ DOWNLOAD PDF (10 VOUCHERS)</button>
                    <button class="voucher-btn print" onclick="printVouchers()">ðŸ–¨ï¸ PRINT</button>
                </div>
                <div class="vouchers-preview-container" id="vouchersPreviewContainer">
                    <div class="vouchers-grid" id="vouchersGrid">
                        <!-- 10 vouchers will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN VOUCHERS FOR PDF GENERATION -->
    <div id="vouchersPDFContainer" style="position: absolute; left: -9999px; top: 0;">
        <div class="vouchers-pdf-grid" id="vouchersPDFGrid"></div>
    </div>

    <!-- QR SCANNER MODAL -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-container">
            <div class="scanner-header">
                <span class="scanner-title">ðŸ“· SCAN PATIENT VOUCHER</span>
                <button class="scanner-close" onclick="closeScannerModal()">&times;</button>
            </div>
            <div class="scanner-body">
                <div id="qr-reader"></div>
                <p class="scanner-instructions">Point camera at the QR code on patient voucher</p>
            </div>
        </div>
    </div>

    <!-- PATIENTS LIST MODAL -->
    <div class="patients-modal" id="patientsModal">
        <div class="patients-content">
            <div class="patients-header">
                <span class="patients-title">ðŸ‘¥ ENROLLED PATIENTS</span>
                <button class="patients-close" onclick="closePatientsModal()">&times;</button>
            </div>
            <div class="patients-body" id="patientsModalBody">
                <!-- Patients list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification">
        <span class="notification-text" id="notificationText"></span>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
            GOOGLE_SHEET_URL: 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit',
            LOGIN_USERNAME: 'tes',
            LOGIN_PASSWORD: 'tes2026',
            STUDY_NUMBER: 'SL TES 2026',
            FOLLOW_UP_DAYS: [0, 1, 2, 3, 7, 14, 21, 28, 35, 42]
        };

        // Sierra Leone Districts
        const DISTRICTS = [
            'Bo District', 'Bombali District', 'Bonthe District', 'Falaba District',
            'Kailahun District', 'Kambia District', 'Karene District', 'Kenema District',
            'Koinadugu District', 'Kono District', 'Moyamba District', 'Port Loko District',
            'Pujehun District', 'Tonkolili District', 'Western Area Rural District', 'Western Area Urban District'
        ];

        // ============================================
        // STATE
        // ============================================
        const state = {
            pendingSubmissions: [],
            patients: {},
            submissions: {},
            isOnline: navigator.onLine,
            isLoggedIn: false,
            currentMode: null,
            currentSection: 1,
            totalSections: 0,
            selectedPatientId: null,
            selectedDay: 0,
            signaturePads: {},
            gpsLocation: null,
            qrScanner: null
        };

        // ============================================
        // FORM SECTIONS DEFINITION
        // ============================================
        const SCREENING_SECTIONS = {
            'Case Screening - Demographics': {
                description: 'Patient identification and demographic information',
                fields: {
                    health_centre_name: { label: 'Health Centre Name', type: 'text' },
                    district: { label: 'District', type: 'select', options: DISTRICTS },
                    patient_screening_number: { label: 'Patient Screening Number', type: 'text' },
                    patient_name: { label: 'Patient Name', type: 'text' },
                    date_of_birth: { label: 'Date of Birth', type: 'date', required: true, onchange: 'calculateAge(); evaluateCriteria();' },
                    age_in_years: { label: 'Age in Years', type: 'number', required: false, readonly: true },
                    age_in_months: { label: 'Age in Months (Total)', type: 'number', required: false, readonly: true },
                    age_display: { label: 'Age Display', type: 'text', required: false, readonly: true },
                    weight_kg: { label: 'Weight (kg)', type: 'number', onchange: 'evaluateCriteria();' },
                    sex: { label: 'Sex', type: 'radio', options: ['Male', 'Female'] },
                    tel: { label: 'Telephone', type: 'tel', required: false },
                    address_landmark: { label: 'Address/Landmark', type: 'textarea', required: false }
                }
            },
            'Pre-treatment Assessment': {
                description: 'Temperature and fever history',
                fields: {
                    fever_history_24h: { label: 'History of fever in previous 24 hours?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    temperature: { label: 'Temperature (Â°C)', type: 'number', onchange: 'evaluateCriteria();' },
                    temp_method: { label: 'Temperature Method', type: 'radio', options: ['Axillary', 'Infrared'] }
                }
            },
            'Blood Smear Results': {
                description: 'Microscopy results for parasite detection',
                fields: {
                    species_pf: { label: 'P. falciparum detected?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    other_species_present: { label: 'Were species other than P. falciparum present?', type: 'radio', options: ['Yes', 'No'], onchange: 'toggleConditionalField("other_species_group", this.value === "Yes"); evaluateCriteria();' },
                    other_species: { label: 'If yes, which species?', type: 'checkbox', options: ['P. vivax', 'P. ovale', 'P. malariae'], required: false, conditional: true, group: 'other_species_group' },
                    asexual_parasite_count: { label: 'Asexual P. falciparum parasites/Âµl', type: 'number', onchange: 'evaluateCriteria();' },
                    gametocytes_present: { label: 'P. falciparum gametocytes present?', type: 'radio', options: ['Yes', 'No'] },
                    pcr_sample_collected: { label: 'Blood sample for PCR collected?', type: 'radio', options: ['Yes', 'No'] }
                }
            },
            'Exclusion Criteria Assessment': {
                description: 'Check for any exclusion criteria (If ANY is Yes, patient is NOT eligible)',
                fields: {
                    ec_danger_signs: { label: 'Presence of general danger signs or signs of severe malaria?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    ec_malnutrition: { label: 'Severe malnutrition (MUAC <110mm)?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    ec_muac_value: { label: 'If checked, enter MUAC (mm)', type: 'number', required: false, conditional: true, group: 'muac_group' },
                    ec_other_febrile: { label: 'Other febrile conditions (measles, LRTI, severe diarrhea)?', type: 'radio', options: ['Yes', 'No'], onchange: 'toggleConditionalField("febrile_group", this.value === "Yes"); evaluateCriteria();' },
                    ec_other_febrile_specify: { label: 'If yes, specify condition', type: 'text', required: false, conditional: true, group: 'febrile_group' },
                    ec_chronic_disease: { label: 'Known chronic/severe diseases (cardiac, renal, hepatic, HIV)?', type: 'radio', options: ['Yes', 'No'], onchange: 'toggleConditionalField("chronic_group", this.value === "Yes"); evaluateCriteria();' },
                    ec_chronic_disease_specify: { label: 'If yes, specify disease', type: 'text', required: false, conditional: true, group: 'chronic_group' },
                    ec_interfering_meds: { label: 'Regular medication interfering with antimalarial pharmacokinetics?', type: 'radio', options: ['Yes', 'No'], onchange: 'toggleConditionalField("meds_group", this.value === "Yes"); evaluateCriteria();' },
                    ec_interfering_meds_specify: { label: 'If yes, specify medication', type: 'text', required: false, conditional: true, group: 'meds_group' },
                    ec_hypersensitivity: { label: 'History of hypersensitivity to test medicines?', type: 'radio', options: ['Yes', 'No'], onchange: 'toggleConditionalField("hypersensitivity_group", this.value === "Yes"); evaluateCriteria();' },
                    ec_hypersensitivity_specify: { label: 'If yes, specify reaction', type: 'text', required: false, conditional: true, group: 'hypersensitivity_group' }
                }
            },
            'Additional Inclusion Questions': {
                description: 'Questions that cannot be auto-calculated',
                fields: {
                    ic_oral_meds: { label: 'Is the patient able to swallow oral medication?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    ic_comply: { label: 'Is the patient/guardian willing to comply with study protocol and visit schedule?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' },
                    ic_consent: { label: 'Has informed consent been obtained from parent/guardian?', type: 'radio', options: ['Yes', 'No'], onchange: 'evaluateCriteria();' }
                }
            },
            'Eligibility Summary & Consent': {
                description: 'Auto-calculated eligibility status and final consent',
                fields: {
                    eligibility_summary: { label: 'ELIGIBILITY STATUS', type: 'summary' },
                    consent_form_signed: { label: 'Consent form signed?', type: 'radio', options: ['Yes', 'No'] },
                    consent_date: { label: 'Consent Date', type: 'date' },
                    enrolling_officer: { label: 'Screening Officer Name', type: 'text' },
                    officer_signature: { label: 'Officer Signature', type: 'signature' },
                    gps_location: { label: 'GPS Location', type: 'gps', required: false }
                }
            }
        };

        const FOLLOWUP_SECTIONS = {
            'Clinical Status': {
                description: 'Current clinical assessment',
                fields: {
                    visit_date: { label: 'Date of Visit', type: 'date' },
                    danger_signs_present: { label: 'Presence of danger signs or signs of severe/complicated malaria?', type: 'radio', options: ['Yes', 'No'] },
                    fever_history_24h: { label: 'History of fever within previous 24h?', type: 'radio', options: ['Yes', 'No'] },
                    temperature: { label: 'Temperature (Â°C)', type: 'number' },
                    temp_method: { label: 'Temperature Method', type: 'radio', options: ['Axillary', 'Infrared'] }
                }
            },
            'Blood Smear Results': {
                description: 'Microscopy results',
                fields: {
                    asexual_parasite_count: { label: 'Average number of asexual P. falciparum parasites/Âµl', type: 'number' },
                    gametocytes_present: { label: 'P. falciparum gametocytes present?', type: 'radio', options: ['Yes', 'No'] },
                    other_species_present: { label: 'Were species other than P. falciparum present?', type: 'radio', options: ['Yes', 'No'] },
                    other_species: { label: 'If yes, which species?', type: 'checkbox', options: ['P. vivax', 'P. ovale', 'P. malariae'], required: false },
                    pcr_sample_collected: { label: 'Blood sample for PCR collected?', type: 'radio', options: ['Yes', 'No'] }
                }
            },
            'Adverse Events': {
                description: 'Report any adverse events',
                fields: {
                    adverse_event_present: { label: 'Presence of an adverse event?', type: 'radio', options: ['Yes', 'No'] },
                    adverse_event_description: { label: 'If yes, describe the adverse event', type: 'textarea', required: false },
                    serious_adverse_event: { label: 'Is it a serious adverse event?', type: 'radio', options: ['Yes', 'No'], required: false }
                }
            },
            'Medication Administration': {
                description: 'Record medication given',
                fields: {
                    antimalarial_drug_1: { label: 'Antimalarial Drug 1 Name', type: 'text', required: false },
                    dose_1_time: { label: 'Dose 1 Time (HH:MM)', type: 'time', required: false },
                    dose_1_tablets: { label: 'Dose 1 Number of Tablets', type: 'number', required: false },
                    dose_1_vomit: { label: 'Did patient vomit after Dose 1?', type: 'radio', options: ['Yes', 'No'], required: false },
                    dose_1_vomit_time: { label: 'If yes, time of vomiting', type: 'time', required: false },
                    antimalarial_drug_2: { label: 'Antimalarial Drug 2 Name', type: 'text', required: false },
                    dose_2_time: { label: 'Dose 2 Time (HH:MM)', type: 'time', required: false },
                    dose_2_tablets: { label: 'Dose 2 Number of Tablets', type: 'number', required: false },
                    dose_2_vomit: { label: 'Did patient vomit after Dose 2?', type: 'radio', options: ['Yes', 'No'], required: false },
                    other_medicine_name: { label: 'Other Medicine Name', type: 'text', required: false },
                    other_medicine_dose: { label: 'Other Medicine Dose', type: 'text', required: false }
                }
            },
            'Visit Completion': {
                description: 'Complete the visit record',
                fields: {
                    examining_officer: { label: 'Examining Officer Name', type: 'text' },
                    officer_signature: { label: 'Officer Signature', type: 'signature' },
                    notes: { label: 'Additional Notes', type: 'textarea', required: false }
                }
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            loadFromLocalStorage();
            state.isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            
            if (state.isLoggedIn) {
                showMainContent();
            }

            setupEventListeners();
        }

        function loadFromLocalStorage() {
            // Load pending submissions
            const savedPending = localStorage.getItem('tes_pendingSubmissions');
            if (savedPending) {
                try {
                    state.pendingSubmissions = JSON.parse(savedPending);
                } catch (e) {
                    state.pendingSubmissions = [];
                }
            }

            // Load patients
            const savedPatients = localStorage.getItem('tes_patients');
            if (savedPatients) {
                try {
                    state.patients = JSON.parse(savedPatients);
                } catch (e) {
                    state.patients = {};
                }
            }

            // Load submissions
            const savedSubmissions = localStorage.getItem('tes_submissions');
            if (savedSubmissions) {
                try {
                    state.submissions = JSON.parse(savedSubmissions);
                } catch (e) {
                    state.submissions = {};
                }
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('tes_pendingSubmissions', JSON.stringify(state.pendingSubmissions));
            localStorage.setItem('tes_patients', JSON.stringify(state.patients));
            localStorage.setItem('tes_submissions', JSON.stringify(state.submissions));
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('newScreeningBtn').addEventListener('click', () => setMode('screening'));
            document.getElementById('scanQRBtn').addEventListener('click', openScannerModal);
            document.getElementById('viewPatientsBtn').addEventListener('click', openPatientsModal);
            document.getElementById('viewDataBtn').addEventListener('click', handleViewData);
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            window.addEventListener('online', handleOnlineEvent);
            window.addEventListener('offline', handleOfflineEvent);
        }

        // ============================================
        // LOGIN / LOGOUT
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (username === CONFIG.LOGIN_USERNAME && password === CONFIG.LOGIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('username', username);
                state.isLoggedIn = true;
                errorDiv.classList.remove('show');
                showMainContent();
            } else {
                errorDiv.classList.add('show');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('username');
            state.isLoggedIn = false;
            document.getElementById('mainContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
            updateOnlineStatus();
            updateCounts();
            
            if (state.isOnline && state.pendingSubmissions.length > 0) {
                syncPendingSubmissions();
            }
        }

        // ============================================
        // MODE SELECTION
        // ============================================
        function setMode(mode) {
            state.currentMode = mode;
            
            // Update mode buttons
            document.getElementById('enrollmentModeBtn').classList.toggle('active', mode === 'screening');
            document.getElementById('followupModeBtn').classList.toggle('active', mode === 'followup');
            
            if (mode === 'screening') {
                document.getElementById('daySelector').classList.remove('show');
                document.getElementById('form_type').value = 'screening';
                document.getElementById('follow_up_day').value = '-1'; // -1 indicates screening
                state.selectedDay = -1;
                state.selectedPatientId = null;
                generatePatientId();
                generateFormSections(SCREENING_SECTIONS);
                document.getElementById('formCard').style.display = 'block';
            } else if (mode === 'followup') {
                document.getElementById('formCard').style.display = 'none';
                showNotification('Scan patient voucher or select patient from list', 'info');
            }
        }

        // ============================================
        // PATIENT ID GENERATION
        // ============================================
        function generatePatientId() {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            const patientId = `TES-${timestamp}-${random}`;
            document.getElementById('patient_id').value = patientId;
            return patientId;
        }

        // ============================================
        // FORM GENERATION
        // ============================================
        function generateFormSections(sections) {
            const container = document.getElementById('dynamicSections');
            let html = '';
            let sectionNum = 1;
            
            const sectionKeys = Object.keys(sections);
            state.totalSections = sectionKeys.length;
            state.currentSection = 1;
            
            sectionKeys.forEach((sectionTitle, index) => {
                const section = sections[sectionTitle];
                const isLastSection = index === sectionKeys.length - 1;
                
                html += `
                    <div class="form-section ${sectionNum === 1 ? 'active' : ''}" data-section="${sectionNum}">
                        <div class="section-header">
                            <h2 class="section-title">${sectionTitle.toUpperCase()}</h2>
                            <p class="section-description">${section.description}</p>
                        </div>
                `;
                
                // Add exclusion criteria info box
                if (sectionTitle === 'Exclusion Criteria Assessment') {
                    html += `
                        <div class="criteria-box exclusion">
                            <div class="criteria-title">âš ï¸ DANGER SIGNS (WHO Definition)</div>
                            <ul class="criteria-list">
                                <li>Unable to drink or breastfeed</li>
                                <li>Vomiting everything</li>
                                <li>Convulsions</li>
                                <li>Lethargy or unconsciousness</li>
                                <li>Unable to sit or stand</li>
                            </ul>
                            <div class="criteria-title" style="margin-top: 10px;">âš ï¸ SIGNS OF SEVERE MALARIA</div>
                            <ul class="criteria-list">
                                <li>Prostration</li>
                                <li>Impaired consciousness</li>
                                <li>Respiratory distress</li>
                                <li>Multiple convulsions</li>
                                <li>Circulatory collapse</li>
                                <li>Pulmonary oedema</li>
                                <li>Abnormal bleeding</li>
                                <li>Jaundice</li>
                                <li>Haemoglobinuria</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Add info box for Additional Inclusion Questions
                if (sectionTitle === 'Additional Inclusion Questions') {
                    html += `
                        <div class="criteria-box info" style="background: #e7f3ff; border-color: #004080;">
                            <div class="criteria-title" style="color: #004080;">â„¹ï¸ AUTO-CALCULATED CRITERIA (from previous sections):</div>
                            <ul class="criteria-list">
                                <li><strong>Age 6-59 months</strong> - Calculated from Date of Birth</li>
                                <li><strong>Weight â‰¥5 kg</strong> - From weight entered</li>
                                <li><strong>P. falciparum mono-infection</strong> - From blood smear results</li>
                                <li><strong>Parasitaemia 2,000-200,000/Âµl</strong> - From parasite count</li>
                                <li><strong>Fever/Temperature</strong> - From temperature and fever history</li>
                            </ul>
                            <p style="margin-top: 10px; font-size: 11px; color: #004080;">The questions below cannot be auto-calculated and require clinical assessment.</p>
                        </div>
                    `;
                }
                
                // Generate fields
                const fields = Object.entries(section.fields);
                fields.forEach(([fieldName, fieldConfig]) => {
                    html += generateField(fieldName, fieldConfig);
                });
                
                // Navigation buttons
                html += '<div class="navigation-buttons">';
                
                if (sectionNum > 1) {
                    html += '<button type="button" class="btn-nav btn-back" onclick="previousSection()">â† BACK</button>';
                }
                
                if (isLastSection) {
                    html += '<button type="submit" class="btn-nav btn-submit" id="submitBtn">ðŸ“¤ SUBMIT</button>';
                } else {
                    html += '<button type="button" class="btn-nav btn-next" onclick="nextSection()">NEXT â†’</button>';
                }
                
                html += '</div></div>';
                
                sectionNum++;
            });
            
            container.innerHTML = html;
            updateProgress();
            
            // Initialize signature pads after a short delay
            setTimeout(() => {
                initializeSignaturePads();
            }, 100);
        }

        function generateField(fieldName, fieldConfig) {
            const label = fieldConfig.label;
            const type = fieldConfig.type || 'text';
            const required = fieldConfig.required !== false;
            const readonly = fieldConfig.readonly === true;
            const onchange = fieldConfig.onchange || '';
            const conditional = fieldConfig.conditional === true;
            const group = fieldConfig.group || '';
            
            let hiddenStyle = conditional ? 'style="display: none;"' : '';
            let groupAttr = group ? `data-group="${group}"` : '';
            
            let html = `<div class="form-group" ${hiddenStyle} ${groupAttr}>`;
            html += `<label class="form-label">${label.toUpperCase()} ${required && !conditional ? '<span class="required">*</span>' : ''}</label>`;
            
            if (type === 'summary') {
                // Eligibility summary box
                html += `
                    <div class="eligibility-summary-box" id="eligibility_summary_box">
                        <div class="eligibility-section">
                            <div class="eligibility-title inclusion">INCLUSION CRITERIA</div>
                            <div class="eligibility-items" id="inclusion_items">
                                <div class="eligibility-item" id="ic_age_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Age 6-59 months</span>
                                    <span class="status-value" id="ic_age_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_mono_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>P. falciparum mono-infection</span>
                                    <span class="status-value" id="ic_mono_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_parasitaemia_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Parasitaemia 2,000-200,000/Âµl</span>
                                    <span class="status-value" id="ic_parasitaemia_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_fever_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Fever â‰¥37.5Â°C or history</span>
                                    <span class="status-value" id="ic_fever_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_weight_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Weight â‰¥5 kg</span>
                                    <span class="status-value" id="ic_weight_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_oral_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Can swallow oral medication</span>
                                    <span class="status-value" id="ic_oral_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_comply_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Willing to comply with protocol</span>
                                    <span class="status-value" id="ic_comply_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ic_consent_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Informed consent obtained</span>
                                    <span class="status-value" id="ic_consent_value">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="eligibility-section">
                            <div class="eligibility-title exclusion">EXCLUSION CRITERIA (Must all be NO)</div>
                            <div class="eligibility-items" id="exclusion_items">
                                <div class="eligibility-item" id="ec_danger_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Danger signs/severe malaria</span>
                                    <span class="status-value" id="ec_danger_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_mixed_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Mixed Plasmodium infection</span>
                                    <span class="status-value" id="ec_mixed_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_malnutrition_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Severe malnutrition</span>
                                    <span class="status-value" id="ec_malnutrition_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_febrile_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Other febrile conditions</span>
                                    <span class="status-value" id="ec_febrile_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_chronic_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Chronic/severe diseases</span>
                                    <span class="status-value" id="ec_chronic_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_meds_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Interfering medications</span>
                                    <span class="status-value" id="ec_meds_value">--</span>
                                </div>
                                <div class="eligibility-item" id="ec_hypersensitivity_status">
                                    <span class="status-icon">â—‹</span>
                                    <span>Hypersensitivity history</span>
                                    <span class="status-value" id="ec_hypersensitivity_value">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="eligibility-result" id="eligibility_result">
                            <div class="result-pending">â³ COMPLETE ALL SECTIONS TO DETERMINE ELIGIBILITY</div>
                        </div>
                        <div class="submit-info" style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 6px; font-size: 11px; text-align: left;">
                            <strong style="color: #004080;">ðŸ“‹ WHAT HAPPENS ON SUBMIT:</strong><br>
                            <span style="color: #155724;">âœ“ ELIGIBLE:</span> Data submitted + 10 vouchers generated for download<br>
                            <span style="color: #721c24;">âœ— NOT ELIGIBLE:</span> Screening data submitted (no voucher generated)
                        </div>
                    </div>
                    <input type="hidden" name="is_eligible" id="is_eligible" value="">
                    <input type="hidden" name="eligibility_reason" id="eligibility_reason" value="">
                `;
            } else if (type === 'signature') {
                html += `
                    <div class="signature-container">
                        <canvas class="signature-canvas" id="${fieldName}_canvas" data-field="${fieldName}"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="signature-btn" onclick="clearSignature('${fieldName}')">CLEAR</button>
                        </div>
                    </div>
                    <input type="hidden" name="${fieldName}" id="${fieldName}" ${required ? 'required' : ''}>
                `;
            } else if (type === 'gps') {
                html += `
                    <div class="gps-container">
                        <div class="gps-status">
                            <div class="gps-icon" id="gps_icon"></div>
                            <div>
                                <div class="gps-info" id="gps_status">Click button to capture GPS location</div>
                                <div class="gps-coords" id="gps_coords"></div>
                            </div>
                        </div>
                        <button type="button" class="gps-btn" id="gps_capture_btn" onclick="captureGPS()">ðŸ“ CAPTURE GPS</button>
                    </div>
                    <input type="hidden" name="gps_latitude" id="gps_latitude">
                    <input type="hidden" name="gps_longitude" id="gps_longitude">
                    <input type="hidden" name="gps_accuracy" id="gps_accuracy">
                `;
            } else if (type === 'radio') {
                html += '<div class="radio-group">';
                fieldConfig.options.forEach((option, idx) => {
                    const onchangeAttr = onchange ? `onchange="${onchange}"` : '';
                    html += `
                        <div class="radio-item">
                            <input type="radio" name="${fieldName}" id="${fieldName}_${idx}" value="${option}" ${required && !conditional ? 'required' : ''} ${onchangeAttr}>
                            <label for="${fieldName}_${idx}">${option}</label>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (type === 'checkbox') {
                html += '<div class="checkbox-group">';
                fieldConfig.options.forEach((option, idx) => {
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" name="${fieldName}" id="${fieldName}_${idx}" value="${option}">
                            <label for="${fieldName}_${idx}">${option}</label>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (type === 'select') {
                html += `<select class="form-select" name="${fieldName}" ${required && !conditional ? 'required' : ''} ${onchange ? `onchange="${onchange}"` : ''}>`;
                html += '<option value="">Select...</option>';
                fieldConfig.options.forEach(option => {
                    html += `<option value="${option}">${option}</option>`;
                });
                html += '</select>';
            } else if (type === 'textarea') {
                html += `<textarea class="form-textarea" name="${fieldName}" rows="3" ${required && !conditional ? 'required' : ''} ${readonly ? 'readonly' : ''}></textarea>`;
            } else if (type === 'date') {
                html += `<input type="date" class="form-input" name="${fieldName}" id="${fieldName}" ${required && !conditional ? 'required' : ''} ${onchange ? `onchange="${onchange}"` : ''}>`;
            } else if (type === 'time') {
                html += `<input type="time" class="form-input" name="${fieldName}" ${required && !conditional ? 'required' : ''}>`;
            } else if (type === 'number') {
                const readonlyClass = readonly ? 'prefilled' : '';
                html += `<input type="number" class="form-input ${readonlyClass}" name="${fieldName}" id="${fieldName}" step="any" ${required && !conditional ? 'required' : ''} ${readonly ? 'readonly' : ''} ${onchange ? `onchange="${onchange}"` : ''}>`;
            } else if (type === 'tel') {
                html += `<input type="tel" class="form-input" name="${fieldName}" ${required && !conditional ? 'required' : ''}>`;
            } else {
                const readonlyClass = readonly ? 'prefilled' : '';
                html += `<input type="text" class="form-input ${readonlyClass}" name="${fieldName}" id="${fieldName}" ${required && !conditional ? 'required' : ''} ${readonly ? 'readonly' : ''}>`;
            }
            
            html += '</div>';
            return html;
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function nextSection() {
            const currentSectionEl = document.querySelector(`.form-section[data-section="${state.currentSection}"]`);
            const inputs = currentSectionEl.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                // Skip hidden conditional fields
                const formGroup = input.closest('.form-group');
                if (formGroup && formGroup.style.display === 'none') {
                    return;
                }
                
                if (input.type === 'radio') {
                    const radioGroup = currentSectionEl.querySelectorAll(`input[name="${input.name}"]`);
                    const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                    if (!isChecked) {
                        isValid = false;
                    }
                } else if (!input.value) {
                    isValid = false;
                    input.style.borderColor = '#dc3545';
                    setTimeout(() => input.style.borderColor = '', 3000);
                }
            });
            
            if (!isValid) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Re-evaluate criteria when moving to next section
            if (state.currentMode === 'screening') {
                evaluateCriteria();
            }
            
            if (state.currentSection < state.totalSections) {
                currentSectionEl.classList.remove('active');
                state.currentSection++;
                const nextSectionEl = document.querySelector(`.form-section[data-section="${state.currentSection}"]`);
                if (nextSectionEl) {
                    nextSectionEl.classList.add('active');
                    updateProgress();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    // Re-evaluate criteria when entering eligibility section
                    if (state.currentMode === 'screening') {
                        setTimeout(() => evaluateCriteria(), 100);
                    }
                }
            }
        }

        function previousSection() {
            if (state.currentSection > 1) {
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.remove('active');
                state.currentSection--;
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.add('active');
                updateProgress();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateProgress() {
            const progress = (state.currentSection / state.totalSections) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            let modeLabel = state.currentMode === 'screening' ? 'PATIENT SCREENING' : `DAY ${state.selectedDay} - FOLLOW-UP`;
            document.getElementById('progressText').innerHTML = `${modeLabel} | SECTION ${state.currentSection} OF ${state.totalSections}`;
        }

        // ============================================
        // FORM SUBMISSION
        // ============================================
        async function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();

            const formData = new FormData(e.target);
            const patientId = document.getElementById('patient_id').value;
            const day = parseInt(document.getElementById('follow_up_day').value);
            
            // Check for duplicate entry
            const submissionKey = `${patientId}_day${day}`;
            if (state.submissions[submissionKey]) {
                showNotification(`Entry for ${patientId} on Day ${day} already exists!`, 'error');
                return;
            }
            
            // For enrollment, check eligibility
            let isEligible = true;
            let eligibilityReason = '';
            
            if (state.currentMode === 'screening') {
                const isEligibleInput = document.getElementById('is_eligible');
                isEligible = isEligibleInput && isEligibleInput.value === 'Yes';
                eligibilityReason = document.getElementById('eligibility_reason')?.value || '';
                
                // If eligible, also check consent
                if (isEligible) {
                    const consentSigned = document.querySelector('input[name="consent_form_signed"]:checked');
                    if (!consentSigned || consentSigned.value !== 'Yes') {
                        showNotification('Cannot proceed: Consent form must be signed', 'error');
                        return;
                    }
                }
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                submittedBy: sessionStorage.getItem('username') || 'admin',
                patient_id: patientId,
                follow_up_day: day,
                form_type: state.currentMode
            };
            
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Handle checkbox groups
            const checkboxGroups = {};
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    if (!checkboxGroups[checkbox.name]) {
                        checkboxGroups[checkbox.name] = [];
                    }
                    checkboxGroups[checkbox.name].push(checkbox.value);
                }
            });
            
            for (const [key, values] of Object.entries(checkboxGroups)) {
                data[key] = values.join(', ');
            }

            // Save submission
            state.submissions[submissionKey] = data;
            
            // For screening, save patient info only if eligible (no days completed yet)
            if (state.currentMode === 'screening') {
                if (isEligible) {
                    state.patients[patientId] = {
                        patientId: patientId,
                        patientName: data.patient_name,
                        healthCentre: data.health_centre_name,
                        district: data.district,
                        screeningDate: data.consent_date || new Date().toISOString().split('T')[0],
                        dateOfBirth: data.date_of_birth,
                        ageInYears: data.age_in_years,
                        ageInMonths: data.age_in_months,
                        ageDisplay: data.age_display,
                        sex: data.sex,
                        weight: data.weight_kg,
                        parasiteCount: data.asexual_parasite_count,
                        temperature: data.temperature,
                        completedDays: [], // No days completed yet - Day 0 is first follow-up
                        isEligible: true
                    };
                } else {
                    // For ineligible patients, save screening data but don't add to enrolled patients
                    data.screening_outcome = 'NOT_ELIGIBLE';
                    data.screening_reason = eligibilityReason;
                }
            } else {
                // Update completed days for follow-up
                if (state.patients[patientId]) {
                    if (!state.patients[patientId].completedDays.includes(day)) {
                        state.patients[patientId].completedDays.push(day);
                        state.patients[patientId].completedDays.sort((a, b) => a - b);
                    }
                }
            }
            
            saveToLocalStorage();
            updateCounts();

            if (state.isOnline) {
                await submitToServer(data);
            } else {
                saveOffline(data);
            }
            
            // Show voucher ONLY for eligible enrollment, otherwise just reset
            if (state.currentMode === 'screening') {
                if (isEligible) {
                    showVoucher(patientId, data);
                } else {
                    showNotification(`Screening data submitted. Patient NOT ELIGIBLE: ${eligibilityReason}`, 'warning');
                    resetForm();
                }
            } else {
                showNotification(`Day ${day} data submitted successfully!`, 'success');
                resetForm();
            }
        }

        async function submitToServer(data) {
            try {
                const response = await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                showNotification('Data submitted successfully!', 'success');
                
            } catch (error) {
                console.error('Submit error:', error);
                showNotification('Failed to submit - Saved offline', 'error');
                saveOffline(data);
            }
        }

        function saveOffline(data) {
            state.pendingSubmissions.push(data);
            saveToLocalStorage();
            updateCounts();
            showNotification('Data saved offline - Will sync when online', 'info');
        }

        async function syncPendingSubmissions() {
            if (state.pendingSubmissions.length === 0) return;

            showNotification('Syncing pending submissions...', 'info');
            const successfulSyncs = [];
            
            for (let i = 0; i < state.pendingSubmissions.length; i++) {
                try {
                    await fetch(CONFIG.SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(state.pendingSubmissions[i])
                    });
                    successfulSyncs.push(i);
                } catch (error) {
                    console.error('Sync error:', error);
                }
            }

            if (successfulSyncs.length > 0) {
                state.pendingSubmissions = state.pendingSubmissions.filter((_, index) => 
                    !successfulSyncs.includes(index)
                );
                saveToLocalStorage();
                updateCounts();
                showNotification(`Synced ${successfulSyncs.length} submission(s)`, 'success');
            }
        }

        function resetForm() {
            document.getElementById('dataForm').reset();
            document.getElementById('formCard').style.display = 'none';
            document.getElementById('daySelector').classList.remove('show');
            state.currentMode = null;
            state.selectedPatientId = null;
            state.selectedDay = 0;
            
            document.getElementById('enrollmentModeBtn').classList.remove('active');
            document.getElementById('followupModeBtn').classList.remove('active');
            
            // Clear signatures
            Object.keys(state.signaturePads).forEach(fieldName => {
                clearSignature(fieldName);
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // VOUCHER FUNCTIONS
        // ============================================
        function showVoucher(patientId, data) {
            const patient = state.patients[patientId];
            if (!patient) return;
            
            // Generate voucher grid (10 vouchers - 2 columns x 5 rows)
            generateVoucherGrid(patient, patientId);
            
            document.getElementById('voucherModal').classList.add('show');
        }

        function generateVoucherGrid(patient, patientId) {
            const gridContainer = document.getElementById('vouchersGrid');
            const pdfContainer = document.getElementById('vouchersPDFGrid');
            
            const followUpDays = ['D0', 'D1', 'D2', 'D3', 'D7', 'D14', 'D21', 'D28', 'D35', 'D42'];
            
            // Generate preview vouchers (smaller for modal)
            let previewHtml = '';
            for (let i = 0; i < 10; i++) {
                previewHtml += generateVoucherCard(patient, patientId, followUpDays, i, 'preview');
            }
            gridContainer.innerHTML = previewHtml;
            
            // Generate PDF vouchers (larger for printing)
            let pdfHtml = '<div class="vouchers-pdf-page">';
            for (let i = 0; i < 10; i++) {
                pdfHtml += generateVoucherCard(patient, patientId, followUpDays, i, 'pdf');
            }
            pdfHtml += '</div>';
            pdfContainer.innerHTML = pdfHtml;
            
            // Generate QR codes after DOM is updated
            setTimeout(() => {
                generateAllQRCodes(patientId, patient);
            }, 100);
        }

        function generateVoucherCard(patient, patientId, followUpDays, index, type) {
            const prefix = type === 'pdf' ? 'voucher-pdf' : 'voucher-card';
            const qrId = type === 'pdf' ? `qr-pdf-${index}` : `qr-preview-${index}`;
            
            const shortId = patientId.length > 20 ? patientId.substring(0, 20) + '...' : patientId;
            
            return `
                <div class="${prefix === 'voucher-pdf' ? 'voucher-pdf-card' : 'voucher-card'}">
                    <div class="${prefix}-main">
                        <div class="${prefix}-header">
                            <div class="${prefix}-logo">
                                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="Logo">
                            </div>
                            <div class="${prefix}-study">
                                TES 2026<br>
                                SIERRA LEONE
                            </div>
                        </div>
                        <div class="${prefix}-patient-id">${shortId}</div>
                        <div class="${prefix}-info">
                            <div class="${prefix}-info-row">
                                <span class="${prefix}-info-label">Name:</span>
                                <span>${patient.patientName || '---'}</span>
                            </div>
                            <div class="${prefix}-info-row">
                                <span class="${prefix}-info-label">Age:</span>
                                <span>${patient.ageDisplay || (patient.ageInMonths + ' months') || '---'}</span>
                            </div>
                            <div class="${prefix}-info-row">
                                <span class="${prefix}-info-label">HC:</span>
                                <span>${patient.healthCentre || '---'}</span>
                            </div>
                        </div>
                        <div class="${prefix}-schedule">
                            <div class="${prefix}-schedule-title">FOLLOW-UP SCHEDULE</div>
                            <div class="${prefix}-days">
                                ${followUpDays.map(d => `<span class="${prefix}-day">${d}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="${prefix}-qr-section">
                        <div class="${prefix}-qr" id="${qrId}"></div>
                        <div class="${prefix}-qr-label">SCAN</div>
                        ${type === 'pdf' ? `<div class="voucher-pdf-code">${patientId.substring(patientId.length - 8)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function generateAllQRCodes(patientId, patient) {
            const qrData = JSON.stringify({
                id: patientId,
                n: patient.patientName,
                hc: patient.healthCentre,
                d: patient.screeningDate
            });
            
            // Generate preview QR codes
            for (let i = 0; i < 10; i++) {
                const previewContainer = document.getElementById(`qr-preview-${i}`);
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                    new QRCode(previewContainer, {
                        text: qrData,
                        width: 60,
                        height: 60,
                        colorDark: '#004080',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
                
                const pdfContainer = document.getElementById(`qr-pdf-${i}`);
                if (pdfContainer) {
                    pdfContainer.innerHTML = '';
                    new QRCode(pdfContainer, {
                        text: qrData,
                        width: 75,
                        height: 75,
                        colorDark: '#004080',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            }
        }

        function closeVoucherModal() {
            document.getElementById('voucherModal').classList.remove('show');
            resetForm();
        }

        async function downloadVouchersPDF() {
            showNotification('Generating PDF with 10 vouchers...', 'info');
            
            const patientId = Object.keys(state.patients).pop();
            const patient = state.patients[patientId];
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // A4 dimensions in mm: 210 x 297
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const voucherWidth = (pageWidth - margin * 3) / 2; // 2 columns
                const voucherHeight = (pageHeight - margin * 6) / 5; // 5 rows
                
                const followUpDays = ['D0', 'D1', 'D2', 'D3', 'D7', 'D14', 'D21', 'D28', 'D35', 'D42'];
                
                // Generate QR code as data URL
                const qrData = JSON.stringify({
                    id: patientId,
                    n: patient.patientName,
                    hc: patient.healthCentre,
                    d: patient.screeningDate
                });
                
                // Create temporary QR canvas
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                document.body.appendChild(tempDiv);
                
                new QRCode(tempDiv, {
                    text: qrData,
                    width: 150,
                    height: 150,
                    colorDark: '#004080',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                // Wait for QR code to render
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const qrCanvas = tempDiv.querySelector('canvas');
                const qrDataUrl = qrCanvas ? qrCanvas.toDataURL('image/png') : null;
                
                document.body.removeChild(tempDiv);
                
                // Draw 10 vouchers (2 columns x 5 rows)
                for (let i = 0; i < 10; i++) {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    
                    const x = margin + col * (voucherWidth + margin);
                    const y = margin + row * (voucherHeight + margin);
                    
                    // Draw voucher background
                    pdf.setFillColor(0, 64, 128);
                    pdf.roundedRect(x, y, voucherWidth, voucherHeight, 3, 3, 'F');
                    
                    // Draw white QR section on right
                    const qrSectionWidth = 25;
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(x + voucherWidth - qrSectionWidth - 2, y + 2, qrSectionWidth, voucherHeight - 4, 2, 2, 'F');
                    
                    // Add text content
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TES 2026 - SIERRA LEONE', x + 5, y + 8);
                    
                    // Patient ID box
                    pdf.setFillColor(255, 255, 255, 0.2);
                    pdf.setFontSize(9);
                    const shortId = patientId.length > 18 ? patientId.substring(0, 18) + '...' : patientId;
                    pdf.text(shortId, x + 5, y + 18);
                    
                    // Patient info
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Name: ${patient.patientName || '---'}`, x + 5, y + 26);
                    pdf.text(`Age: ${patient.ageDisplay || (patient.ageInMonths + ' months') || '---'}`, x + 5, y + 31);
                    pdf.text(`HC: ${(patient.healthCentre || '---').substring(0, 25)}`, x + 5, y + 36);
                    
                    // Follow-up days
                    pdf.setFontSize(6);
                    pdf.text('Follow-up: ' + followUpDays.join(' '), x + 5, y + 43);
                    
                    // Add QR code
                    if (qrDataUrl) {
                        const qrSize = 18;
                        const qrX = x + voucherWidth - qrSectionWidth + 1;
                        const qrY = y + (voucherHeight - qrSize) / 2 - 3;
                        pdf.addImage(qrDataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
                    }
                    
                    // QR label
                    pdf.setTextColor(0, 64, 128);
                    pdf.setFontSize(5);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('SCAN', x + voucherWidth - qrSectionWidth + 7, y + voucherHeight - 6);
                }
                
                // Add footer
                pdf.setTextColor(100, 100, 100);
                pdf.setFontSize(6);
                pdf.text(`Generated: ${new Date().toLocaleString()} | Patient: ${patientId}`, margin, pageHeight - 5);
                
                // Save PDF
                pdf.save(`TES_Vouchers_${patientId}_${Date.now()}.pdf`);
                
                showNotification('PDF downloaded successfully with 10 vouchers!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            }
        }

        function printVouchers() {
            const printContent = document.getElementById('vouchersGrid').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>TES Patient Vouchers</title>
                    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Oswald', Arial, sans-serif; padding: 10mm; }
                        .vouchers-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 5mm;
                        }
                        .voucher-card {
                            background: linear-gradient(135deg, #004080 0%, #0056b3 100%);
                            border-radius: 8px;
                            overflow: hidden;
                            display: grid;
                            grid-template-columns: 1fr 80px;
                            min-height: 45mm;
                            page-break-inside: avoid;
                        }
                        .voucher-card-main { padding: 3mm 4mm; color: #ffffff; display: flex; flex-direction: column; justify-content: space-between; }
                        .voucher-card-header { display: flex; align-items: center; gap: 2mm; margin-bottom: 2mm; }
                        .voucher-card-logo { width: 10mm; height: 10mm; background: #ffffff; border-radius: 2mm; padding: 1mm; }
                        .voucher-card-logo img { width: 100%; height: 100%; object-fit: contain; }
                        .voucher-card-study { font-size: 7pt; opacity: 0.9; line-height: 1.2; }
                        .voucher-card-patient-id { font-size: 10pt; font-weight: 700; background: rgba(255,255,255,0.2); padding: 1mm 2mm; border-radius: 1mm; margin: 1mm 0; display: inline-block; }
                        .voucher-card-info { font-size: 7pt; line-height: 1.4; }
                        .voucher-card-info-row { display: flex; gap: 1mm; }
                        .voucher-card-info-label { opacity: 0.8; }
                        .voucher-card-schedule { margin-top: 1mm; padding-top: 1mm; border-top: 0.5px dashed rgba(255,255,255,0.3); }
                        .voucher-card-schedule-title { font-size: 6pt; opacity: 0.8; margin-bottom: 1mm; }
                        .voucher-card-days { display: flex; flex-wrap: wrap; gap: 1mm; }
                        .voucher-card-day { font-size: 6pt; background: rgba(255,255,255,0.2); padding: 0.5mm 1mm; border-radius: 1mm; }
                        .voucher-card-qr-section { background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2mm; }
                        .voucher-card-qr { width: 15mm; height: 15mm; }
                        .voucher-card-qr canvas, .voucher-card-qr img { width: 15mm !important; height: 15mm !important; }
                        .voucher-card-qr-label { font-size: 6pt; color: #004080; margin-top: 1mm; text-transform: uppercase; font-weight: 700; }
                        @media print {
                            body { padding: 5mm; }
                            .vouchers-grid { gap: 3mm; }
                        }
                    </style>
                </head>
                <body>
                    <div class="vouchers-grid">
                        ${printContent}
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(function() {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };
        }

        // ============================================
        // QR SCANNER FUNCTIONS
        // ============================================
        function openScannerModal() {
            document.getElementById('scannerModal').classList.add('show');
            startQRScanner();
        }

        function closeScannerModal() {
            document.getElementById('scannerModal').classList.remove('show');
            stopQRScanner();
        }

        function startQRScanner() {
            if (state.qrScanner) {
                state.qrScanner.clear();
            }
            
            state.qrScanner = new Html5Qrcode("qr-reader");
            
            state.qrScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    handleQRCodeScanned(decodedText);
                },
                (errorMessage) => {
                    // Ignore scan errors
                }
            ).catch(err => {
                console.error('Scanner error:', err);
                showNotification('Camera access denied or not available', 'error');
            });
        }

        function stopQRScanner() {
            if (state.qrScanner) {
                state.qrScanner.stop().then(() => {
                    state.qrScanner.clear();
                }).catch(err => {
                    console.error('Stop scanner error:', err);
                });
            }
        }

        function handleQRCodeScanned(decodedText) {
            stopQRScanner();
            closeScannerModal();
            
            try {
                const data = JSON.parse(decodedText);
                const patientId = data.id;
                
                if (!patientId) {
                    showNotification('Invalid QR code format', 'error');
                    return;
                }
                
                // Check if patient exists
                if (!state.patients[patientId]) {
                    showNotification('Patient not found in local database', 'error');
                    return;
                }
                
                selectPatientForFollowup(patientId);
                
            } catch (e) {
                // Try as plain patient ID
                const plainId = decodedText.trim();
                if (state.patients[plainId]) {
                    selectPatientForFollowup(plainId);
                } else {
                    // Try to find by partial match
                    const matchedId = Object.keys(state.patients).find(id => 
                        id.includes(plainId) || plainId.includes(id)
                    );
                    if (matchedId) {
                        selectPatientForFollowup(matchedId);
                    } else {
                        showNotification('Patient not found. Please check the QR code.', 'error');
                    }
                }
            }
        }

        // ============================================
        // FOLLOW-UP FUNCTIONS
        // ============================================
        async function selectPatientForFollowup(patientId) {
            // First check local storage
            let patient = state.patients[patientId];
            
            // If not in local storage and online, verify in Google Sheets
            if (!patient && state.isOnline) {
                showNotification('Verifying patient in database...', 'info');
                try {
                    const verified = await verifyPatientInGoogleSheets(patientId);
                    if (verified) {
                        patient = verified;
                        state.patients[patientId] = patient;
                        saveToLocalStorage();
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                }
            }
            
            if (!patient) {
                showNotification('Patient not found in local database or Google Sheets. Please ensure patient was screened first.', 'error');
                return;
            }
            
            state.selectedPatientId = patientId;
            state.currentMode = 'followup';
            
            document.getElementById('enrollmentModeBtn').classList.remove('active');
            document.getElementById('followupModeBtn').classList.add('active');
            
            // Show day selector
            document.getElementById('selectedPatientId').textContent = `${patientId} (${patient.patientName})`;
            updateDayButtons(patient);
            document.getElementById('daySelector').classList.add('show');
            document.getElementById('formCard').style.display = 'none';
            
            showNotification(`Patient ${patient.patientName} selected`, 'success');
        }
        
        async function verifyPatientInGoogleSheets(patientId) {
            try {
                const url = `${CONFIG.SCRIPT_URL}?action=verifyPatient&patientId=${encodeURIComponent(patientId)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.patient) {
                    return {
                        patientId: result.patient.patient_id,
                        patientName: result.patient.patient_name,
                        healthCentre: result.patient.health_centre_name,
                        district: result.patient.district,
                        screeningDate: result.patient.screening_date,
                        dateOfBirth: result.patient.date_of_birth,
                        ageInMonths: result.patient.age_in_months,
                        ageDisplay: result.patient.age_display,
                        sex: result.patient.sex,
                        completedDays: result.patient.completed_days || [],
                        isEligible: result.patient.is_eligible === 'Yes'
                    };
                }
                return null;
            } catch (error) {
                console.error('Error verifying patient:', error);
                return null;
            }
        }

        function updateDayButtons(patient) {
            const container = document.getElementById('dayButtons');
            const completedDays = patient.completedDays || [];
            
            let html = '';
            CONFIG.FOLLOW_UP_DAYS.forEach((day, index) => {
                const isCompleted = completedDays.includes(day);
                
                // Day 0 is always available if not completed
                // Other days require previous day to be completed
                let isLocked = false;
                if (day !== 0 && index > 0) {
                    const previousDay = CONFIG.FOLLOW_UP_DAYS[index - 1];
                    const isPreviousCompleted = completedDays.includes(previousDay);
                    isLocked = !isPreviousCompleted;
                }
                
                let className = 'day-btn';
                let disabled = '';
                
                if (isCompleted) {
                    className += ' completed';
                    disabled = 'disabled';
                } else if (isLocked) {
                    className += ' locked';
                    disabled = 'disabled';
                }
                
                html += `<button type="button" class="${className}" ${disabled} onclick="selectDay(${day})">Day ${day}</button>`;
            });
            
            container.innerHTML = html;
        }

        function selectDay(day) {
            const patientId = state.selectedPatientId;
            if (!patientId) {
                showNotification('Please select a patient first', 'error');
                return;
            }
            
            const patient = state.patients[patientId];
            const completedDays = patient.completedDays || [];
            
            // Check if already completed
            if (completedDays.includes(day)) {
                showNotification(`Day ${day} already completed for this patient`, 'warning');
                return;
            }
            
            // Check if previous day is completed (except for Day 0)
            const dayIndex = CONFIG.FOLLOW_UP_DAYS.indexOf(day);
            if (day !== 0 && dayIndex > 0) {
                const previousDay = CONFIG.FOLLOW_UP_DAYS[dayIndex - 1];
                if (!completedDays.includes(previousDay)) {
                    showNotification(`Please complete Day ${previousDay} first`, 'error');
                    return;
                }
            }
            
            state.selectedDay = day;
            document.getElementById('patient_id').value = patientId;
            document.getElementById('follow_up_day').value = day;
            document.getElementById('form_type').value = 'followup';
            
            // Generate follow-up form
            generateFormSections(FOLLOWUP_SECTIONS);
            
            // Pre-fill patient info
            document.getElementById('formCard').style.display = 'block';
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            showNotification(`Day ${day} follow-up form ready`, 'info');
        }

        // ============================================
        // PATIENTS MODAL
        // ============================================
        function openPatientsModal() {
            const modal = document.getElementById('patientsModal');
            const body = document.getElementById('patientsModalBody');
            
            const patientsList = Object.values(state.patients);
            
            if (patientsList.length === 0) {
                body.innerHTML = '<div class="no-patients">No patients screened yet</div>';
            } else {
                let html = '';
                patientsList.forEach(patient => {
                    const completedDays = patient.completedDays || [0];
                    const allCompleted = completedDays.length === CONFIG.FOLLOW_UP_DAYS.length;
                    
                    html += `
                        <div class="patient-card">
                            <div class="patient-card-header">
                                <span class="patient-id">${patient.patientId}</span>
                                <span class="patient-status ${allCompleted ? 'completed' : 'active'}">
                                    ${allCompleted ? 'COMPLETED' : 'ACTIVE'}
                                </span>
                            </div>
                            <div class="patient-info-grid">
                                <div class="patient-info-item">
                                    <span class="patient-info-label">NAME</span>
                                    <span class="patient-info-value">${patient.patientName || '---'}</span>
                                </div>
                                <div class="patient-info-item">
                                    <span class="patient-info-label">DOB</span>
                                    <span class="patient-info-value">${patient.dateOfBirth || '---'}</span>
                                </div>
                                <div class="patient-info-item">
                                    <span class="patient-info-label">AGE</span>
                                    <span class="patient-info-value">${patient.ageDisplay || (patient.ageInMonths ? patient.ageInMonths + ' months' : '---')}</span>
                                </div>
                                <div class="patient-info-item">
                                    <span class="patient-info-label">HEALTH CENTRE</span>
                                    <span class="patient-info-value">${patient.healthCentre || '---'}</span>
                                </div>
                                <div class="patient-info-item">
                                    <span class="patient-info-label">ENROLLED</span>
                                    <span class="patient-info-value">${patient.screeningDate || '---'}</span>
                                </div>
                            </div>
                            <div class="patient-days-progress">
                                ${CONFIG.FOLLOW_UP_DAYS.map(day => {
                                    const isCompleted = completedDays.includes(day);
                                    const dayIndex = CONFIG.FOLLOW_UP_DAYS.indexOf(day);
                                    const previousDay = dayIndex > 0 ? CONFIG.FOLLOW_UP_DAYS[dayIndex - 1] : null;
                                    const isPreviousCompleted = previousDay === null || completedDays.includes(previousDay);
                                    const isPending = !isCompleted && isPreviousCompleted;
                                    
                                    return `<span class="day-badge ${isCompleted ? 'completed' : isPending ? 'pending' : 'locked'}">
                                        D${day}${isCompleted ? 'âœ“' : ''}
                                    </span>`;
                                }).join('')}
                            </div>
                            <div class="patient-actions">
                                <button class="patient-action-btn followup" onclick="closePatientsModal(); selectPatientForFollowup('${patient.patientId}')">
                                    ðŸ“… FOLLOW-UP
                                </button>
                                <button class="patient-action-btn voucher" onclick="showVoucherFromList('${patient.patientId}')">
                                    ðŸŽ« VOUCHER
                                </button>
                            </div>
                        </div>
                    `;
                });
                body.innerHTML = html;
            }
            
            modal.classList.add('show');
        }

        function closePatientsModal() {
            document.getElementById('patientsModal').classList.remove('show');
        }

        function showVoucherFromList(patientId) {
            closePatientsModal();
            const patient = state.patients[patientId];
            if (patient) {
                showVoucher(patientId, patient);
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function updateOnlineStatus() {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (state.isOnline) {
                indicator.className = 'status-indicator online';
                text.textContent = 'ONLINE';
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = 'OFFLINE';
            }
        }

        function updateCounts() {
            document.getElementById('pendingCount').textContent = state.pendingSubmissions.length;
            document.getElementById('enrolledCount').textContent = Object.keys(state.patients).length;
            document.getElementById('patientCountBadge').textContent = Object.keys(state.patients).length;
        }

        function handleOnlineEvent() {
            state.isOnline = true;
            updateOnlineStatus();
            showNotification('Back online - Syncing data...', 'info');
            syncPendingSubmissions();
        }

        function handleOfflineEvent() {
            state.isOnline = false;
            updateOnlineStatus();
            showNotification('You are offline - Data will be saved locally', 'info');
        }

        function handleViewData() {
            if (CONFIG.GOOGLE_SHEET_URL && CONFIG.GOOGLE_SHEET_URL !== 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit') {
                window.open(CONFIG.GOOGLE_SHEET_URL, '_blank');
            } else {
                showNotification('Please configure Google Sheet URL', 'warning');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            notification.className = `notification ${type} show`;
            text.textContent = message;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ============================================
        // SIGNATURE PAD FUNCTIONS
        // ============================================
        function initializeSignaturePads() {
            const canvases = document.querySelectorAll('.signature-canvas');
            
            canvases.forEach(canvas => {
                const fieldName = canvas.getAttribute('data-field');
                
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth - 20;
                canvas.height = 120;
                
                const signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3
                });
                
                state.signaturePads[fieldName] = signaturePad;
                
                signaturePad.addEventListener('endStroke', () => {
                    const hiddenInput = document.getElementById(fieldName);
                    if (hiddenInput) {
                        hiddenInput.value = signaturePad.toDataURL();
                    }
                });
            });
        }

        function clearSignature(fieldName) {
            const signaturePad = state.signaturePads[fieldName];
            if (signaturePad) {
                signaturePad.clear();
                const hiddenInput = document.getElementById(fieldName);
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
            }
        }

        // ============================================
        // AGE CALCULATION FUNCTIONS
        // ============================================
        function calculateAge() {
            const dobInput = document.getElementById('date_of_birth');
            const ageInYearsInput = document.getElementById('age_in_years');
            const ageInMonthsInput = document.getElementById('age_in_months');
            const ageDisplayInput = document.getElementById('age_display');
            
            if (!dobInput || !dobInput.value) {
                if (ageInYearsInput) ageInYearsInput.value = '';
                if (ageInMonthsInput) ageInMonthsInput.value = '';
                if (ageDisplayInput) ageDisplayInput.value = '';
                return;
            }
            
            const dob = new Date(dobInput.value);
            const today = new Date();
            
            // Calculate total months
            let totalMonths = (today.getFullYear() - dob.getFullYear()) * 12;
            totalMonths += today.getMonth() - dob.getMonth();
            
            // Adjust if day of month hasn't occurred yet
            if (today.getDate() < dob.getDate()) {
                totalMonths--;
            }
            
            // Calculate years and remaining months
            const years = Math.floor(totalMonths / 12);
            const remainingMonths = totalMonths % 12;
            
            // Calculate days for more precision
            let ageYears = today.getFullYear() - dob.getFullYear();
            let ageMonths = today.getMonth() - dob.getMonth();
            let ageDays = today.getDate() - dob.getDate();
            
            if (ageDays < 0) {
                ageMonths--;
                // Get days in previous month
                const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                ageDays += prevMonth.getDate();
            }
            
            if (ageMonths < 0) {
                ageYears--;
                ageMonths += 12;
            }
            
            // Set values
            if (ageInYearsInput) {
                ageInYearsInput.value = ageYears;
                ageInYearsInput.classList.add('prefilled');
            }
            
            if (ageInMonthsInput) {
                ageInMonthsInput.value = totalMonths;
                ageInMonthsInput.classList.add('prefilled');
            }
            
            if (ageDisplayInput) {
                let displayText = '';
                if (ageYears > 0) {
                    displayText = `${ageYears} year${ageYears !== 1 ? 's' : ''}`;
                    if (ageMonths > 0) {
                        displayText += `, ${ageMonths} month${ageMonths !== 1 ? 's' : ''}`;
                    }
                } else {
                    displayText = `${ageMonths} month${ageMonths !== 1 ? 's' : ''}`;
                    if (ageDays > 0 && ageMonths < 2) {
                        displayText += `, ${ageDays} day${ageDays !== 1 ? 's' : ''}`;
                    }
                }
                ageDisplayInput.value = displayText;
                ageDisplayInput.classList.add('prefilled');
            }
        }

        // ============================================
        // SKIP LOGIC - CONDITIONAL FIELDS
        // ============================================
        function toggleConditionalField(groupName, show) {
            const fields = document.querySelectorAll(`[data-group="${groupName}"]`);
            fields.forEach(field => {
                if (show) {
                    field.style.display = 'block';
                    field.classList.add('conditional-show');
                } else {
                    field.style.display = 'none';
                    field.classList.remove('conditional-show');
                    // Clear the field value when hidden
                    const inputs = field.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                }
            });
        }

        // ============================================
        // AUTO-CALCULATE ELIGIBILITY CRITERIA
        // ============================================
        function evaluateCriteria() {
            if (state.currentMode !== 'screening') return;
            
            const criteria = {
                inclusion: {
                    age: { met: null, value: '--' },
                    mono: { met: null, value: '--' },
                    parasitaemia: { met: null, value: '--' },
                    fever: { met: null, value: '--' },
                    weight: { met: null, value: '--' },
                    oral: { met: null, value: '--' },
                    comply: { met: null, value: '--' },
                    consent: { met: null, value: '--' }
                },
                exclusion: {
                    danger: { met: null, value: '--' },
                    mixed: { met: null, value: '--' },
                    malnutrition: { met: null, value: '--' },
                    febrile: { met: null, value: '--' },
                    chronic: { met: null, value: '--' },
                    meds: { met: null, value: '--' },
                    hypersensitivity: { met: null, value: '--' }
                }
            };
            
            // ===== INCLUSION CRITERIA =====
            
            // 1. Age 6-59 months
            const ageMonths = document.getElementById('age_in_months');
            if (ageMonths && ageMonths.value) {
                const age = parseInt(ageMonths.value);
                criteria.inclusion.age.met = (age >= 6 && age <= 59);
                criteria.inclusion.age.value = `${age} months`;
            }
            
            // 2. P. falciparum mono-infection
            const pfDetected = document.querySelector('input[name="species_pf"]:checked');
            const otherSpecies = document.querySelector('input[name="other_species_present"]:checked');
            if (pfDetected && otherSpecies) {
                const isPfMono = (pfDetected.value === 'Yes' && otherSpecies.value === 'No');
                criteria.inclusion.mono.met = isPfMono;
                criteria.inclusion.mono.value = isPfMono ? 'Yes' : 'No';
                // Also update exclusion for mixed infection
                criteria.exclusion.mixed.met = (otherSpecies.value === 'No');
                criteria.exclusion.mixed.value = otherSpecies.value;
            }
            
            // 3. Parasitaemia 2,000 - 200,000/Âµl
            const parasiteCount = document.getElementById('asexual_parasite_count');
            if (parasiteCount && parasiteCount.value) {
                const count = parseFloat(parasiteCount.value);
                criteria.inclusion.parasitaemia.met = (count >= 2000 && count <= 200000);
                criteria.inclusion.parasitaemia.value = count.toLocaleString() + '/Âµl';
            }
            
            // 4. Fever â‰¥37.5Â°C or history
            const temperature = document.getElementById('temperature');
            const feverHistory = document.querySelector('input[name="fever_history_24h"]:checked');
            if (temperature && temperature.value) {
                const temp = parseFloat(temperature.value);
                const hasFeverHistory = feverHistory && feverHistory.value === 'Yes';
                const hasFever = temp >= 37.5 || hasFeverHistory;
                criteria.inclusion.fever.met = hasFever;
                criteria.inclusion.fever.value = `${temp}Â°C${hasFeverHistory ? ' + history' : ''}`;
            } else if (feverHistory && feverHistory.value === 'Yes') {
                criteria.inclusion.fever.met = true;
                criteria.inclusion.fever.value = 'History: Yes';
            }
            
            // 5. Weight â‰¥5 kg
            const weight = document.getElementById('weight_kg');
            if (weight && weight.value) {
                const w = parseFloat(weight.value);
                criteria.inclusion.weight.met = (w >= 5);
                criteria.inclusion.weight.value = `${w} kg`;
            }
            
            // 6. Can swallow oral medication
            const oralMeds = document.querySelector('input[name="ic_oral_meds"]:checked');
            if (oralMeds) {
                criteria.inclusion.oral.met = (oralMeds.value === 'Yes');
                criteria.inclusion.oral.value = oralMeds.value;
            }
            
            // 7. Willing to comply
            const comply = document.querySelector('input[name="ic_comply"]:checked');
            if (comply) {
                criteria.inclusion.comply.met = (comply.value === 'Yes');
                criteria.inclusion.comply.value = comply.value;
            }
            
            // 8. Informed consent
            const consent = document.querySelector('input[name="ic_consent"]:checked');
            if (consent) {
                criteria.inclusion.consent.met = (consent.value === 'Yes');
                criteria.inclusion.consent.value = consent.value;
            }
            
            // ===== EXCLUSION CRITERIA (must all be NO) =====
            
            // 1. Danger signs
            const dangerSigns = document.querySelector('input[name="ec_danger_signs"]:checked');
            if (dangerSigns) {
                criteria.exclusion.danger.met = (dangerSigns.value === 'No');
                criteria.exclusion.danger.value = dangerSigns.value;
            }
            
            // 2. Malnutrition
            const malnutrition = document.querySelector('input[name="ec_malnutrition"]:checked');
            if (malnutrition) {
                criteria.exclusion.malnutrition.met = (malnutrition.value === 'No');
                criteria.exclusion.malnutrition.value = malnutrition.value;
                // Toggle MUAC field
                toggleConditionalField('muac_group', malnutrition.value === 'Yes');
            }
            
            // 3. Other febrile conditions
            const otherFebrile = document.querySelector('input[name="ec_other_febrile"]:checked');
            if (otherFebrile) {
                criteria.exclusion.febrile.met = (otherFebrile.value === 'No');
                criteria.exclusion.febrile.value = otherFebrile.value;
            }
            
            // 4. Chronic diseases
            const chronicDisease = document.querySelector('input[name="ec_chronic_disease"]:checked');
            if (chronicDisease) {
                criteria.exclusion.chronic.met = (chronicDisease.value === 'No');
                criteria.exclusion.chronic.value = chronicDisease.value;
            }
            
            // 5. Interfering medications
            const interferingMeds = document.querySelector('input[name="ec_interfering_meds"]:checked');
            if (interferingMeds) {
                criteria.exclusion.meds.met = (interferingMeds.value === 'No');
                criteria.exclusion.meds.value = interferingMeds.value;
            }
            
            // 6. Hypersensitivity
            const hypersensitivity = document.querySelector('input[name="ec_hypersensitivity"]:checked');
            if (hypersensitivity) {
                criteria.exclusion.hypersensitivity.met = (hypersensitivity.value === 'No');
                criteria.exclusion.hypersensitivity.value = hypersensitivity.value;
            }
            
            // Update UI
            updateEligibilityUI(criteria);
        }
        
        function updateEligibilityUI(criteria) {
            // Update inclusion criteria items
            updateCriteriaItem('ic_age', criteria.inclusion.age);
            updateCriteriaItem('ic_mono', criteria.inclusion.mono);
            updateCriteriaItem('ic_parasitaemia', criteria.inclusion.parasitaemia);
            updateCriteriaItem('ic_fever', criteria.inclusion.fever);
            updateCriteriaItem('ic_weight', criteria.inclusion.weight);
            updateCriteriaItem('ic_oral', criteria.inclusion.oral);
            updateCriteriaItem('ic_comply', criteria.inclusion.comply);
            updateCriteriaItem('ic_consent', criteria.inclusion.consent);
            
            // Update exclusion criteria items
            updateCriteriaItem('ec_danger', criteria.exclusion.danger);
            updateCriteriaItem('ec_mixed', criteria.exclusion.mixed);
            updateCriteriaItem('ec_malnutrition', criteria.exclusion.malnutrition);
            updateCriteriaItem('ec_febrile', criteria.exclusion.febrile);
            updateCriteriaItem('ec_chronic', criteria.exclusion.chronic);
            updateCriteriaItem('ec_meds', criteria.exclusion.meds);
            updateCriteriaItem('ec_hypersensitivity', criteria.exclusion.hypersensitivity);
            
            // Calculate overall eligibility
            const allInclusionMet = Object.values(criteria.inclusion).every(c => c.met === true);
            const allExclusionClear = Object.values(criteria.exclusion).every(c => c.met === true);
            const anyInclusionNotMet = Object.values(criteria.inclusion).some(c => c.met === false);
            const anyExclusionFailed = Object.values(criteria.exclusion).some(c => c.met === false);
            const allChecked = 
                Object.values(criteria.inclusion).every(c => c.met !== null) &&
                Object.values(criteria.exclusion).every(c => c.met !== null);
            
            const resultDiv = document.getElementById('eligibility_result');
            const isEligibleInput = document.getElementById('is_eligible');
            const eligibilityReasonInput = document.getElementById('eligibility_reason');
            
            if (resultDiv) {
                if (anyInclusionNotMet || anyExclusionFailed) {
                    // Not eligible
                    let reasons = [];
                    if (anyInclusionNotMet) {
                        Object.entries(criteria.inclusion).forEach(([key, val]) => {
                            if (val.met === false) reasons.push(`Inclusion not met: ${key}`);
                        });
                    }
                    if (anyExclusionFailed) {
                        Object.entries(criteria.exclusion).forEach(([key, val]) => {
                            if (val.met === false) reasons.push(`Exclusion present: ${key}`);
                        });
                    }
                    resultDiv.innerHTML = `<div class="result-not-eligible">âŒ NOT ELIGIBLE FOR ENROLLMENT<br><small>${reasons.join(', ')}</small></div>`;
                    if (isEligibleInput) isEligibleInput.value = 'No';
                    if (eligibilityReasonInput) eligibilityReasonInput.value = reasons.join('; ');
                } else if (allInclusionMet && allExclusionClear) {
                    // Eligible
                    resultDiv.innerHTML = '<div class="result-eligible">âœ“ ELIGIBLE FOR ENROLLMENT</div>';
                    if (isEligibleInput) isEligibleInput.value = 'Yes';
                    if (eligibilityReasonInput) eligibilityReasonInput.value = 'All criteria met';
                } else {
                    // Still pending
                    resultDiv.innerHTML = '<div class="result-pending">â³ COMPLETE ALL SECTIONS TO DETERMINE ELIGIBILITY</div>';
                    if (isEligibleInput) isEligibleInput.value = '';
                    if (eligibilityReasonInput) eligibilityReasonInput.value = '';
                }
            }
        }
        
        function updateCriteriaItem(prefix, criteriaObj) {
            const statusEl = document.getElementById(`${prefix}_status`);
            const valueEl = document.getElementById(`${prefix}_value`);
            
            if (statusEl) {
                statusEl.classList.remove('met', 'not-met', 'pending');
                if (criteriaObj.met === true) {
                    statusEl.classList.add('met');
                } else if (criteriaObj.met === false) {
                    statusEl.classList.add('not-met');
                } else {
                    statusEl.classList.add('pending');
                }
            }
            
            if (valueEl) {
                valueEl.textContent = criteriaObj.value;
            }
        }

        // ============================================
        // GPS FUNCTIONS
        // ============================================
        function captureGPS() {
            const statusIcon = document.getElementById('gps_icon');
            const statusText = document.getElementById('gps_status');
            const coordsText = document.getElementById('gps_coords');
            const captureBtn = document.getElementById('gps_capture_btn');
            
            if (!navigator.geolocation) {
                showNotification('GPS not supported', 'error');
                return;
            }
            
            if (statusIcon) {
                statusIcon.classList.remove('success', 'error');
                statusIcon.classList.add('loading');
            }
            if (statusText) statusText.textContent = 'Capturing GPS...';
            if (captureBtn) {
                captureBtn.disabled = true;
                captureBtn.textContent = 'â³ CAPTURING...';
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    document.getElementById('gps_latitude').value = lat;
                    document.getElementById('gps_longitude').value = lon;
                    document.getElementById('gps_accuracy').value = accuracy;
                    
                    if (statusIcon) {
                        statusIcon.classList.remove('loading', 'error');
                        statusIcon.classList.add('success');
                    }
                    if (statusText) statusText.textContent = 'GPS captured!';
                    if (coordsText) coordsText.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)} (Â±${Math.round(accuracy)}m)`;
                    if (captureBtn) {
                        captureBtn.disabled = false;
                        captureBtn.textContent = 'âœ“ GPS CAPTURED';
                    }
                    
                    showNotification('GPS location captured', 'success');
                },
                (error) => {
                    if (statusIcon) {
                        statusIcon.classList.remove('loading', 'success');
                        statusIcon.classList.add('error');
                    }
                    if (statusText) statusText.textContent = 'GPS capture failed';
                    if (captureBtn) {
                        captureBtn.disabled = false;
                        captureBtn.textContent = 'ðŸ“ TRY AGAIN';
                    }
                    
                    showNotification('GPS capture failed', 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 60000,
                    maximumAge: 0
                }
            );
        }

        // Close modals on outside click
        document.getElementById('voucherModal').addEventListener('click', function(e) {
            if (e.target === this) closeVoucherModal();
        });

        document.getElementById('scannerModal').addEventListener('click', function(e) {
            if (e.target === this) closeScannerModal();
        });

        document.getElementById('patientsModal').addEventListener('click', function(e) {
            if (e.target === this) closePatientsModal();
        });

        // Initialize
        init();
    </script>
</body>
</html>
