<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TES Case Record Forms - Sierra Leone 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            margin: 0; padding: 20px;
            background-color: #ffffff;
            font-family: 'Oswald', Arial, sans-serif;
            color: #000000;
            font-weight: 700;
        }

        /* LOGIN */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-container { width: 100%; max-width: 650px; margin: 0 auto; }
        .login-header {
            background-color: #004080;
            color: #ffffff;
            padding: 25px 30px;
            text-align: center;
        }
        .login-header img { width: 140px; border-radius: 8px; }
        .login-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .login-header p { margin: 0; font-size: 10px; }
        .login-body {
            border: 4px double #004080;
            border-radius: 12px;
            padding: 12px;
            background-color: #ffffff;
            margin-top: 10px;
        }
        .login-content { padding: 35px; }
        .login-title { font-size: 17px; margin-bottom: 20px; text-align: center; }
        .login-subtitle { font-size: 16px; line-height: 1.8; margin-bottom: 30px; text-align: center; }
        .login-form-group { margin-bottom: 20px; }
        .login-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 14px; }
        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Oswald', Arial, sans-serif;
            font-weight: 700;
        }
        .login-input:focus { outline: none; border-color: #28a745; }
        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: #004080;
            color: #ffffff;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            font-family: 'Oswald', Arial, sans-serif;
        }
        .login-btn:hover { background: #0056b3; }
        .login-error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #dc3545;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .login-error.show { display: block; }
        .login-footer {
            background-color: #004080;
            color: #ffffff;
            padding: 20px 30px;
            text-align: center;
            font-size: 13px;
            line-height: 1.7;
            margin-top: 10px;
        }

        /* MAIN */
        .main-content { display: none; }
        .main-content.show { display: block; }
        .page-container { width: 100%; max-width: 750px; margin: 0 auto; }
        .page-header {
            background-color: #004080;
            color: #ffffff;
            padding: 25px 30px;
            text-align: center;
            margin-bottom: 10px;
        }
        .page-header img { width: 100px; border-radius: 8px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; letter-spacing: 1px; }
        .page-header .tagline { font-size: 10px; }
        .page-header h1 { margin: 20px 0 10px; font-size: 18px; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 13px; }

        /* CONTROLS */
        .controls-bar { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .control-btn {
            background: #004080;
            color: #ffffff;
            border: 2px solid #004080;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Oswald', Arial, sans-serif;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        .control-btn:hover { background: #0056b3; border-color: #0056b3; }
        .control-btn.scan-btn { background: #17a2b8; border-color: #17a2b8; }
        .control-btn.scan-btn:hover { background: #138496; border-color: #138496; }
        .control-btn.new-btn { background: #28a745; border-color: #28a745; }
        .control-btn.new-btn:hover { background: #218838; border-color: #218838; }
        .control-btn.view-data-btn { background: #6f42c1; border-color: #6f42c1; }
        .control-btn.view-data-btn:hover { background: #5a32a3; border-color: #5a32a3; }
        .control-btn.dashboard-btn { background: #fd7e14; border-color: #fd7e14; }
        .control-btn.dashboard-btn:hover { background: #e96b02; border-color: #e96b02; }
        .control-btn.dhis2-btn { background: #0d6efd; border-color: #0d6efd; }
        .control-btn.dhis2-btn:hover { background: #0b5ed7; border-color: #0b5ed7; }

        /* DHIS2 MODAL */
        .dhis2-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: flex-start;
            z-index: 3000; padding: 20px; overflow-y: auto;
        }
        .dhis2-modal.show { display: flex; }
        .dhis2-container {
            background: #ffffff;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            border: 4px double #0d6efd;
            margin: 20px auto;
        }
        .dhis2-header {
            background: #0d6efd;
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }
        .dhis2-title { font-size: 16px; }
        .dhis2-close { background: none; border: none; color: #ffffff; font-size: 24px; cursor: pointer; }
        .dhis2-content { padding: 20px; }
        .dhis2-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .dhis2-tab {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Oswald', Arial, sans-serif;
            border-radius: 6px 6px 0 0;
            margin-bottom: -2px;
        }
        .dhis2-tab.active { background: #0d6efd; color: #ffffff; }
        .dhis2-tab-content { display: none; }
        .dhis2-tab-content.active { display: block; }
        .dhis2-form-group { margin-bottom: 15px; }
        .dhis2-label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 13px; color: #004080; }
        .dhis2-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #0d6efd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Oswald', Arial, sans-serif;
        }
        .dhis2-input:focus { outline: none; border-color: #004080; }
        .dhis2-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            border: 2px solid;
            margin-right: 10px;
            margin-top: 10px;
        }
        .dhis2-btn.primary { background: #0d6efd; color: #ffffff; border-color: #0d6efd; }
        .dhis2-btn.primary:hover { background: #0b5ed7; }
        .dhis2-btn.success { background: #28a745; color: #ffffff; border-color: #28a745; }
        .dhis2-btn.success:hover { background: #218838; }
        .dhis2-btn.danger { background: #dc3545; color: #ffffff; border-color: #dc3545; }
        .dhis2-btn.danger:hover { background: #c82333; }
        .dhis2-btn.warning { background: #ffc107; color: #000000; border-color: #ffc107; }
        .dhis2-btn.warning:hover { background: #e0a800; }
        .dhis2-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .dhis2-status {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 13px;
        }
        .dhis2-status.info { background: #e7f3ff; border: 1px solid #0d6efd; color: #0d6efd; }
        .dhis2-status.success { background: #d4edda; border: 1px solid #28a745; color: #155724; }
        .dhis2-status.error { background: #f8d7da; border: 1px solid #dc3545; color: #721c24; }
        .dhis2-status.warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
        .dhis2-log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        .dhis2-log-entry { margin-bottom: 5px; }
        .dhis2-log-entry.error { color: #ff6b6b; }
        .dhis2-log-entry.success { color: #51cf66; }
        .dhis2-log-entry.info { color: #74c0fc; }
        .dhis2-checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
        .dhis2-checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
        .dhis2-checkbox-label input { width: 18px; height: 18px; cursor: pointer; }
        .dhis2-section { border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .dhis2-section-title { font-size: 14px; font-weight: 700; color: #0d6efd; margin-bottom: 12px; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; }
        .dhis2-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .dhis2-stat-card { background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #dee2e6; }
        .dhis2-stat-value { font-size: 24px; font-weight: 700; color: #0d6efd; }
        .dhis2-stat-label { font-size: 11px; color: #666; margin-top: 5px; }
        .dhis2-progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .dhis2-progress-bar { height: 100%; background: linear-gradient(90deg, #0d6efd, #28a745); transition: width 0.3s ease; }

        /* DASHBOARD MODAL */
        .dashboard-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 2000; padding: 10px;
        }
        .dashboard-modal.show { display: flex; }
        .dashboard-content {
            background: #ffffff;
            border-radius: 12px;
            width: 100%;
            max-width: 1400px;
            max-height: 95vh;
            overflow: hidden;
            border: 4px double #004080;
            display: flex;
            flex-direction: column;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #fd7e14, #e96b02);
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-title { font-size: 20px; letter-spacing: 1px; }
        .dashboard-close { background: none; border: none; color: #ffffff; font-size: 28px; cursor: pointer; }
        .dashboard-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #004080;
            flex-wrap: wrap;
        }
        .dashboard-tab {
            padding: 12px 20px;
            border: none;
            background: none;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        .dashboard-tab:hover { background: #e9ecef; }
        .dashboard-tab.active { color: #fd7e14; border-bottom-color: #fd7e14; background: #ffffff; }
        .dashboard-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            background: #f8f9fa;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .chart-card {
            background: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-card-title {
            font-size: 14px;
            color: #004080;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chart-card-value {
            font-size: 24px;
            font-weight: 700;
            color: #fd7e14;
        }
        .chart-container { position: relative; height: 250px; }
        .chart-container.small { height: 200px; }
        .chart-container.large { height: 350px; }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-card.primary { border-left: 4px solid #004080; }
        .summary-card.success { border-left: 4px solid #28a745; }
        .summary-card.warning { border-left: 4px solid #ffc107; }
        .summary-card.danger { border-left: 4px solid #dc3545; }
        .summary-card.info { border-left: 4px solid #17a2b8; }
        .summary-card.orange { border-left: 4px solid #fd7e14; }
        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #004080;
        }
        .summary-card-label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* Patient Details */
        .patient-detail-card {
            background: #ffffff;
            border: 2px solid #004080;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .patient-detail-header {
            background: #004080;
            color: #ffffff;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .patient-detail-header:hover { background: #0056b3; }
        .patient-detail-name { font-size: 14px; }
        .patient-detail-id { font-size: 11px; opacity: 0.8; }
        .patient-detail-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        .patient-detail-status.active { background: #28a745; }
        .patient-detail-status.completed { background: #17a2b8; }
        .patient-detail-body {
            display: none;
            padding: 15px;
        }
        .patient-detail-body.show { display: block; }
        .patient-info-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .patient-info-item-sm {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .patient-info-item-sm .label { font-size: 9px; color: #666; }
        .patient-info-item-sm .value { font-size: 13px; font-weight: 700; color: #004080; }
        .day-timeline {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .day-timeline-item {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        .day-timeline-item:hover { transform: scale(1.05); }
        .day-timeline-item.completed { background: #28a745; color: #ffffff; border-color: #28a745; }
        .day-timeline-item.pending { background: #ffc107; color: #000; border-color: #ffc107; }
        .day-timeline-item.locked { background: #e9ecef; color: #999; border-color: #dee2e6; }
        .day-timeline-item.selected { box-shadow: 0 0 0 3px rgba(0,64,128,0.5); }
        .day-detail-panel {
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            border: 2px solid #004080;
            display: none;
        }
        .day-detail-panel.show { display: block; }
        .day-detail-title {
            font-size: 14px;
            color: #004080;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #004080;
        }
        .day-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .day-detail-item {
            background: #ffffff;
            padding: 8px 12px;
            border-radius: 4px;
        }
        .day-detail-item .label { font-size: 9px; color: #666; text-transform: uppercase; }
        .day-detail-item .value { font-size: 12px; font-weight: 700; }

        /* VIEW DATA MODAL */
        .view-data-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 2000; padding: 20px;
        }
        .view-data-modal.show { display: flex; }
        .view-data-content {
            background: #ffffff;
            border-radius: 12px;
            max-width: 95vw;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            border: 4px double #004080;
            display: flex;
            flex-direction: column;
        }
        .view-data-header {
            background: #6f42c1;
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .view-data-title { font-size: 18px; }
        .view-data-close { background: none; border: none; color: #ffffff; font-size: 24px; cursor: pointer; }
        .view-data-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #004080;
        }
        .view-data-tab {
            padding: 12px 20px;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        .view-data-tab:hover { background: #e9ecef; }
        .view-data-tab.active { color: #6f42c1; border-bottom-color: #6f42c1; background: #ffffff; }
        .view-data-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .view-data-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .view-data-error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        .data-table-container { overflow-x: auto; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }
        .data-table th {
            background: #004080;
            color: #ffffff;
            font-weight: 700;
            position: sticky;
            top: 0;
        }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e7f3ff; }
        .refresh-btn {
            background: #6f42c1;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            margin-bottom: 15px;
        }
        .refresh-btn:hover { background: #5a32a3; }
        .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }
        .data-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .data-stat {
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 6px;
            padding: 10px 15px;
        }
        .data-stat-label { font-size: 10px; color: #666; }
        .data-stat-value { font-size: 18px; font-weight: 700; color: #004080; }

        /* STATUS */
        .status-bar {
            background: #ffffff;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-item { display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .status-indicator.online { background: #28a745; }
        .status-indicator.offline { background: #dc3545; }
        .status-text { font-weight: 700; font-size: 14px; }
        .pending-count, .patients-count {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #ffffff;
        }
        .pending-count { background: #004080; }
        .patients-count { background: #28a745; }

        /* DAY SELECTOR */
        .day-selector {
            background: #e7f3ff;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            display: none;
        }
        .day-selector.show { display: block; }
        .day-selector-title { font-size: 14px; color: #004080; margin-bottom: 15px; }
        .day-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
        .day-btn {
            padding: 10px 15px;
            border: 2px solid #004080;
            border-radius: 6px;
            background: #ffffff;
            color: #004080;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            min-width: 60px;
            text-align: center;
        }
        .day-btn:hover:not(:disabled) { background: #004080; color: #ffffff; }
        .day-btn.active { background: #004080; color: #ffffff; }
        .day-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #e9ecef; }
        .day-btn.completed { background: #28a745; border-color: #28a745; color: #ffffff; }
        .day-btn.locked { background: #dc3545; border-color: #dc3545; color: #ffffff; opacity: 0.6; }

        /* FORM CARD */
        .form-card {
            border: 4px double #004080;
            border-radius: 12px;
            padding: 12px;
            background-color: #ffffff;
            margin-bottom: 10px;
        }
        .form-content { padding: 25px; }

        /* PROGRESS */
        .progress-bar {
            background: #f8f9fa;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 2px solid #004080;
        }
        .progress-fill {
            background: linear-gradient(90deg, #004080, #0056b3);
            height: 100%;
            transition: width 0.3s ease;
        }
        .progress-text { text-align: center; font-size: 12px; margin-bottom: 25px; }

        /* SECTION */
        .form-section { display: none; }
        .form-section.active { display: block; }
        .section-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #004080; }
        .section-title { font-size: 16px; color: #004080; margin-bottom: 5px; }
        .section-description { font-size: 12px; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 20px; width: 100%; }
        .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 200px; }
        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .form-label .required { color: #dc3545; }
        .form-label .eligibility-note { color: #dc3545; font-size: 11px; display: block; margin-top: 4px; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Oswald', Arial, sans-serif;
            font-weight: 700;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #004080; }
        .form-input:disabled, .form-select:disabled { opacity: 0.7; cursor: not-allowed; background: #e9ecef; }
        .form-textarea { resize: vertical; min-height: 80px; }

        /* CHECKBOX/RADIO */
        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .checkbox-group.vertical, .radio-group.vertical { flex-direction: column; gap: 8px; }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input, .radio-item input { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label, .radio-item label { font-size: 13px; font-weight: 700; cursor: pointer; }

        /* CRITERIA BOX */
        .criteria-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .criteria-box.inclusion { background: #d4edda; border-color: #28a745; }
        .criteria-box.exclusion { background: #f8d7da; border-color: #dc3545; }
        .criteria-title { font-size: 14px; margin-bottom: 10px; }
        .criteria-list { list-style: none; padding: 0; }
        .criteria-list li { font-size: 12px; margin-bottom: 6px; padding-left: 20px; position: relative; }

        /* ELIGIBILITY SUMMARY */
        .eligibility-summary {
            background: #f8f9fa;
            border: 3px solid #004080;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .eligibility-summary.eligible { border-color: #28a745; background: #d4edda; }
        .eligibility-summary.not-eligible { border-color: #dc3545; background: #f8d7da; }
        .eligibility-result {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
        }
        .eligibility-result.eligible { background: #28a745; color: #ffffff; }
        .eligibility-result.not-eligible { background: #dc3545; color: #ffffff; }
        .eligibility-result.pending { background: #ffc107; color: #000000; }
        .criteria-summary-section {
            margin-bottom: 15px;
        }
        .criteria-summary-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .criteria-summary-title.inclusion { background: #28a745; color: #ffffff; }
        .criteria-summary-title.exclusion { background: #dc3545; color: #ffffff; }
        .criteria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            background: #ffffff;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #dee2e6;
            gap: 8px;
        }
        .criteria-item span:first-child { flex: 2; }
        .criteria-value { flex: 1; font-size: 11px; color: #666; text-align: center; font-style: italic; }
        .criteria-item.met { border-left-color: #28a745; }
        .criteria-item.not-met { border-left-color: #dc3545; }
        .criteria-item.pending { border-left-color: #ffc107; }
        .criteria-status {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }
        .criteria-status.yes { background: #28a745; color: #ffffff; }
        .criteria-status.no { background: #dc3545; color: #ffffff; }
        .criteria-status.pending { background: #ffc107; color: #000000; }
        .eligibility-note-box {
            margin-top: 15px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 6px;
            font-size: 11px;
            color: #004080;
        }
        .criteria-list li::before { content: "â€¢"; position: absolute; left: 5px; color: #004080; }

        /* CONSENT INFO BOX */
        .consent-info-box {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
            border: 2px solid #004080;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        .consent-info-box h4 {
            color: #004080;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #004080;
            padding-bottom: 10px;
        }
        .consent-info-box p {
            margin-bottom: 10px;
        }
        .consent-info-box strong {
            color: #004080;
        }
        .consent-info-box hr {
            border: none;
            border-top: 1px dashed #004080;
            margin: 15px 0;
        }

        /* SIGNATURE PAD */
        .signature-container {
            border: 2px solid #004080;
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
            width: 100%;
        }
        .signature-pad {
            width: 100%;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
            display: block;
            background: #fff;
        }
        .signature-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .signature-label {
            font-size: 11px;
            color: #666;
        }
        .signature-clear-btn {
            background: #dc3545;
            color: #ffffff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
        }
        .signature-clear-btn:hover {
            background: #c82333;
        }
        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            font-size: 14px;
            pointer-events: none;
            user-select: none;
        }
        .signature-wrapper {
            position: relative;
            width: 100%;
            background: #fff;
        }
        .signature-wrapper.has-signature .signature-placeholder {
            display: none;
        }
        .signature-input {
            display: none;
        }

        /* MEDICATION TABLE */
        .medication-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .medication-table th, .medication-table td { border: 1px solid #004080; padding: 8px; text-align: left; font-size: 12px; }
        .medication-table th { background: #004080; color: #ffffff; }
        .medication-table input, .medication-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: 'Oswald', Arial, sans-serif;
            font-size: 12px;
        }

        /* NAVIGATION */
        .navigation-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .btn-nav {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #004080;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-family: 'Oswald', Arial, sans-serif;
            min-width: 100px;
        }
        .btn-back { background: #ffffff; color: #004080; }
        .btn-back:hover { background: #004080; color: #ffffff; }
        .btn-next { background: #004080; color: #ffffff; }
        .btn-next:hover { background: #0056b3; border-color: #0056b3; }
        .btn-submit { background: #28a745; color: #ffffff; border-color: #28a745; }
        .btn-submit:hover:not(:disabled) { background: #218838; border-color: #218838; }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

        /* VOUCHER MODAL - 4 Vouchers on A4 (2x2 Grid) */
        .voucher-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none; justify-content: center; align-items: flex-start;
            z-index: 3000; padding: 20px; overflow-y: auto;
        }
        .voucher-modal.show { display: flex; }
        .voucher-container {
            background: #ffffff;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .voucher-header {
            background: linear-gradient(135deg, #004080 0%, #0066cc 100%);
            color: #ffffff;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .voucher-title { font-size: 16px; font-weight: 700; letter-spacing: 1px; }
        .voucher-close { background: none; border: none; color: #ffffff; font-size: 28px; cursor: pointer; }
        .voucher-close:hover { transform: scale(1.2); }
        .voucher-content { padding: 20px; background: #e9ecef; }
        
        /* A4 Page Container */
        .voucher-a4-page {
            background: #ffffff;
            width: 210mm;
            min-height: 297mm;
            padding: 8mm;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            box-sizing: border-box;
        }
        
        /* 2x2 Grid */
        .voucher-grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 6mm;
            height: calc(297mm - 16mm);
        }
        
        /* Individual Voucher Card */
        .voucher-card-mini {
            border: 2px solid #004080;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        /* Card Header */
        .voucher-mini-header {
            background: linear-gradient(135deg, #004080 0%, #0055aa 100%);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .voucher-mini-logo {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            border-radius: 6px;
            overflow: hidden;
        }
        .voucher-mini-logo svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .voucher-mini-title {
            color: #ffffff;
            font-size: 11px;
            font-weight: 700;
            line-height: 1.3;
            text-align: left;
        }
        .voucher-mini-title span {
            display: block;
            font-size: 8px;
            font-weight: 400;
            opacity: 0.9;
        }
        
        /* Patient ID Section */
        .voucher-mini-id {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            padding: 8px 12px;
            text-align: left;
        }
        .voucher-mini-id-label {
            font-size: 8px;
            color: #664d00;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .voucher-mini-id-value {
            font-size: 18px;
            font-weight: 700;
            color: #000000;
            letter-spacing: 2px;
        }
        
        /* Card Body - Info then QR below */
        .voucher-mini-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 12px;
        }
        
        /* Info Section */
        .voucher-mini-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        .voucher-mini-field {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            border-left: 3px solid #004080;
            text-align: left;
        }
        .voucher-mini-field.full-width {
            grid-column: 1 / -1;
        }
        .voucher-mini-field-label {
            font-size: 7px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
        }
        .voucher-mini-field-value {
            font-size: 11px;
            font-weight: 700;
            color: #004080;
            word-break: break-word;
            line-height: 1.3;
            text-align: left;
        }
        
        /* QR Section - Below info, centered but larger */
        .voucher-mini-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            border-top: 1px dashed #dee2e6;
            margin-top: auto;
        }
        .voucher-mini-qr-box {
            padding: 8px;
            background: #ffffff;
            border: 2px solid #004080;
            border-radius: 8px;
        }
        .voucher-mini-qr-box canvas {
            display: block;
        }
        .voucher-mini-qr-text {
            font-size: 7px;
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Card Footer */
        .voucher-mini-footer {
            background: #004080;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .voucher-mini-footer-text {
            font-size: 7px;
            color: rgba(255,255,255,0.8);
            text-align: left;
        }
        .voucher-mini-footer-days {
            font-size: 7px;
            color: #ffc107;
            font-weight: 600;
        }
        
        /* Voucher Buttons */
        .voucher-buttons { 
            display: flex; 
            gap: 12px; 
            margin-top: 20px;
            justify-content: center;
        }
        .voucher-btn {
            padding: 14px 30px; 
            border-radius: 10px;
            font-size: 13px; 
            font-weight: 700; 
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            text-transform: uppercase; 
            border: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .voucher-btn.pdf { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: #ffffff; 
        }
        .voucher-btn.pdf:hover { 
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }
        .voucher-btn.print { 
            background: linear-gradient(135deg, #28a745 0%, #218838 100%); 
            color: #ffffff; 
        }
        .voucher-btn.print:hover { 
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }
        .voucher-btn.close-btn { 
            background: #6c757d; 
            color: #ffffff; 
        }
        .voucher-btn.close-btn:hover { 
            background: #5a6268;
            transform: translateY(-3px);
        }
        
        @media print {
            body * { visibility: hidden; }
            .voucher-a4-page, .voucher-a4-page * { visibility: visible; }
            .voucher-a4-page { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 8mm;
                box-shadow: none;
            }
            .voucher-buttons, .voucher-header, .voucher-content { display: none !important; }
        }
        
        @media (max-width: 900px) {
            .voucher-a4-page {
                width: 100%;
                min-height: auto;
                padding: 15px;
            }
            .voucher-grid-2x2 {
                height: auto;
                gap: 15px;
            }
        }

        /* QR SCANNER */
        .scanner-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center;
            z-index: 3000; padding: 20px;
        }
        .scanner-modal.show { display: flex; }
        .scanner-container {
            background: #ffffff;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            border: 4px double #004080;
        }
        .scanner-header {
            background: #17a2b8;
            color: #ffffff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .scanner-title { font-size: 16px; }
        .scanner-close { background: none; border: none; color: #ffffff; font-size: 24px; cursor: pointer; }
        .scanner-body { padding: 20px; }
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; }
        .scanner-instructions { text-align: center; margin-top: 15px; font-size: 13px; color: #666; }

        /* PATIENTS MODAL */
        .patients-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 2000; padding: 20px;
        }
        .patients-modal.show { display: flex; }
        .patients-content {
            background: #ffffff;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 4px double #004080;
        }
        .patients-header {
            background: #004080;
            color: #ffffff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }
        .patients-title { font-size: 18px; }
        .patients-close { background: none; border: none; color: #ffffff; font-size: 24px; cursor: pointer; }
        .patients-body { padding: 20px; }
        .patient-card { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .patient-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .patient-id { font-weight: 700; color: #004080; font-size: 16px; }
        .patient-status { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .patient-status.active { background: #28a745; color: #ffffff; }
        .patient-status.completed { background: #17a2b8; color: #ffffff; }
        .patient-status.withdrawn { background: #dc3545; color: #ffffff; }
        .patient-card.withdrawn-card { border-color: #dc3545; background: #fff5f5; }
        .withdrawal-notice { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 8px 12px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            font-size: 12px;
            border-left: 4px solid #dc3545;
        }
        .day-badge.blocked { background: #dc3545; color: #ffffff; }
        .patient-action-btn.disabled { background: #6c757d; cursor: not-allowed; opacity: 0.6; }
        .patient-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 12px; }
        .patient-info-item { display: flex; flex-direction: column; }
        .patient-info-label { color: #666; font-size: 10px; }
        .patient-info-value { font-weight: 700; }
        .patient-days-progress { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .day-badge { padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: 700; }
        .day-badge.completed { background: #28a745; color: #ffffff; }
        .day-badge.pending { background: #ffc107; color: #000000; }
        .day-badge.locked { background: #e9ecef; color: #666; }
        .patient-actions { display: flex; gap: 10px; margin-top: 10px; }
        .patient-action-btn { padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; border: none; }
        .patient-action-btn.followup { background: #17a2b8; color: #ffffff; }
        .patient-action-btn.voucher { background: #004080; color: #ffffff; }
        .no-patients { text-align: center; color: #6c757d; padding: 40px; font-size: 14px; }

        /* FOOTER */
        .page-footer {
            background-color: #004080;
            color: #ffffff;
            padding: 20px 30px;
            text-align: center;
            font-size: 13px;
            line-height: 1.7;
        }

        /* MODE INDICATOR */
        .mode-indicator {
            background: #e7f3ff;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #004080;
        }
        .mode-indicator.screening { background: #e8f5e9; border-color: #28a745; color: #28a745; }
        .mode-indicator.followup { background: #e0f7fa; border-color: #17a2b8; color: #17a2b8; }
        .cancel-mode-btn {
            background: #dc3545;
            color: #ffffff;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
        }
        .cancel-mode-btn:hover { background: #c82333; }

        /* SCAN PANEL */
        .scan-panel {
            background: #e0f7fa;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 10px;
            text-align: center;
        }
        .scan-panel-title { font-size: 18px; color: #17a2b8; margin-bottom: 10px; }
        .scan-panel-desc { font-size: 13px; color: #666; margin-bottom: 20px; }
        .scan-voucher-btn {
            background: #17a2b8;
            color: #ffffff;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Oswald', Arial, sans-serif;
            letter-spacing: 1px;
        }
        .scan-voucher-btn:hover { background: #138496; }

        /* PATIENT INFO BAR */
        .patient-info-bar {
            background: #f8f9fa;
            border: 2px solid #004080;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
        }
        .patient-info-bar-title { font-size: 12px; color: #666; margin-bottom: 8px; }
        .patient-info-bar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .patient-info-bar-item { }
        .patient-info-bar-label { font-size: 10px; color: #666; }
        .patient-info-bar-value { font-size: 13px; font-weight: 700; color: #004080; }

        /* NOTIFICATION */
        .notification {
            position: fixed; top: 20px; right: 20px;
            background: #ffffff;
            border: 2px solid #004080;
            padding: 16px 20px;
            border-radius: 8px;
            display: none;
            z-index: 4000;
            max-width: 400px;
        }
        .notification.show { display: block; }
        .notification.success { border-left: 4px solid #28a745; }
        .notification.error { border-left: 4px solid #dc3545; }
        .notification.info { border-left: 4px solid #004080; }
        .notification.warning { border-left: 4px solid #ffc107; }
        .notification-text { font-size: 14px; }

        /* PRINT */
        @media print {
            body * { visibility: hidden; }
            .vouchers-grid, .vouchers-grid * { visibility: visible; }
            .vouchers-grid { position: absolute; left: 0; top: 0; width: 100%; }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .form-content { padding: 20px; }
            .controls-bar { flex-direction: column; }
            .control-btn { width: 100%; }
            .status-bar { flex-direction: column; }
            .form-row { flex-direction: column; }
            .form-row .form-group { min-width: 100%; }
            .navigation-buttons { flex-direction: column; }
            .btn-nav { width: 100%; }
            .vouchers-grid { grid-template-columns: 1fr; }
            .notification { left: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
                <p><em>Driving Data-Driven Solutions for Health and Development</em></p>
            </div>
            <div class="login-body">
                <div class="login-content">
                    <h2 class="login-title">TES CASE RECORD FORMS</h2>
                    <p class="login-subtitle">Therapeutic Efficacy Study<br>Sierra Leone 2026</p>
                    <div class="login-error" id="loginError">Invalid username or password</div>
                    <form id="loginForm">
                        <div class="login-form-group">
                            <label class="login-label">USERNAME</label>
                            <input type="text" class="login-input" id="username" required autocomplete="username">
                        </div>
                        <div class="login-form-group">
                            <label class="login-label">PASSWORD</label>
                            <input type="password" class="login-input" id="password" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="login-btn">LOGIN</button>
                    </form>
                </div>
            </div>
            <div class="login-footer">
                <p style="margin: 0;">Therapeutic Efficacy Study (TES) 2026</p>
                <p>Study Number: SL TES 2026</p>
                <p style="font-size: 11px;">National Malaria Control Programme - Sierra Leone</p>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="mainContent">
        <div class="page-container">
            <div class="page-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                <h3>Study Number: SL TES 2026</h3>
                <p class="tagline"><em>National Malaria Control Programme</em></p>
                <h1>TES CASE RECORD FORMS</h1>
                <p class="subtitle">Sierra Leone 2026</p>
            </div>

            <div class="controls-bar">
                <button class="control-btn new-btn" onclick="startNewScreening()">+ NEW SCREENING</button>
                <button class="control-btn scan-btn" onclick="startCaseReportForm()">ðŸ“± FOLLOW-UP (SCAN)</button>
                <button class="control-btn" onclick="openPatientsModal()">PATIENTS (<span id="patientCountBadge">0</span>)</button>
                <button class="control-btn view-data-btn" onclick="openViewDataModal()">VIEW DATA</button>
                <button class="control-btn dashboard-btn" onclick="openDashboard()">DASHBOARD</button>
                <button class="control-btn dhis2-btn" onclick="openDhis2Modal()">DHIS2 SYNC</button>
                <button class="control-btn" id="logoutBtn" onclick="handleLogout()">LOGOUT</button>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span class="status-text" id="statusText">CHECKING...</span>
                </div>
                <div class="status-item">
                    <span style="font-size: 12px;">ENROLLED:</span>
                    <span class="patients-count" id="screenedCount">0</span>
                </div>
                <div class="status-item">
                    <span style="font-size: 12px;">PENDING SYNC:</span>
                    <span class="pending-count" id="pendingCount">0</span>
                </div>
            </div>

            <!-- Current Mode Indicator -->
            <div class="mode-indicator" id="modeIndicator" style="display: none;">
                <span id="currentModeLabel"></span>
                <button class="cancel-mode-btn" onclick="cancelCurrentMode()">CANCEL</button>
            </div>

            <!-- Scan Voucher Panel (shown when Case Report Form selected) -->
            <div class="scan-panel" id="scanPanel" style="display: none;">
                <div class="scan-panel-title">ðŸ“± SCAN VOUCHER FOR FOLLOW-UP</div>
                <p class="scan-panel-desc">Patient must present their voucher. Scan the QR code to proceed with follow-up visit.</p>
                <button class="scan-voucher-btn" onclick="openScannerModal()">ðŸ“· SCAN VOUCHER QR CODE</button>
            </div>

            <div class="day-selector" id="daySelector">
                <div class="day-selector-title">SELECT FOLLOW-UP DAY FOR PATIENT: <span id="selectedPatientId">---</span></div>
                <div class="day-buttons" id="dayButtons"></div>
            </div>

            <!-- Patient Info Bar (shown during follow-up) -->
            <div class="patient-info-bar" id="patientInfoBar" style="display: none;">
                <div class="patient-info-bar-title">PATIENT INFORMATION</div>
                <div class="patient-info-bar-grid">
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">NAME</span>
                        <span class="patient-info-bar-value" id="infoPatientName">---</span>
                    </div>
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">ID</span>
                        <span class="patient-info-bar-value" id="infoPatientId">---</span>
                    </div>
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">AGE</span>
                        <span class="patient-info-bar-value" id="infoPatientAge">---</span>
                    </div>
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">SEX</span>
                        <span class="patient-info-bar-value" id="infoPatientSex">---</span>
                    </div>
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">WEIGHT</span>
                        <span class="patient-info-bar-value" id="infoPatientWeight">---</span>
                    </div>
                    <div class="patient-info-bar-item">
                        <span class="patient-info-bar-label">HEALTH CENTRE</span>
                        <span class="patient-info-bar-value" id="infoHealthCentre">---</span>
                    </div>
                </div>
            </div>

            <div class="form-card" id="formCard" style="display: none;">
                <div class="form-content">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">SECTION 1 OF 7</div>
                    <form id="dataForm">
                        <input type="hidden" name="form_type" id="form_type" value="screening">
                        <input type="hidden" name="patient_id" id="patient_id" value="">
                        <input type="hidden" name="follow_up_day" id="follow_up_day" value="-1">
                        <input type="hidden" name="study_number" value="SL TES 2026">
                        <div id="dynamicSections"></div>
                    </form>
                </div>
            </div>

            <div class="page-footer">
                <p style="margin: 0;">Therapeutic Efficacy Study (TES) 2026</p>
                <p>National Malaria Control Programme - Sierra Leone</p>
                <p style="font-size: 10px;">Â© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            </div>
        </div>
    </div>

    <!-- VOUCHER MODAL - 4 Vouchers on A4 (2x2 Grid) -->
    <div class="voucher-modal" id="voucherModal">
        <div class="voucher-container">
            <div class="voucher-header">
                <span class="voucher-title">ðŸŽ« PATIENT VOUCHERS (4 per page)</span>
                <button class="voucher-close" onclick="closeVoucherModal()">&times;</button>
            </div>
            <div class="voucher-content">
                <div class="voucher-a4-page" id="voucherA4Page">
                    <div class="voucher-grid-2x2" id="voucherGrid">
                        <!-- 4 voucher cards will be generated here -->
                    </div>
                </div>
                
                <div class="voucher-buttons">
                    <button class="voucher-btn pdf" onclick="downloadVoucherPDF()">ðŸ“„ DOWNLOAD PDF</button>
                    <button class="voucher-btn print" onclick="printVouchers()">ðŸ–¨ï¸ PRINT</button>
                    <button class="voucher-btn close-btn" onclick="closeVoucherModal()">âœ– CLOSE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR SCANNER MODAL -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-container">
            <div class="scanner-header">
                <span class="scanner-title">SCAN PATIENT VOUCHER</span>
                <button class="scanner-close" onclick="closeScannerModal()">&times;</button>
            </div>
            <div class="scanner-body">
                <div id="qr-reader"></div>
                <p class="scanner-instructions">Point camera at the QR code on patient voucher</p>
            </div>
        </div>
    </div>

    <!-- PATIENTS MODAL -->
    <div class="patients-modal" id="patientsModal">
        <div class="patients-content">
            <div class="patients-header">
                <span class="patients-title">ENROLLED PATIENTS</span>
                <button class="patients-close" onclick="closePatientsModal()">&times;</button>
            </div>
            <div class="patients-body" id="patientsModalBody"></div>
        </div>
    </div>

    <!-- VIEW DATA MODAL -->
    <div class="view-data-modal" id="viewDataModal">
        <div class="view-data-content">
            <div class="view-data-header">
                <span class="view-data-title">VIEW DATA FROM GOOGLE SHEETS</span>
                <button class="view-data-close" onclick="closeViewDataModal()">&times;</button>
            </div>
            <div class="view-data-tabs">
                <button class="view-data-tab active" onclick="switchDataTab('screening')">SCREENING</button>
                <button class="view-data-tab" onclick="switchDataTab('followup')">FOLLOW-UP</button>
                <button class="view-data-tab" onclick="switchDataTab('patients')">PATIENTS</button>
            </div>
            <div class="view-data-body" id="viewDataBody">
                <div class="view-data-loading">Click refresh to load data from Google Sheets</div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD MODAL -->
    <div class="dashboard-modal" id="dashboardModal">
        <div class="dashboard-content">
            <div class="dashboard-header">
                <span class="dashboard-title">TES STUDY DASHBOARD</span>
                <button class="dashboard-close" onclick="closeDashboard()">&times;</button>
            </div>
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" onclick="switchDashboardTab('overview')">OVERVIEW</button>
                <button class="dashboard-tab" onclick="switchDashboardTab('screening')">SCREENING ANALYSIS</button>
                <button class="dashboard-tab" onclick="switchDashboardTab('followup')">FOLLOW-UP ANALYSIS</button>
                <button class="dashboard-tab" onclick="switchDashboardTab('patients')">PATIENT DETAILS</button>
            </div>
            <div class="dashboard-body" id="dashboardBody">
                <div class="view-data-loading">Loading dashboard...</div>
            </div>
        </div>
    </div>

    <!-- DHIS2 INTEGRATION MODAL -->
    <div class="dhis2-modal" id="dhis2Modal">
        <div class="dhis2-container">
            <div class="dhis2-header">
                <span class="dhis2-title">ðŸ”— DHIS2 SYNC</span>
                <button class="dhis2-close" onclick="closeDhis2Modal()">&times;</button>
            </div>
            <div class="dhis2-content">
                
                <!-- USER VIEW - Simple Sync -->
                <div id="dhis2UserView">
                    <div class="dhis2-section">
                        <div class="dhis2-section-title">ðŸ“Š Data Ready to Sync</div>
                        <div class="dhis2-stats">
                            <div class="dhis2-stat-card">
                                <div class="dhis2-stat-value" id="syncScreeningCount">0</div>
                                <div class="dhis2-stat-label">Screening</div>
                            </div>
                            <div class="dhis2-stat-card">
                                <div class="dhis2-stat-value" id="syncFollowupCount">0</div>
                                <div class="dhis2-stat-label">Follow-ups</div>
                            </div>
                            <div class="dhis2-stat-card">
                                <div class="dhis2-stat-value" id="syncPatientsCount">0</div>
                                <div class="dhis2-stat-label">Patients</div>
                            </div>
                        </div>
                    </div>

                    <button class="dhis2-btn success" onclick="syncDataToDhis2()" id="syncBtn" style="width: 100%; padding: 18px; font-size: 18px; margin-top: 15px;">
                        ðŸš€ SYNC TO DHIS2
                    </button>

                    <div id="dhis2SyncResult" style="display: none; margin-top: 15px;"></div>
                    
                    <div class="dhis2-progress" id="dhis2SyncProgress" style="display: none; margin-top: 15px;">
                        <div class="dhis2-progress-bar" id="dhis2ProgressBar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- ADMIN VIEW -->
                <div id="dhis2AdminView" style="display: none;">
                    <div class="dhis2-status info" style="margin-bottom: 15px;">
                        <strong>Admin Mode:</strong> Setup DHIS2 metadata and manage sync
                    </div>

                    <div class="dhis2-section">
                        <div class="dhis2-section-title">ðŸ”§ Auto-Setup DHIS2</div>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                            This will automatically create in DHIS2:
                        </p>
                        <ul style="font-size: 12px; color: #333; margin-left: 20px; margin-bottom: 15px;">
                            <li>âœ… Tracker Program for case-based data</li>
                            <li>âœ… All TES data elements (screening, follow-up, outcomes)</li>
                            <li>âœ… Program stages for follow-up visits</li>
                            <li>âœ… Assign to all mapped health facilities</li>
                        </ul>
                        <button class="dhis2-btn success" onclick="autoSetupDhis2()" id="autoSetupBtn" style="width: 100%; padding: 15px;">
                            âš¡ AUTO-SETUP DHIS2 (One Click)
                        </button>
                    </div>

                    <div class="dhis2-section" style="margin-top: 15px;">
                        <div class="dhis2-section-title">ðŸŒ Connection Status</div>
                        <p style="font-size: 12px;"><strong>Server:</strong> <span id="adminServerUrl">-</span></p>
                        <p style="font-size: 12px;"><strong>User:</strong> <span id="adminUsername">-</span></p>
                        <p style="font-size: 12px;"><strong>Health Facilities Mapped:</strong> <span id="adminOrgCount">0</span></p>
                        <button class="dhis2-btn primary" onclick="testDhis2Connection()" style="margin-top: 10px;">TEST CONNECTION</button>
                        <div id="dhis2ConnectionStatus" style="margin-top: 10px;"></div>
                    </div>

                    <div class="dhis2-section" style="margin-top: 15px;">
                        <div class="dhis2-section-title">ðŸ“¤ Sync Data</div>
                        <div class="dhis2-stats">
                            <div class="dhis2-stat-card">
                                <div class="dhis2-stat-value" id="adminSyncScreening">0</div>
                                <div class="dhis2-stat-label">Screening</div>
                            </div>
                            <div class="dhis2-stat-card">
                                <div class="dhis2-stat-value" id="adminSyncFollowup">0</div>
                                <div class="dhis2-stat-label">Follow-ups</div>
                            </div>
                        </div>
                        <button class="dhis2-btn primary" onclick="syncDataToDhis2()" style="width: 100%; margin-top: 10px;">SYNC ALL DATA</button>
                    </div>

                    <div class="dhis2-log" id="dhis2SetupLog" style="display: none; margin-top: 15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification">
        <span class="notification-text" id="notificationText"></span>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec',
            LOGIN_USERNAME: 'tes',
            LOGIN_PASSWORD: 'tes2026',
            ADMIN_USERNAME: 'admin',
            ADMIN_PASSWORD: 'admin2026',
            STUDY_NUMBER: 'SL TES 2026',
            // Medicine types with their follow-up schedules
            MEDICINES: {
                'AL': {
                    name: 'Artemether-Lumefantrine (AL)',
                    shortName: 'AL',
                    followUpDays: [0, 1, 2, 3, 7, 14, 21, 28],
                    maxDay: 28
                },
                'DHAPQ': {
                    name: 'Dihydroartemisinin-Piperaquine (DHAPQ)',
                    shortName: 'DHAPQ',
                    followUpDays: [0, 1, 2, 3, 7, 14, 21, 28, 35, 42],
                    maxDay: 42
                }
            },
            FOLLOW_UP_DAYS: [0, 1, 2, 3, 7, 14, 21, 28, 35, 42], // Default (DHAPQ)
            
            // ========================================
            // DHIS2 CONFIGURATION - UPDATE THESE VALUES
            // ========================================
            DHIS2: {
                SERVER_URL: 'https://sl.dhis2.org',         // Your DHIS2 server URL
                USERNAME: 'tes_api_user',                    // DHIS2 API username
                PASSWORD: 'YourPassword123',                 // DHIS2 API password
                DATASET_CODE: 'TES_2026_SL',
                DATASET_NAME: 'TES 2026 - Therapeutic Efficacy Study',
                PROGRAM_CODE: 'TES_2026_TRACKER',            // For case-based/tracker
                
                // Health Facility Name -> DHIS2 Org Unit UID (Level 5)
                // UPDATE THESE WITH YOUR ACTUAL DHIS2 ORG UNIT UIDs
                ORG_UNITS: {
                    // Northern Province
                    'Kabala Government Hospital': 'xxxxxxx01',
                    'Makeni Government Hospital': 'xxxxxxx02',
                    'Magburaka Government Hospital': 'xxxxxxx03',
                    'Falaba District Hospital': 'xxxxxxx04',
                    // North West Province
                    'Port Loko Government Hospital': 'xxxxxxx05',
                    'Kambia Government Hospital': 'xxxxxxx06',
                    'Karene District Hospital': 'xxxxxxx07',
                    // Southern Province
                    'Bo Government Hospital': 'xxxxxxx08',
                    'Kenema Government Hospital': 'xxxxxxx09',
                    'Pujehun Government Hospital': 'xxxxxxx10',
                    'Moyamba Government Hospital': 'xxxxxxx11',
                    'Bonthe Government Hospital': 'xxxxxxx12',
                    // Eastern Province
                    'Kailahun Government Hospital': 'xxxxxxx13',
                    'Koidu Government Hospital': 'xxxxxxx14',
                    // Western Area
                    'Rokupa Government Hospital': 'xxxxxxx15',
                    'Connaught Hospital': 'xxxxxxx16',
                    'Ola During Children\'s Hospital': 'xxxxxxx17',
                    'Waterloo Community Health Centre': 'xxxxxxx18',
                    'Goderich Community Health Centre': 'xxxxxxx19'
                }
            },
            
            // CORS Proxies - Multiple proxies for DHIS2 connection fallback
            PROXIES: [
                { 
                    name: 'Direct',
                    url: '',
                    type: 'direct'  // Try direct connection first (works if DHIS2 has CORS enabled)
                },
                { 
                    name: 'GAS Proxy',
                    url: 'https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec',
                    type: 'gas'
                },
                {
                    name: 'CORS Proxy 1',
                    url: 'https://corsproxy.io/?',
                    type: 'cors'
                },
                {
                    name: 'CORS Proxy 2', 
                    url: 'https://api.allorigins.win/raw?url=',
                    type: 'cors'
                },
                {
                    name: 'CORS Proxy 3',
                    url: 'https://cors-anywhere.herokuapp.com/',
                    type: 'cors'
                }
            ]
        };

        // Cascading Location Data: Province -> District -> Health Facilities
        const LOCATION_DATA = {
            'Northern Province': {
                districts: {
                    'Koinadugu': ['Kabala Government Hospital'],
                    'Bombali': ['Makeni Government Hospital'],
                    'Tonkolili': ['Magburaka Government Hospital'],
                    'Falaba': ['Falaba District Hospital']
                }
            },
            'North West Province': {
                districts: {
                    'Port Loko': ['Port Loko Government Hospital'],
                    'Kambia': ['Kambia Government Hospital'],
                    'Karene': ['Karene District Hospital']
                }
            },
            'Southern Province': {
                districts: {
                    'Bo': ['Bo Government Hospital'],
                    'Bonthe': ['Bonthe Government Hospital'],
                    'Moyamba': ['Moyamba Government Hospital'],
                    'Pujehun': ['Pujehun Government Hospital']
                }
            },
            'Eastern Province': {
                districts: {
                    'Kenema': ['Kenema Government Hospital'],
                    'Kailahun': ['Kailahun Government Hospital'],
                    'Kono': ['Koidu Government Hospital']
                }
            },
            'Western Area': {
                districts: {
                    'Western Area Urban': ['Rokupa Government Hospital', 'Connaught Hospital', 'Ola During Children\'s Hospital'],
                    'Western Area Rural': ['Waterloo Community Health Centre', 'Goderich Community Health Centre']
                }
            }
        };

        // Helper functions for cascading dropdowns
        function getProvinces() {
            return Object.keys(LOCATION_DATA);
        }

        function getDistrictsByProvince(province) {
            if (!province || !LOCATION_DATA[province]) return [];
            return Object.keys(LOCATION_DATA[province].districts);
        }

        function getHealthFacilitiesByDistrict(province, district) {
            if (!province || !district || !LOCATION_DATA[province]) return [];
            return LOCATION_DATA[province].districts[district] || [];
        }

        // ============================================
        // STATE
        // ============================================
        const state = {
            pendingSubmissions: [],
            patients: {},
            submissions: {},
            isOnline: navigator.onLine,
            isLoggedIn: false,
            isAdmin: false,
            currentMode: null,
            currentSection: 1,
            totalSections: 0,
            selectedPatientId: null,
            selectedDay: -1,
            qrScanner: null
        };

        // ============================================
        // EXACT FORM SECTIONS FROM ORIGINAL DOCUMENT
        // ============================================
        
        // CONSENT FORM - Based on 2026 TES Consent for AL
        const CONSENT_SECTIONS = [
            {
                title: 'Informed Consent - Information Sheet',
                description: 'Study information for parents/caretakers of children aged 6 to 59 months',
                isInfoSection: true,
                infoContent: `
                    <div class="consent-info-box">
                        <h4>THERAPEUTIC EFFICACY STUDY (TES) 2026</h4>
                        <p><strong>Study:</strong> Efficacy and safety of artemether-lumefantrine for the treatment of uncomplicated Plasmodium falciparum malaria among children 6-59 months in Sierra Leone</p>
                        <p><strong>Sponsor:</strong> President's Malaria Initiative (PMI) / Ministry of Health</p>
                        <hr>
                        <p><strong>Purpose:</strong> We are doing a study to verify that the medicine artemether-lumefantrine is still effective for treating malaria.</p>
                        <p><strong>Participation:</strong> Your decision to have your child participate is entirely voluntary. Whether you choose to participate or not, all services your child receives will continue.</p>
                        <p><strong>Treatment:</strong> Your child will receive 6 doses of medicine over 3 days. The medicine is recommended by the Ministry of Health to treat malaria.</p>
                        <p><strong>Duration:</strong> The study will take place over 28-42 days with scheduled visits.</p>
                        <p><strong>Blood Tests:</strong> A small amount of blood (4-6 drops) will be taken from your child's fingertip. Blood samples will only be used to study malaria.</p>
                        <p><strong>Risks:</strong> The medicine may cause minor side effects such as abdominal pain, cough, diarrhoea, dizziness, fever, headache, nausea, and vomiting. These usually resolve quickly.</p>
                        <p><strong>Benefits:</strong> Your child's participation will help ensure the medicine is still working. Treatment will be provided at no charge.</p>
                        <p><strong>Confidentiality:</strong> Information collected will be kept confidential. Your child will be identified by a number, not by name.</p>
                        <p><strong>Ethics Approval:</strong> This study has been approved by the Sierra Leone Ethics and Scientific Review Committee.</p>
                    </div>
                `,
                fields: [
                    { name: 'info_sheet_read', label: 'I have read/been read the information sheet above', type: 'checkbox_group', options: ['Yes'], required: true }
                ]
            },
            {
                title: 'Certificate of Consent',
                description: 'Parent/Guardian consent for child participation',
                fields: [
                    { name: 'consent_child_name', label: 'Name of Child (Participant)', type: 'text', required: true },
                    { name: 'consent_parent_name', label: 'Name of Parent/Guardian (Print in full)', type: 'text', required: true },
                    { name: 'consent_parent_signature', label: 'Parent/Guardian Signature (Optional)', type: 'signature', required: false },
                    { name: 'consent_date', label: 'Date', type: 'date', required: true },
                    { name: 'consent_parent_literate', label: 'Is the parent/guardian literate?', type: 'radio_group', options: ['Yes', 'No'], required: true }
                ]
            },
            {
                title: 'Witness (If Parent/Guardian is Illiterate)',
                description: 'Required only if parent/guardian cannot read',
                skipIfLiterate: true,
                fields: [
                    { name: 'witness_name', label: 'Witness Name (Print in full)', type: 'text', required: false },
                    { name: 'witness_signature', label: 'Witness Signature', type: 'signature', required: false },
                    { name: 'witness_date', label: 'Date', type: 'date', required: false }
                ]
            },
            {
                title: 'Investigator Declaration',
                description: 'To be completed by the study investigator',
                fields: [
                    { name: 'investigator_name', label: 'Name of Principal Investigator', type: 'text', required: true, defaultValue: 'Prof. Rashid Ansumana', readonly: true },
                    { name: 'investigator_date', label: 'Date', type: 'date', required: true },
                    { name: 'consent_copy_given', label: 'A copy of this informed consent form has been provided to the participant', type: 'checkbox_group', options: ['Yes'], required: true }
                ]
            }
        ];

        // CASE SCREENING FORM - Exact fields from document
        const SCREENING_SECTIONS = [
            {
                title: 'Case Screening Form',
                description: 'Patient identification and location',
                fields: [
                    { name: 'province', label: 'Province', type: 'cascade_province', required: true },
                    { name: 'district', label: 'District', type: 'cascade_district', required: true },
                    { name: 'health_centre_name', label: 'Health Facility Name', type: 'cascade_hf', required: true },
                    { name: 'patient_screening_number', label: 'Patient screening number', type: 'text', required: true, readonly: true, autoGenerate: true },
                    { name: 'patient_name', label: 'Patient name', type: 'text', required: true, linkFrom: 'consent_child_name' },
                    { name: 'date_of_visit', label: 'Date of visit (dd-mmm-yyyy)', type: 'date', required: true },
                    { name: 'tel', label: 'Tel', type: 'tel', required: false },
                    { name: 'address_landmark', label: 'Address/Landmark', type: 'textarea', required: false }
                ]
            },
            {
                title: 'Demographic Data',
                description: 'Patient demographic information',
                fields: [
                    { name: 'date_of_birth', label: 'Date of birth (dd-mmm-yyyy)', type: 'date', required: false },
                    { name: 'estimated_age_years', label: 'Estimated age - Years', type: 'number', required: false },
                    { name: 'estimated_age_months', label: 'Estimated age - Months', type: 'number', required: false },
                    { name: 'age_display', label: 'Age (auto-calculated)', type: 'text', required: false, readonly: true },
                    { name: 'weight_kg', label: 'Weight (kg)', type: 'number', required: true },
                    { name: 'sex', label: 'Sex', type: 'radio_group', options: ['Male', 'Female'], required: true }
                ]
            },
            {
                title: 'Pre-treatment Temperature',
                description: 'Temperature assessment',
                fields: [
                    { name: 'history_of_fever_24h', label: 'History of fever in previous 24 h?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'temperature', label: 'Temperature (Â°C)', type: 'number', required: true },
                    { name: 'temp_method', label: '', type: 'checkbox_group', options: ['Axillary/Infrared'], required: false }
                ]
            },
            {
                title: 'Thick and Thin Blood Smears',
                description: 'Thick and thin blood smears for estimation of P. falciparum parasite counts',
                fields: [
                    { name: 'species', label: 'Species:', type: 'checkbox_group', options: ['P. falciparum', 'P. vivax', 'P. ovale', 'P. malariae'], required: true },
                    { name: 'other_species_present', label: 'Were species other than P. falciparum present?', type: 'radio_group', options: ['Yes', 'No'], required: true, eligibility_note: '(If yes, patient is not eligible)' },
                    { name: 'approx_parasite_count', label: 'Approximate number of P. falciparum asexual parasites:', type: 'number', required: true },
                    { name: 'parasites_1_200_per_6wbc', label: 'Presence of 1â€“200 parasites / 6 white blood cells?', type: 'radio_group', options: ['Yes', 'No'], required: true, eligibility_note: '(If no, patient is not eligible)' },
                    { name: 'gametocytes_present', label: 'Presence of P. falciparum gametocytes?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'pcr_sample_collected', label: 'Has a blood sample for PCR been collected?', type: 'radio_group', options: ['Yes', 'No'], required: true }
                ]
            },
            {
                title: 'Clinical Assessment',
                description: 'Additional clinical questions for eligibility',
                fields: [
                    { name: 'danger_signs_present', label: 'Presence of general danger signs or signs of severe malaria?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'able_to_swallow', label: 'Is the patient able to swallow oral medication?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'willing_to_comply', label: 'Is caregiver willing to comply with study protocol for follow-up visits?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'severe_malnutrition', label: 'Does patient have severe malnutrition (MUAC <110mm)?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_febrile_conditions', label: 'Other febrile conditions (measles, acute LRTI, severe diarrhea) or chronic diseases?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'interfering_medications', label: 'Regular medication which may interfere with antimalarial pharmacokinetics?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'hypersensitivity_history', label: 'History of hypersensitivity reactions to test medicines?', type: 'radio_group', options: ['Yes', 'No'], required: true }
                ]
            },
            {
                title: 'Eligibility Summary (Auto-Calculated)',
                description: 'Eligibility is automatically determined based on your responses above',
                isEligibilitySummary: true,
                isAutoCalculated: true,
                fields: []
            },
            {
                title: 'Patient Informed Consent and Assent',
                description: 'Consent documentation',
                fields: [
                    { name: 'consent_form_signed', label: 'Consent form signed:', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'patient_identity_number', label: 'Patient identity number:', type: 'text', required: true, readonly: true, autoGenerate: true },
                    { name: 'consent_date', label: 'Date (dd-mmm-yyyy):', type: 'date', required: true }
                ]
            }
        ];

        // DAY 0 - Case Report Form (different structure from screening)
        const DAY0_SECTIONS = [
            {
                title: 'Clinical Status - Day 0',
                description: 'Temperature from screening (read-only)',
                fields: [
                    { name: 'visit_date', label: 'Date of visit (dd-mmm-yyyy)', type: 'date', required: true },
                    { name: 'temperature', label: 'Temperature (Â°C) - from screening', type: 'number', required: true, note: '(Pre-filled from screening)' }
                ]
            },
            {
                title: 'Thick Blood Smears - Day 0',
                description: 'Thick blood smears for P. falciparum: quantitative parasite counts and qualitative gametocyte counts',
                fields: [
                    { name: 'avg_asexual_parasites', label: 'Average number of asexual P. falciparum parasites/Âµl:', type: 'number', required: true },
                    { name: 'gametocytes_present', label: 'Presence of P. falciparum gametocytes?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_species_present', label: 'Were species other than P. falciparum present?', type: 'radio_group', options: ['Yes', 'No'], required: true, eligibility_note: '(If yes, patient is not eligible)' },
                    { name: 'other_species', label: 'If yes, which species?', type: 'checkbox_group', options: ['P. vivax', 'P. ovale', 'P. malariae'], required: false, showIf: { field: 'other_species_present', value: 'Yes' } },
                    { name: 'pcr_sample_collected', label: 'Has blood sample for PCR been collected?', type: 'radio_group', options: ['Yes', 'No'], required: true }
                ]
            },
            {
                title: 'Prior Medication',
                description: 'All prior medication, including natural remedies and homeopathic medicines, taken within the previous 14 days should be reported in this section.',
                fields: [
                    { name: 'prior_antimalarial', label: 'Has the patient taken any prior antimalarial medication?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'prior_med_1_name', label: 'Medicine name (generic name)', type: 'text', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_start', label: 'Start date', type: 'date', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_stop', label: 'Stop date', type: 'date', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_ongoing', label: 'Ongoing', type: 'checkbox_single', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_dose', label: 'Total daily dose and unit (e.g. 400 mg)', type: 'text', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_route', label: 'Route of administration', type: 'text', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } },
                    { name: 'prior_med_1_indication', label: 'Indication for use', type: 'text', required: false, showIf: { field: 'prior_antimalarial', value: 'Yes' } }
                ]
            },
            {
                title: 'Medication Administration - Day 0',
                description: 'Select study medicine and record doses given',
                fields: [
                    { name: 'study_medicine', label: 'Study Medicine', type: 'select', options: ['-- Select Medicine --', 'AL', 'DHAPQ'], required: true, note: 'AL = 28 days follow-up, DHAPQ = 42 days follow-up' },
                    { name: 'antimalarial_dose1_name', label: 'Name of antimalarial drug - Dose 1', type: 'text', required: true, readonly: true, prefillFromMedicine: true },
                    { name: 'dose1_time', label: 'Time of Dose 1 (hh:min)', type: 'time', required: true },
                    { name: 'dose1_tablets', label: 'Number of tablets - Dose 1', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: true },
                    { name: 'dose1_vomit', label: 'Did the patient vomit after Dose 1?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'dose1_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'dose1_vomit', value: 'Yes' } },
                    { name: 'antimalarial_dose2_name', label: 'Name of antimalarial drug - Dose 2', type: 'text', required: true, readonly: true, prefillFromMedicine: true },
                    { name: 'dose2_time', label: 'Time of Dose 2 (hh:min) - Auto: 8hrs after Dose 1', type: 'time', required: true, autoCalculate8hrs: true },
                    { name: 'dose2_tablets', label: 'Number of tablets - Dose 2', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: true },
                    { name: 'dose2_vomit', label: 'Did the patient vomit after Dose 2?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'dose2_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'dose2_vomit', value: 'Yes' } },
                    { name: 'other_med_given', label: 'Was any other medicine given?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_med_name', label: 'Name(s) of other medicine(s)', type: 'text', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_time', label: 'Time of dose (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_tablets', label: 'Number of tablets', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit', label: 'Did the patient vomit?', type: 'radio_group', options: ['Yes', 'No'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_vomit', value: 'Yes' } }
                ]
            }
        ];

        // Days 1-2: Clinical status + Blood smears + Adverse events + Medication (NO history of fever, NO PCR)
        const DAYS_1_2_SECTIONS = [
            {
                title: 'Clinical Status',
                description: 'Current clinical assessment',
                fields: [
                    { name: 'visit_date', label: 'Date of visit (dd-mmm-yyyy)', type: 'date', required: true },
                    { name: 'danger_signs_present', label: 'Presence of danger signs or signs of severe or complicated malaria?', type: 'radio_group', options: ['Yes', 'No'], required: true, note: 'If yes, perform thick blood smear.' },
                    { name: 'temperature', label: 'Temperature (Â°C)', type: 'number', required: true },
                    { name: 'temp_method', label: '', type: 'checkbox_group', options: ['Axillary/Infrared'], required: false }
                ]
            },
            {
                title: 'Thick Blood Smears',
                description: 'Thick blood smears for estimation of P. falciparum parasite counts',
                fields: [
                    { name: 'avg_asexual_parasites', label: 'Average number of asexual P. falciparum parasites/Âµl:', type: 'number', required: true },
                    { name: 'gametocytes_present', label: 'Presence of P. falciparum gametocytes?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_species_present', label: 'Were species other than P. falciparum present?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_species', label: 'If yes, which species?', type: 'checkbox_group', options: ['P. vivax', 'P. ovale', 'P. malariae'], required: false, showIf: { field: 'other_species_present', value: 'Yes' } }
                ]
            },
            {
                title: 'Adverse Events',
                description: 'Report any adverse events',
                fields: [
                    { name: 'adverse_event_present', label: 'Presence of an adverse event?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'adverse_event_name', label: 'If yes, name the adverse event:', type: 'text', required: false, showIf: { field: 'adverse_event_present', value: 'Yes' } },
                    { name: 'serious_adverse_event', label: 'Is it a serious adverse event?', type: 'radio_group', options: ['Yes', 'No'], required: false, showIf: { field: 'adverse_event_present', value: 'Yes' }, note: 'If yes, inform the PI.' }
                ]
            },
            {
                title: 'Medication Administration',
                description: 'Record medication given',
                fields: [
                    { name: 'antimalarial_dose1_name', label: 'Name of antimalarial drug - Dose 1', type: 'text', required: true, readonly: true, prefillFromMedicine: true },
                    { name: 'dose1_time', label: 'Time of Dose 1 (hh:min)', type: 'time', required: true },
                    { name: 'dose1_tablets', label: 'Number of tablets - Dose 1', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: true },
                    { name: 'dose1_vomit', label: 'Did the patient vomit after Dose 1?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'dose1_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'dose1_vomit', value: 'Yes' } },
                    { name: 'antimalarial_dose2_name', label: 'Name of antimalarial drug - Dose 2', type: 'text', required: true, readonly: true, prefillFromMedicine: true },
                    { name: 'dose2_time', label: 'Time of Dose 2 (hh:min) - Auto: 8hrs after Dose 1', type: 'time', required: true, autoCalculate8hrs: true },
                    { name: 'dose2_tablets', label: 'Number of tablets - Dose 2', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: true },
                    { name: 'dose2_vomit', label: 'Did the patient vomit after Dose 2?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'dose2_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'dose2_vomit', value: 'Yes' } },
                    { name: 'other_med_given', label: 'Was any other medicine given?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_med_name', label: 'Name(s) of other medicine(s)', type: 'text', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_time', label: 'Time of dose (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_tablets', label: 'Number of tablets', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit', label: 'Did the patient vomit?', type: 'radio_group', options: ['Yes', 'No'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_vomit', value: 'Yes' } }
                ]
            }
        ];

        // Days 3, 7, 14, 21, 28, 35, 42: Clinical + Blood smears (WITH PCR) + Adverse events + Medication
        // These days have "History of fever within previous 24h" and "PCR sample collected"
        const DAYS_3_TO_42_SECTIONS = [
            {
                title: 'Clinical Status',
                description: 'Current clinical assessment',
                fields: [
                    { name: 'visit_date', label: 'Date of visit (dd-mmm-yyyy)', type: 'date', required: true },
                    { name: 'danger_signs_present', label: 'Presence of danger signs or signs of severe or complicated malaria?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'history_of_fever_24h', label: 'History of fever within previous 24 h?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'temperature', label: 'Temperature (Â°C)', type: 'number', required: true },
                    { name: 'temp_method', label: '', type: 'checkbox_group', options: ['Axillary/Infrared'], required: false }
                ]
            },
            {
                title: 'Thick Blood Smears',
                description: 'Thick blood smears for estimation of P. falciparum parasite counts',
                fields: [
                    { name: 'avg_asexual_parasites', label: 'Average number of asexual P. falciparum parasites/Âµl:', type: 'number', required: true },
                    { name: 'gametocytes_present', label: 'Presence of P. falciparum gametocytes?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_species_present', label: 'Were species other than P. falciparum present?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_species', label: 'If yes, which species?', type: 'checkbox_group', options: ['P. vivax', 'P. ovale', 'P. malariae'], required: false, showIf: { field: 'other_species_present', value: 'Yes' } },
                    { name: 'pcr_sample_collected', label: 'Has a blood sample for PCR been collected?', type: 'radio_group', options: ['Yes', 'No'], required: true }
                ]
            },
            {
                title: 'Adverse Events',
                description: 'Report any adverse events',
                fields: [
                    { name: 'adverse_event_present', label: 'Presence of an adverse event?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'adverse_event_name', label: 'If yes, name the adverse event:', type: 'text', required: false, showIf: { field: 'adverse_event_present', value: 'Yes' } },
                    { name: 'serious_adverse_event', label: 'Is it a serious adverse event?', type: 'radio_group', options: ['Yes', 'No'], required: false, showIf: { field: 'adverse_event_present', value: 'Yes' }, note: 'If yes, inform the PI.' }
                ]
            },
            {
                title: 'Concomitant Medication',
                description: 'Record any other medication given',
                fields: [
                    { name: 'other_med_given', label: 'Was any other medicine given?', type: 'radio_group', options: ['Yes', 'No'], required: true },
                    { name: 'other_med_name', label: 'Name(s) of other medicine(s)', type: 'text', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_time', label: 'Time of dose (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_tablets', label: 'Number of tablets', type: 'select', options: ['-- Select --', '1', '2', '3', '4', '5', '6'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit', label: 'Did the patient vomit?', type: 'radio_group', options: ['Yes', 'No'], required: false, showIf: { field: 'other_med_given', value: 'Yes' } },
                    { name: 'other_med_vomit_time', label: 'Time of vomiting (hh:min)', type: 'time', required: false, showIf: { field: 'other_med_vomit', value: 'Yes' } }
                ]
            }
        ];

        // Day 42 Final Assessment (additional section for day 42 only)
        const DAY42_FINAL_SECTION = {
            title: 'Overall Assessment - Final Day 42',
            description: 'Case report form: final day of follow-up 42 (page 2)',
            fields: [
                { name: 'outcome', label: 'Outcome:', type: 'checkbox_group', options: [
                    'adequate clinical and parasitological response',
                    'early treatment failure',
                    'late clinical failure',
                    'late parasitological failure',
                    'lost to follow-up'
                ], required: true },
                { name: 'outcome_day', label: 'Day of outcome (e.g. 1, 2, 3, 7, 14, ...)', type: 'number', required: false },
                { name: 'pcr_result', label: 'PCR:', type: 'checkbox_group', options: [
                    'P. falciparum recrudescence',
                    'P. falciparum reinfection',
                    'other species',
                    'mixed with P. falciparum recrudescence',
                    'mixed with P. falciparum reinfection',
                    'unknown'
                ], required: false },
                { name: 'pcr_corrected_result', label: 'PCR corrected results:', type: 'checkbox_group', options: [
                    'adequate clinical and parasitological response',
                    'early treatment failure',
                    'late clinical failure',
                    'late parasitological failure',
                    'lost to follow-up'
                ], required: false },
                { name: 'other_comments', label: 'Other comments:', type: 'textarea', required: false }
            ]
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            loadFromLocalStorage();
            state.isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            state.isAdmin = sessionStorage.getItem('isAdmin') === 'true';
            if (state.isLoggedIn) showMainContent();
            setupEventListeners();
        }

        function loadFromLocalStorage() {
            try {
                state.pendingSubmissions = JSON.parse(localStorage.getItem('tes_pendingSubmissions') || '[]');
                state.patients = JSON.parse(localStorage.getItem('tes_patients') || '{}');
                state.submissions = JSON.parse(localStorage.getItem('tes_submissions') || '{}');
            } catch (e) {
                state.pendingSubmissions = [];
                state.patients = {};
                state.submissions = {};
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('tes_pendingSubmissions', JSON.stringify(state.pendingSubmissions));
            localStorage.setItem('tes_patients', JSON.stringify(state.patients));
            localStorage.setItem('tes_submissions', JSON.stringify(state.submissions));
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            window.addEventListener('online', handleOnlineEvent);
            window.addEventListener('offline', handleOfflineEvent);
        }

        // ============================================
        // LOGIN/LOGOUT
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            // Check for admin login
            if (username === CONFIG.ADMIN_USERNAME && password === CONFIG.ADMIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('isAdmin', 'true');
                sessionStorage.setItem('username', username);
                state.isLoggedIn = true;
                state.isAdmin = true;
                errorDiv.classList.remove('show');
                showMainContent();
                showNotification('Logged in as Administrator', 'success');
            }
            // Check for regular user login
            else if (username === CONFIG.LOGIN_USERNAME && password === CONFIG.LOGIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('isAdmin', 'false');
                sessionStorage.setItem('username', username);
                state.isLoggedIn = true;
                state.isAdmin = false;
                errorDiv.classList.remove('show');
                showMainContent();
            } else {
                errorDiv.classList.add('show');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('username');
            state.isLoggedIn = false;
            state.isAdmin = false;
            document.getElementById('mainContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
            updateOnlineStatus();
            updateCounts();
            if (state.isOnline && state.pendingSubmissions.length > 0) syncPendingSubmissions();
        }

        // ============================================
        // MODE CONTROL - WORKFLOW
        // ============================================
        function startNewScreening() {
            // Hide scan panel
            document.getElementById('scanPanel').style.display = 'none';
            
            state.currentMode = 'screening';
            document.getElementById('form_type').value = 'screening';
            document.getElementById('follow_up_day').value = '-1';
            state.selectedDay = -1;
            state.selectedPatientId = null;
            // Patient ID will be set from patient_identity_number field during submission
            document.getElementById('patient_id').value = '';
            
            // Combine Consent + Screening sections
            const allScreeningSections = [...CONSENT_SECTIONS, ...SCREENING_SECTIONS];
            generateFormSections(allScreeningSections);
            
            // Show mode indicator
            const indicator = document.getElementById('modeIndicator');
            indicator.style.display = 'flex';
            indicator.className = 'mode-indicator screening';
            document.getElementById('currentModeLabel').textContent = 'NEW SCREENING - CONSENT & SCREENING FORM';
            
            document.getElementById('daySelector').classList.remove('show');
            document.getElementById('formCard').style.display = 'block';
            window.scrollTo({ top: document.getElementById('formCard').offsetTop - 20, behavior: 'smooth' });
        }

        function startCaseReportForm() {
            // Show scan panel, hide form
            document.getElementById('scanPanel').style.display = 'block';
            document.getElementById('formCard').style.display = 'none';
            document.getElementById('daySelector').classList.remove('show');
            document.getElementById('modeIndicator').style.display = 'none';
            
            state.currentMode = 'followup';
            showNotification('ðŸ“± Scan patient voucher QR code to proceed with follow-up', 'info');
            window.scrollTo({ top: document.getElementById('scanPanel').offsetTop - 20, behavior: 'smooth' });
        }

        function cancelCurrentMode() {
            resetForm();
            document.getElementById('modeIndicator').style.display = 'none';
            document.getElementById('scanPanel').style.display = 'none';
            showNotification('Operation cancelled', 'info');
        }

        function startFollowUp() {
            // Legacy - redirect to new function
            startCaseReportForm();
        }

        // ============================================
        // FORM GENERATION
        // ============================================
        function generateFormSections(sections) {
            const container = document.getElementById('dynamicSections');
            let html = '';
            state.totalSections = sections.length;
            state.currentSection = 1;
            
            sections.forEach((section, index) => {
                const sectionNum = index + 1;
                const isLastSection = index === sections.length - 1;
                
                html += `<div class="form-section ${sectionNum === 1 ? 'active' : ''}" data-section="${sectionNum}">
                    <div class="section-header">
                        <h2 class="section-title">${section.title.toUpperCase()}</h2>
                        <p class="section-description">${section.description}</p>
                    </div>`;
                
                // Info content for consent/information sections
                if (section.isInfoSection && section.infoContent) {
                    html += section.infoContent;
                }
                
                // Eligibility Summary Section (auto-calculated)
                if (section.isEligibilitySummary) {
                    html += `<div class="eligibility-summary" id="eligibilitySummary">
                        <div class="eligibility-result pending" id="eligibilityResult">
                            â³ ELIGIBILITY WILL BE AUTO-CALCULATED FROM YOUR RESPONSES
                        </div>
                        
                        <div class="criteria-summary-section">
                            <div class="criteria-summary-title inclusion">âœ“ INCLUSION CRITERIA (Auto-calculated - All must be MET)</div>
                            <div id="inclusionSummaryItems">
                                <div class="criteria-item pending"><span>Age 6-59 months</span><span class="criteria-value">Enter age above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Mono-infection P. falciparum</span><span class="criteria-value">Select species</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Parasitaemia 2,000-200,000/Âµl</span><span class="criteria-value">Enter count</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Fever â‰¥37.5Â°C or history</span><span class="criteria-value">Enter temp</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Able to swallow oral meds</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Willing to comply</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Informed consent obtained</span><span class="criteria-value">Sign consent</span><span class="criteria-status pending">--</span></div>
                            </div>
                        </div>
                        
                        <div class="criteria-summary-section">
                            <div class="criteria-summary-title exclusion">âœ— EXCLUSION CRITERIA (Auto-calculated - All must be CLEAR)</div>
                            <div id="exclusionSummaryItems">
                                <div class="criteria-item pending"><span>Danger signs/severe malaria</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Weight under 5 kg</span><span class="criteria-value">Enter weight</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Mixed Plasmodium infection</span><span class="criteria-value">Select species</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Severe malnutrition</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Other febrile/chronic conditions</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Interfering medications</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                                <div class="criteria-item pending"><span>Hypersensitivity to medicines</span><span class="criteria-value">Answer above</span><span class="criteria-status pending">--</span></div>
                            </div>
                        </div>
                        
                        <div class="eligibility-note-box">
                            <strong>ðŸ“Š Auto-Calculation:</strong> Eligibility is automatically determined from your responses in previous sections.
                            No need to manually assess each criterion - the system calculates based on age, weight, temperature, species, parasite count, and clinical assessment answers.
                        </div>
                    </div>
                    <input type="hidden" name="is_eligible" id="is_eligible_field" value="">
                    <input type="hidden" name="eligibility_reason" id="eligibility_reason_field" value="">`;
                }
                
                // Criteria list if applicable
                if (section.showCriteria && section.criteriaItems) {
                    const boxClass = section.criteriaType === 'inclusion' ? 'inclusion' : 'exclusion';
                    html += `<div class="criteria-box ${boxClass}">
                        <div class="criteria-title">${section.criteriaType === 'inclusion' ? 'âœ“ ALL CRITERIA MUST BE MET:' : 'âœ— PATIENT IS NOT ELIGIBLE IF ANY APPLY:'}</div>
                        <ul class="criteria-list">
                            ${section.criteriaItems.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>`;
                }
                
                // Fields
                section.fields.forEach(field => {
                    html += generateField(field);
                });
                
                // Navigation
                html += '<div class="navigation-buttons">';
                if (sectionNum > 1) html += '<button type="button" class="btn-nav btn-back" onclick="previousSection()">â† BACK</button>';
                if (isLastSection) {
                    html += '<button type="submit" class="btn-nav btn-submit">SUBMIT</button>';
                } else {
                    html += '<button type="button" class="btn-nav btn-next" onclick="nextSection()">NEXT â†’</button>';
                }
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            updateProgress();
            
            // Initialize signature pads after DOM is updated
            setTimeout(() => {
                // Clear existing pads first
                Object.keys(signaturePads).forEach(key => delete signaturePads[key]);
                initAllSignaturePads();
                // Setup age calculator
                setupAgeCalculator();
                // Setup eligibility calculator listeners
                setupEligibilityCalculator();
                // Setup conditional visibility
                setupConditionalVisibility();
                // Setup medicine selection
                setupMedicineSelection();
                // Auto-fill IDs
                autoFillIds();
            }, 200);
        }

        function generateField(field) {
            // Add data attributes for conditional visibility
            let showIfAttr = '';
            // Don't add required for fields with showIf - they start hidden
            const isConditional = !!field.showIf;
            const shouldBeRequired = field.required && !isConditional;
            
            if (field.showIf) {
                showIfAttr = `data-show-if-field="${field.showIf.field}" data-show-if-value="${field.showIf.value}" style="display: none;"`;
            }
            
            let html = `<div class="form-group" ${showIfAttr}>`;
            html += `<label class="form-label">${field.label.toUpperCase()} ${field.required ? '<span class="required">*</span>' : ''}`;
            if (field.eligibility_note) html += `<span class="eligibility-note">${field.eligibility_note}</span>`;
            if (field.note) html += `<span class="eligibility-note">${field.note}</span>`;
            html += '</label>';
            
            // Radio group for Yes/No questions (mutually exclusive)
            if (field.type === 'radio_group') {
                html += '<div class="checkbox-group">';
                field.options.forEach((option, idx) => {
                    html += `<div class="checkbox-item">
                        <input type="radio" name="${field.name}" id="${field.name}_${idx}" value="${option}" ${shouldBeRequired ? 'required' : ''}>
                        <label for="${field.name}_${idx}">${option}</label>
                    </div>`;
                });
                html += '</div>';
            } else if (field.type === 'checkbox_group') {
                html += '<div class="checkbox-group">';
                field.options.forEach((option, idx) => {
                    html += `<div class="checkbox-item">
                        <input type="checkbox" name="${field.name}" id="${field.name}_${idx}" value="${option}" ${shouldBeRequired && field.options.length === 1 ? 'required' : ''}>
                        <label for="${field.name}_${idx}">${option}</label>
                    </div>`;
                });
                html += '</div>';
            } else if (field.type === 'checkbox_single') {
                html += `<div class="checkbox-item">
                    <input type="checkbox" name="${field.name}" id="${field.name}" value="Yes">
                    <label for="${field.name}">Yes</label>
                </div>`;
            } else if (field.type === 'select') {
                // Handle different select options
                const selectId = field.name === 'study_medicine' ? 'id="study_medicine_select"' : '';
                html += `<select class="form-select" name="${field.name}" ${selectId} ${shouldBeRequired ? 'required' : ''}>`;
                field.options.forEach(opt => {
                    if (opt.startsWith('--')) {
                        html += `<option value="">${opt}</option>`;
                    } else {
                        html += `<option value="${opt}">${opt}</option>`;
                    }
                });
                html += '</select>';
            } else if (field.type === 'cascade_province') {
                html += `<select class="form-select" name="${field.name}" id="cascade_province" onchange="updateDistrictDropdown()" ${shouldBeRequired ? 'required' : ''}>
                    <option value="">Select Province...</option>
                    ${getProvinces().map(p => `<option value="${p}">${p}</option>`).join('')}
                </select>`;
            } else if (field.type === 'cascade_district') {
                html += `<select class="form-select" name="${field.name}" id="cascade_district" onchange="updateHealthFacilityDropdown()" ${shouldBeRequired ? 'required' : ''} disabled>
                    <option value="">Select District...</option>
                </select>`;
            } else if (field.type === 'cascade_hf') {
                html += `<select class="form-select" name="${field.name}" id="cascade_hf" ${shouldBeRequired ? 'required' : ''} disabled>
                    <option value="">Select Health Facility...</option>
                </select>`;
            } else if (field.type === 'signature') {
                html += `<div class="signature-container">
                    <div class="signature-wrapper" id="sigWrapper_${field.name}">
                        <canvas class="signature-pad" id="sigPad_${field.name}"></canvas>
                        <span class="signature-placeholder">Sign here âœ</span>
                    </div>
                    <div class="signature-controls">
                        <span class="signature-label">Draw your signature above</span>
                        <button type="button" class="signature-clear-btn" onclick="clearSignature('${field.name}')">CLEAR</button>
                    </div>
                    <input type="hidden" name="${field.name}" id="sigData_${field.name}" class="signature-input" ${shouldBeRequired ? 'required' : ''}>
                </div>`;
            } else if (field.type === 'textarea') {
                html += `<textarea class="form-textarea" name="${field.name}" rows="3" ${shouldBeRequired ? 'required' : ''}></textarea>`;
            } else if (field.type === 'date') {
                // Special handling for date_of_birth to auto-calculate age
                if (field.name === 'date_of_birth') {
                    html += `<input type="date" class="form-input" name="${field.name}" onchange="autoCalculateAge(this.value)" ${shouldBeRequired ? 'required' : ''}>`;
                } else {
                    html += `<input type="date" class="form-input" name="${field.name}" ${shouldBeRequired ? 'required' : ''}>`;
                }
            } else if (field.type === 'time') {
                // Special handling for dose1_time to auto-calculate dose2_time
                if (field.name === 'dose1_time') {
                    html += `<input type="time" class="form-input" name="${field.name}" id="dose1_time_input" onchange="calculateDose2Time(this.value)" ${shouldBeRequired ? 'required' : ''}>`;
                } else if (field.name === 'dose2_time' && field.autoCalculate8hrs) {
                    html += `<input type="time" class="form-input" name="${field.name}" id="dose2_time_input" ${shouldBeRequired ? 'required' : ''}>`;
                } else {
                    html += `<input type="time" class="form-input" name="${field.name}" ${shouldBeRequired ? 'required' : ''}>`;
                }
            } else if (field.type === 'number') {
                // Special handling for age fields to update display
                if (field.name === 'estimated_age_years' || field.name === 'estimated_age_months') {
                    html += `<input type="number" class="form-input" name="${field.name}" min="0" oninput="updateAgeDisplay()" ${shouldBeRequired ? 'required' : ''}>`;
                } else {
                    html += `<input type="number" class="form-input" name="${field.name}" step="any" ${shouldBeRequired ? 'required' : ''}>`;
                }
            } else if (field.type === 'tel') {
                html += `<input type="tel" class="form-input" name="${field.name}" pattern="[0-9]{9}" maxlength="9" minlength="9" placeholder="e.g. 099725620" title="Phone number must be exactly 9 digits" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 9)" ${shouldBeRequired ? 'required' : ''}>`;
            } else {
                const defaultVal = field.defaultValue ? `value="${field.defaultValue}"` : '';
                const readonlyAttr = field.readonly ? 'readonly style="background: #e9ecef; cursor: not-allowed;"' : '';
                // Special handling for antimalarial drug name fields
                let extraId = '';
                if (field.name === 'antimalarial_dose1_name' || field.name === 'antimalarial_dose2_name') {
                    extraId = `id="${field.name}_input"`;
                }
                html += `<input type="text" class="form-input" name="${field.name}" ${extraId} ${defaultVal} ${readonlyAttr} ${shouldBeRequired ? 'required' : ''}>`;
            }
            
            html += '</div>';
            return html;
        }

        // Automatic Age Calculator from Date of Birth
        function calculateAgeFromDOB(dob) {
            if (!dob) return null;
            
            const birthDate = new Date(dob);
            const today = new Date();
            
            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();
            
            // Adjust if day of month hasn't passed yet
            if (today.getDate() < birthDate.getDate()) {
                months--;
            }
            
            // Adjust if months is negative
            if (months < 0) {
                years--;
                months += 12;
            }
            
            // Calculate total months for eligibility check
            const totalMonths = (years * 12) + months;
            
            return {
                years: Math.max(0, years),
                months: Math.max(0, months),
                totalMonths: Math.max(0, totalMonths)
            };
        }

        // Auto-calculate age when DOB is entered (called from onchange)
        function autoCalculateAge(dobValue) {
            const age = calculateAgeFromDOB(dobValue);
            if (age !== null) {
                // Update years field
                const yearsField = document.querySelector('input[name="estimated_age_years"]');
                if (yearsField) {
                    yearsField.value = age.years;
                }
                
                // Update months field
                const monthsField = document.querySelector('input[name="estimated_age_months"]');
                if (monthsField) {
                    monthsField.value = age.months;
                }
                
                // Update display field with combined format
                const displayField = document.querySelector('input[name="age_display"]');
                if (displayField) {
                    let ageText = '';
                    if (age.years > 0) {
                        ageText += `${age.years} year${age.years !== 1 ? 's' : ''}`;
                    }
                    if (age.months > 0) {
                        if (ageText) ageText += ', ';
                        ageText += `${age.months} month${age.months !== 1 ? 's' : ''}`;
                    }
                    if (!ageText) ageText = '0 months';
                    ageText += ` (${age.totalMonths} months total)`;
                    displayField.value = ageText;
                }
                
                // Show notification
                showNotification(`Age calculated: ${age.years} years, ${age.months} months (${age.totalMonths} months total)`, 'info');
            }
        }

        // Update age display when years or months fields are manually changed
        function updateAgeDisplay() {
            const yearsField = document.querySelector('input[name="estimated_age_years"]');
            const monthsField = document.querySelector('input[name="estimated_age_months"]');
            const displayField = document.querySelector('input[name="age_display"]');
            
            if (yearsField && monthsField && displayField) {
                const years = parseInt(yearsField.value) || 0;
                const months = parseInt(monthsField.value) || 0;
                const totalMonths = (years * 12) + months;
                
                let ageText = '';
                if (years > 0) {
                    ageText += `${years} year${years !== 1 ? 's' : ''}`;
                }
                if (months > 0) {
                    if (ageText) ageText += ', ';
                    ageText += `${months} month${months !== 1 ? 's' : ''}`;
                }
                if (!ageText) ageText = '0 months';
                ageText += ` (${totalMonths} months total)`;
                displayField.value = ageText;
            }
        }

        function setupAgeCalculator() {
            // Find the DOB field and add event listener
            const dobField = document.querySelector('input[name="date_of_birth"]');
            if (dobField) {
                dobField.addEventListener('change', function() {
                    autoCalculateAge(this.value);
                });
            }
            
            // Add listeners to years/months fields for manual entry
            const yearsField = document.querySelector('input[name="estimated_age_years"]');
            const monthsField = document.querySelector('input[name="estimated_age_months"]');
            
            if (yearsField) {
                yearsField.addEventListener('input', updateAgeDisplay);
            }
            if (monthsField) {
                monthsField.addEventListener('input', updateAgeDisplay);
            }
        }

        // ============================================
        // AUTO ID GENERATION
        // ============================================
        function generateScreeningId(patientName = '') {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const mins = String(date.getMinutes()).padStart(2, '0');
            const secs = String(date.getSeconds()).padStart(2, '0');
            
            // Get initials from patient name
            const initials = getInitials(patientName);
            
            if (initials) {
                return `TES-${year}${month}${day}-${hours}${mins}${secs}_${initials}`;
            }
            return `TES-${year}${month}${day}-${hours}${mins}${secs}`;
        }
        
        function getInitials(name) {
            if (!name || name.trim() === '') return '';
            const words = name.trim().split(/\s+/);
            let initials = '';
            words.forEach(word => {
                if (word.length > 0) {
                    initials += word.charAt(0).toUpperCase();
                }
            });
            return initials.substring(0, 4); // Max 4 initials
        }
        
        function updateScreeningIdWithInitials() {
            const patientNameField = document.querySelector('input[name="patient_name"]');
            const childNameField = document.querySelector('input[name="consent_child_name"]');
            const screeningIdField = document.querySelector('input[name="patient_identity_number"]');
            const patientScreeningField = document.querySelector('input[name="patient_screening_number"]');
            
            const name = patientNameField?.value || childNameField?.value || '';
            
            if (screeningIdField) {
                // Extract base ID (remove old initials if present)
                let baseId = screeningIdField.value.split('_')[0];
                if (!baseId.startsWith('TES-')) {
                    baseId = generateScreeningId().split('_')[0];
                }
                const initials = getInitials(name);
                screeningIdField.value = initials ? `${baseId}_${initials}` : baseId;
            }
            
            if (patientScreeningField) {
                // Extract base ID (remove old initials if present)
                let baseId = patientScreeningField.value.split('_')[0];
                if (!baseId.startsWith('TES-')) {
                    baseId = generateScreeningId().split('_')[0];
                }
                const initials = getInitials(name);
                patientScreeningField.value = initials ? `${baseId}_${initials}` : baseId;
            }
        }
        
        function generatePatientId(healthFacility) {
            const date = new Date();
            const year = date.getFullYear();
            // Create facility code from first 3 letters
            const facilityCode = (healthFacility || 'UNK').substring(0, 3).toUpperCase();
            const sequential = Object.keys(state.patients).length + 1;
            return `${facilityCode}-${String(sequential).padStart(3, '0')}-${year}`;
        }
        
        function autoFillIds() {
            // Auto-fill patient identity number (screening ID)
            const screeningIdField = document.querySelector('input[name="patient_identity_number"]');
            if (screeningIdField && !screeningIdField.value) {
                screeningIdField.value = generateScreeningId();
                screeningIdField.readOnly = true;
                screeningIdField.style.backgroundColor = '#e9ecef';
                screeningIdField.style.cursor = 'not-allowed';
            }
            
            // Auto-fill patient screening number
            const patientScreeningField = document.querySelector('input[name="patient_screening_number"]');
            if (patientScreeningField && !patientScreeningField.value) {
                patientScreeningField.value = generateScreeningId();
                patientScreeningField.readOnly = true;
                patientScreeningField.style.backgroundColor = '#e9ecef';
                patientScreeningField.style.cursor = 'not-allowed';
            }
            
            // Link consent_child_name to patient_name and update IDs with initials
            const childNameField = document.querySelector('input[name="consent_child_name"]');
            const patientNameField = document.querySelector('input[name="patient_name"]');
            
            if (childNameField && patientNameField) {
                // If child name already filled, copy to patient name
                if (childNameField.value && !patientNameField.value) {
                    patientNameField.value = childNameField.value;
                    updateScreeningIdWithInitials();
                }
                
                // Set up listener to auto-copy and update IDs
                childNameField.addEventListener('input', function() {
                    if (patientNameField) {
                        patientNameField.value = this.value;
                    }
                    updateScreeningIdWithInitials();
                });
                
                childNameField.addEventListener('change', function() {
                    if (patientNameField) {
                        patientNameField.value = this.value;
                    }
                    updateScreeningIdWithInitials();
                });
            }
            
            // Also link patient_name back to child_name if patient_name filled first
            if (patientNameField && childNameField) {
                patientNameField.addEventListener('input', function() {
                    if (childNameField && !childNameField.value) {
                        childNameField.value = this.value;
                    }
                    updateScreeningIdWithInitials();
                });
                
                patientNameField.addEventListener('change', function() {
                    updateScreeningIdWithInitials();
                });
            }
            
            // Auto-fill today's date for date_of_visit
            const visitDateField = document.querySelector('input[name="date_of_visit"]');
            if (visitDateField && !visitDateField.value) {
                visitDateField.value = new Date().toISOString().split('T')[0];
            }
        }

        // ============================================
        // CONDITIONAL VISIBILITY (showIf)
        // ============================================
        function setupConditionalVisibility() {
            // Find all checkbox groups and selects that control visibility
            document.querySelectorAll('input[type="checkbox"], input[type="radio"], select').forEach(input => {
                input.addEventListener('change', handleConditionalVisibility);
            });
            
            // Initial check
            setTimeout(handleConditionalVisibility, 100);
        }
        
        function handleConditionalVisibility() {
            // Find all fields with showIf conditions
            document.querySelectorAll('[data-show-if-field]').forEach(formGroup => {
                const triggerField = formGroup.dataset.showIfField;
                const triggerValue = formGroup.dataset.showIfValue;
                
                // Check if the trigger field has the expected value
                const triggerInputs = document.querySelectorAll(`input[name="${triggerField}"], select[name="${triggerField}"]`);
                let currentValue = '';
                
                triggerInputs.forEach(input => {
                    if ((input.type === 'checkbox' || input.type === 'radio') && input.checked) {
                        currentValue = input.value;
                    } else if (input.type !== 'checkbox' && input.type !== 'radio' && input.value) {
                        currentValue = input.value;
                    }
                });
                
                // Show or hide based on condition
                if (currentValue === triggerValue) {
                    formGroup.style.display = 'block';
                    formGroup.dataset.hidden = 'false';
                } else {
                    formGroup.style.display = 'none';
                    formGroup.dataset.hidden = 'true';
                    // Clear values when hidden
                    formGroup.querySelectorAll('input, select, textarea').forEach(inp => {
                        if (inp.type === 'checkbox' || inp.type === 'radio') {
                            inp.checked = false;
                        } else {
                            inp.value = '';
                        }
                    });
                }
            });
        }

        // ============================================
        // DOSE 2 TIME CALCULATION (8 hours after Dose 1)
        // ============================================
        function calculateDose2Time(dose1Time) {
            if (!dose1Time) return;
            
            // Parse dose 1 time
            const [hours, minutes] = dose1Time.split(':').map(Number);
            
            // Add 8 hours
            let dose2Hours = hours + 8;
            let dose2Minutes = minutes;
            
            // Handle overflow past midnight
            if (dose2Hours >= 24) {
                dose2Hours = dose2Hours - 24;
            }
            
            // Format as HH:MM
            const dose2Time = `${String(dose2Hours).padStart(2, '0')}:${String(dose2Minutes).padStart(2, '0')}`;
            
            // Update dose 2 time field
            const dose2Field = document.querySelector('input[name="dose2_time"]');
            if (dose2Field) {
                dose2Field.value = dose2Time;
            }
        }

        // ============================================
        // MEDICINE SELECTION HANDLING
        // ============================================
        function setupMedicineSelection() {
            const medicineSelect = document.querySelector('select[name="study_medicine"]');
            if (medicineSelect) {
                medicineSelect.addEventListener('change', handleMedicineChange);
            }
        }
        
        function handleMedicineChange(e) {
            const selectedMedicine = e.target.value;
            if (!selectedMedicine || selectedMedicine.startsWith('--')) return;
            
            const medicineConfig = CONFIG.MEDICINES[selectedMedicine];
            if (!medicineConfig) return;
            
            // Update follow-up days for this patient
            state.patientMedicine = selectedMedicine;
            state.patientFollowUpDays = medicineConfig.followUpDays;
            
            // Prefill antimalarial drug names
            const dose1NameField = document.querySelector('input[name="antimalarial_dose1_name"]');
            const dose2NameField = document.querySelector('input[name="antimalarial_dose2_name"]');
            
            if (dose1NameField) {
                dose1NameField.value = medicineConfig.name;
            }
            if (dose2NameField) {
                dose2NameField.value = medicineConfig.name;
            }
            
            // Update follow-up day buttons
            updateFollowUpDayButtons(medicineConfig.followUpDays);
            
            showNotification(`Selected ${medicineConfig.name}. Follow-up: Days ${medicineConfig.followUpDays.join(', ')} (${medicineConfig.maxDay} days total)`, 'info');
        }
        
        function updateFollowUpDayButtons(allowedDays) {
            // Update the day selection buttons based on medicine
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (allowedDays.includes(day)) {
                    btn.style.display = 'inline-flex';
                    btn.disabled = false;
                } else {
                    btn.style.display = 'none';
                }
            });
        }
        
        function prefillMedicineForFollowUp(patientId) {
            const patient = state.patients[patientId];
            if (!patient || !patient.studyMedicine) return;
            
            const medicineConfig = CONFIG.MEDICINES[patient.studyMedicine];
            if (!medicineConfig) return;
            
            // Prefill medicine names in follow-up forms
            setTimeout(() => {
                const dose1NameField = document.querySelector('input[name="antimalarial_dose1_name"]');
                const dose2NameField = document.querySelector('input[name="antimalarial_dose2_name"]');
                
                if (dose1NameField) {
                    dose1NameField.value = medicineConfig.name;
                }
                if (dose2NameField) {
                    dose2NameField.value = medicineConfig.name;
                }
            }, 100);
        }

        // ============================================
        // ELIGIBILITY CALCULATOR
        // ============================================
        function setupEligibilityCalculator() {
            // Fields that affect eligibility calculation
            const eligibilityFields = [
                'estimated_age_years', 'estimated_age_months', 'weight_kg', 
                'temperature', 'history_of_fever_24h',
                'species', 'other_species_present', 'approx_parasite_count',
                'danger_signs_present', 'able_to_swallow', 'willing_to_comply',
                'severe_malnutrition', 'other_febrile_conditions', 
                'interfering_medications', 'hypersensitivity_history',
                'consent_form_signed'
            ];
            
            // Add change listeners to all eligibility fields
            eligibilityFields.forEach(fieldName => {
                const inputs = document.querySelectorAll(`input[name="${fieldName}"], select[name="${fieldName}"]`);
                inputs.forEach(input => {
                    input.addEventListener('change', calculateEligibility);
                    input.addEventListener('input', calculateEligibility);
                });
            });
            
            // Initial calculation
            setTimeout(calculateEligibility, 500);
        }

        function calculateEligibility() {
            // Get form values
            const ageYears = parseInt(document.querySelector('input[name="estimated_age_years"]')?.value) || 0;
            const ageMonths = parseInt(document.querySelector('input[name="estimated_age_months"]')?.value) || 0;
            const totalMonths = (ageYears * 12) + ageMonths;
            
            const weight = parseFloat(document.querySelector('input[name="weight_kg"]')?.value) || 0;
            const temperature = parseFloat(document.querySelector('input[name="temperature"]')?.value) || 0;
            const historyOfFever = getRadioValue('history_of_fever_24h');
            
            const speciesChecked = Array.from(document.querySelectorAll('input[name="species"]:checked')).map(cb => cb.value);
            const otherSpeciesPresent = getRadioValue('other_species_present');
            const parasiteCount = parseFloat(document.querySelector('input[name="approx_parasite_count"]')?.value) || 0;
            
            const dangerSigns = getRadioValue('danger_signs_present');
            const ableToSwallow = getRadioValue('able_to_swallow');
            const willingToComply = getRadioValue('willing_to_comply');
            const severeMalnutrition = getRadioValue('severe_malnutrition');
            const otherFebrile = getRadioValue('other_febrile_conditions');
            const interferingMeds = getRadioValue('interfering_medications');
            const hypersensitivity = getRadioValue('hypersensitivity_history');
            const consentSigned = getRadioValue('consent_form_signed');
            
            // Auto-calculate inclusion criteria
            const inclusionCriteria = [
                { 
                    label: 'Age 6-59 months',
                    met: totalMonths >= 6 && totalMonths <= 59,
                    value: totalMonths > 0 ? `${totalMonths} months` : 'Not entered',
                    filled: totalMonths > 0
                },
                { 
                    label: 'Mono-infection with P. falciparum',
                    met: speciesChecked.includes('P. falciparum') && speciesChecked.length === 1 && otherSpeciesPresent === 'No',
                    value: speciesChecked.length > 0 ? speciesChecked.join(', ') : 'Not selected',
                    filled: speciesChecked.length > 0 && otherSpeciesPresent !== null
                },
                { 
                    label: 'Parasitaemia 2,000-200,000/Âµl',
                    met: parasiteCount >= 2000 && parasiteCount <= 200000,
                    value: parasiteCount > 0 ? parasiteCount.toLocaleString() + '/Âµl' : 'Not entered',
                    filled: parasiteCount > 0
                },
                { 
                    label: 'Fever â‰¥37.5Â°C or history of fever',
                    met: temperature >= 37.5 || historyOfFever === 'Yes',
                    value: temperature > 0 ? `${temperature}Â°C` : 'Not entered',
                    filled: temperature > 0 || historyOfFever !== null
                },
                { 
                    label: 'Able to swallow oral medication',
                    met: ableToSwallow === 'Yes',
                    value: ableToSwallow || 'Not answered',
                    filled: ableToSwallow !== null
                },
                { 
                    label: 'Willing to comply with protocol',
                    met: willingToComply === 'Yes',
                    value: willingToComply || 'Not answered',
                    filled: willingToComply !== null
                },
                { 
                    label: 'Informed consent obtained',
                    met: consentSigned === 'Yes',
                    value: consentSigned || 'Not answered',
                    filled: consentSigned !== null
                }
            ];
            
            // Auto-calculate exclusion criteria
            const exclusionCriteria = [
                { 
                    label: 'Danger signs or severe malaria',
                    met: dangerSigns === 'Yes',
                    value: dangerSigns || 'Not answered',
                    filled: dangerSigns !== null
                },
                { 
                    label: 'Weight under 5 kg',
                    met: weight > 0 && weight < 5,
                    value: weight > 0 ? `${weight} kg` : 'Not entered',
                    filled: weight > 0
                },
                { 
                    label: 'Mixed Plasmodium infection',
                    met: otherSpeciesPresent === 'Yes' || speciesChecked.length > 1,
                    value: otherSpeciesPresent || 'Not answered',
                    filled: otherSpeciesPresent !== null
                },
                { 
                    label: 'Severe malnutrition',
                    met: severeMalnutrition === 'Yes',
                    value: severeMalnutrition || 'Not answered',
                    filled: severeMalnutrition !== null
                },
                { 
                    label: 'Other febrile/chronic conditions',
                    met: otherFebrile === 'Yes',
                    value: otherFebrile || 'Not answered',
                    filled: otherFebrile !== null
                },
                { 
                    label: 'Interfering medications',
                    met: interferingMeds === 'Yes',
                    value: interferingMeds || 'Not answered',
                    filled: interferingMeds !== null
                },
                { 
                    label: 'Hypersensitivity to medicines',
                    met: hypersensitivity === 'Yes',
                    value: hypersensitivity || 'Not answered',
                    filled: hypersensitivity !== null
                }
            ];
            
            let allInclusionMet = true;
            let anyExclusionMet = false;
            let allFieldsFilled = true;
            let reasons = [];
            
            // Build inclusion HTML
            let inclusionHtml = '';
            inclusionCriteria.forEach(criterion => {
                let statusClass = 'pending';
                let statusText = '--';
                let itemClass = 'pending';
                
                if (!criterion.filled) {
                    allFieldsFilled = false;
                } else if (criterion.met) {
                    statusClass = 'yes';
                    statusText = 'âœ“ MET';
                    itemClass = 'met';
                } else {
                    statusClass = 'no';
                    statusText = 'âœ— NOT MET';
                    itemClass = 'not-met';
                    allInclusionMet = false;
                    reasons.push(`Inclusion not met: ${criterion.label}`);
                }
                
                inclusionHtml += `<div class="criteria-item ${itemClass}">
                    <span>${criterion.label}</span>
                    <span class="criteria-value">${criterion.value}</span>
                    <span class="criteria-status ${statusClass}">${statusText}</span>
                </div>`;
            });
            
            // Build exclusion HTML
            let exclusionHtml = '';
            exclusionCriteria.forEach(criterion => {
                let statusClass = 'pending';
                let statusText = '--';
                let itemClass = 'pending';
                
                if (!criterion.filled) {
                    allFieldsFilled = false;
                } else if (!criterion.met) {
                    statusClass = 'yes';
                    statusText = 'âœ“ CLEAR';
                    itemClass = 'met';
                } else {
                    statusClass = 'no';
                    statusText = 'âœ— PRESENT';
                    itemClass = 'not-met';
                    anyExclusionMet = true;
                    reasons.push(`Exclusion present: ${criterion.label}`);
                }
                
                exclusionHtml += `<div class="criteria-item ${itemClass}">
                    <span>${criterion.label}</span>
                    <span class="criteria-value">${criterion.value}</span>
                    <span class="criteria-status ${statusClass}">${statusText}</span>
                </div>`;
            });
            
            // Update the summary display
            const inclusionContainer = document.getElementById('inclusionSummaryItems');
            const exclusionContainer = document.getElementById('exclusionSummaryItems');
            const resultDiv = document.getElementById('eligibilityResult');
            const summaryDiv = document.getElementById('eligibilitySummary');
            
            if (inclusionContainer) inclusionContainer.innerHTML = inclusionHtml;
            if (exclusionContainer) exclusionContainer.innerHTML = exclusionHtml;
            
            // Determine overall eligibility
            const isEligible = allInclusionMet && !anyExclusionMet;
            
            if (resultDiv && summaryDiv) {
                if (!allFieldsFilled) {
                    resultDiv.className = 'eligibility-result pending';
                    resultDiv.innerHTML = 'â³ COMPLETE ALL FIELDS TO SEE ELIGIBILITY';
                    summaryDiv.className = 'eligibility-summary';
                } else if (isEligible) {
                    resultDiv.className = 'eligibility-result eligible';
                    resultDiv.innerHTML = 'âœ… PATIENT IS ELIGIBLE FOR ENROLLMENT';
                    summaryDiv.className = 'eligibility-summary eligible';
                } else {
                    resultDiv.className = 'eligibility-result not-eligible';
                    resultDiv.innerHTML = 'âŒ PATIENT IS NOT ELIGIBLE';
                    summaryDiv.className = 'eligibility-summary not-eligible';
                }
            }
            
            // Update hidden fields for form submission
            const eligibleField = document.getElementById('is_eligible_field');
            const reasonField = document.getElementById('eligibility_reason_field');
            
            if (eligibleField) {
                eligibleField.value = allFieldsFilled ? (isEligible ? 'Yes' : 'No') : '';
            }
            if (reasonField) {
                reasonField.value = reasons.join('; ');
            }
            
            return { isEligible, allFieldsFilled, reasons };
        }

        function getCheckboxGroupValue(fieldName) {
            const checkedBox = document.querySelector(`input[name="${fieldName}"]:checked`);
            return checkedBox ? checkedBox.value : null;
        }
        
        function getRadioValue(fieldName) {
            const checkedRadio = document.querySelector(`input[name="${fieldName}"]:checked`);
            return checkedRadio ? checkedRadio.value : null;
        }

        // Cascading dropdown handlers
        function updateDistrictDropdown() {
            const province = document.getElementById('cascade_province').value;
            const districtSelect = document.getElementById('cascade_district');
            const hfSelect = document.getElementById('cascade_hf');
            
            // Reset district and health facility
            districtSelect.innerHTML = '<option value="">Select District...</option>';
            hfSelect.innerHTML = '<option value="">Select Health Facility...</option>';
            hfSelect.disabled = true;
            
            if (province) {
                const districts = getDistrictsByProvince(province);
                districts.forEach(d => {
                    districtSelect.innerHTML += `<option value="${d}">${d}</option>`;
                });
                districtSelect.disabled = false;
            } else {
                districtSelect.disabled = true;
            }
        }

        function updateHealthFacilityDropdown() {
            const province = document.getElementById('cascade_province').value;
            const district = document.getElementById('cascade_district').value;
            const hfSelect = document.getElementById('cascade_hf');
            
            // Reset health facility
            hfSelect.innerHTML = '<option value="">Select Health Facility...</option>';
            
            if (province && district) {
                const facilities = getHealthFacilitiesByDistrict(province, district);
                facilities.forEach(f => {
                    hfSelect.innerHTML += `<option value="${f}">${f}</option>`;
                });
                hfSelect.disabled = false;
            } else {
                hfSelect.disabled = true;
            }
        }

        // ============================================
        // SIGNATURE PAD
        // ============================================
        const signaturePads = {};

        function initSignaturePad(fieldName) {
            const canvas = document.getElementById(`sigPad_${fieldName}`);
            if (!canvas || signaturePads[fieldName]) return; // Already initialized
            
            const wrapper = document.getElementById(`sigWrapper_${fieldName}`);
            const container = canvas.closest('.signature-container');
            
            // Set canvas size
            const containerWidth = container ? container.offsetWidth : 300;
            canvas.width = Math.max(containerWidth - 4, 280);
            canvas.height = 150;
            
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000080';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }
            
            function onStart(e) {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                wrapper.classList.add('has-signature');
            }
            
            function onMove(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                lastX = pos.x;
                lastY = pos.y;
            }
            
            function onEnd(e) {
                if (isDrawing) {
                    isDrawing = false;
                    saveSignature(fieldName);
                }
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', onStart);
            canvas.addEventListener('mousemove', onMove);
            canvas.addEventListener('mouseup', onEnd);
            canvas.addEventListener('mouseleave', onEnd);
            
            // Touch events
            canvas.addEventListener('touchstart', onStart, { passive: false });
            canvas.addEventListener('touchmove', onMove, { passive: false });
            canvas.addEventListener('touchend', onEnd);
            canvas.addEventListener('touchcancel', onEnd);
            
            signaturePads[fieldName] = { canvas, ctx, wrapper };
            console.log('Signature pad initialized:', fieldName);
        }

        function saveSignature(fieldName) {
            const canvas = document.getElementById(`sigPad_${fieldName}`);
            const input = document.getElementById(`sigData_${fieldName}`);
            if (canvas && input) {
                input.value = canvas.toDataURL('image/png');
            }
        }

        function clearSignature(fieldName) {
            const pad = signaturePads[fieldName];
            if (pad) {
                pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
                pad.wrapper.classList.remove('has-signature');
                document.getElementById(`sigData_${fieldName}`).value = '';
            }
        }

        function initAllSignaturePads() {
            // Find all signature canvases and initialize them
            const canvases = document.querySelectorAll('.signature-pad');
            console.log('Found signature canvases:', canvases.length);
            canvases.forEach(canvas => {
                const fieldName = canvas.id.replace('sigPad_', '');
                console.log('Initializing signature pad:', fieldName);
                initSignaturePad(fieldName);
            });
        }

        // Re-initialize signature pads when section becomes visible
        function reinitVisibleSignaturePads() {
            const activeSection = document.querySelector('.form-section.active');
            if (activeSection) {
                activeSection.querySelectorAll('.signature-pad').forEach(canvas => {
                    const fieldName = canvas.id.replace('sigPad_', '');
                    const pad = signaturePads[fieldName];
                    if (pad) {
                        // Resize canvas if needed
                        const container = canvas.closest('.signature-container');
                        const containerWidth = container ? container.offsetWidth : 300;
                        if (canvas.width !== containerWidth - 4) {
                            canvas.width = Math.max(containerWidth - 4, 280);
                            pad.ctx.strokeStyle = '#000080';
                            pad.ctx.lineWidth = 2;
                            pad.ctx.lineCap = 'round';
                            pad.ctx.lineJoin = 'round';
                        }
                    }
                });
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function shouldSkipWitnessSection() {
            // Check if parent is literate - if Yes, skip witness section
            const literateCheckbox = document.querySelector('input[name="consent_parent_literate"]:checked');
            return literateCheckbox && literateCheckbox.value === 'Yes';
        }
        
        function isWitnessSection(sectionNum) {
            // Check if the section title contains "Witness"
            const section = document.querySelector(`.form-section[data-section="${sectionNum}"]`);
            if (section) {
                const title = section.querySelector('.section-title');
                return title && title.textContent.toLowerCase().includes('witness');
            }
            return false;
        }
        
        function nextSection() {
            if (state.currentSection < state.totalSections) {
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.remove('active');
                state.currentSection++;
                
                // Skip witness section if parent is literate
                if (isWitnessSection(state.currentSection) && shouldSkipWitnessSection()) {
                    state.currentSection++;
                }
                
                // Make sure we don't go past the last section
                if (state.currentSection > state.totalSections) {
                    state.currentSection = state.totalSections;
                }
                
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.add('active');
                updateProgress();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // Reinit signature pads in newly visible section
                setTimeout(() => reinitVisibleSignaturePads(), 100);
            }
        }

        function previousSection() {
            if (state.currentSection > 1) {
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.remove('active');
                state.currentSection--;
                
                // Skip witness section if parent is literate (going backwards)
                if (isWitnessSection(state.currentSection) && shouldSkipWitnessSection()) {
                    state.currentSection--;
                }
                
                // Make sure we don't go below 1
                if (state.currentSection < 1) {
                    state.currentSection = 1;
                }
                
                document.querySelector(`.form-section[data-section="${state.currentSection}"]`).classList.add('active');
                updateProgress();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // Reinit signature pads in newly visible section
                setTimeout(() => reinitVisibleSignaturePads(), 100);
            }
        }

        function updateProgress() {
            const progress = (state.currentSection / state.totalSections) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            let modeLabel = state.currentMode === 'screening' ? 'CASE SCREENING FORM' : `DAY ${state.selectedDay} - CASE REPORT FORM`;
            document.getElementById('progressText').innerHTML = `${modeLabel} | SECTION ${state.currentSection} OF ${state.totalSections}`;
        }

        // ============================================
        // FORM SUBMISSION
        // ============================================
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Remove required from hidden fields before validation
            document.querySelectorAll('[data-show-if-field]').forEach(formGroup => {
                if (formGroup.style.display === 'none') {
                    formGroup.querySelectorAll('input, select, textarea').forEach(inp => {
                        inp.required = false;
                    });
                }
            });
            
            const formData = new FormData(e.target);
            let patientId = document.getElementById('patient_id').value;
            const day = parseInt(document.getElementById('follow_up_day').value);
            
            // For screening, use patient_identity_number (which includes initials)
            if (state.currentMode === 'screening') {
                const identityField = document.querySelector('input[name="patient_identity_number"]');
                if (identityField && identityField.value) {
                    patientId = identityField.value;
                    document.getElementById('patient_id').value = patientId;
                }
            }
            
            // For screening, get the auto-calculated eligibility from hidden fields
            let isEligible = false;
            let eligibilityReason = '';
            
            if (state.currentMode === 'screening') {
                // Calculate eligibility one more time to ensure accuracy
                const eligibilityResult = calculateEligibility();
                
                if (!eligibilityResult.allFieldsFilled) {
                    showNotification('Please complete all inclusion and exclusion criteria before submitting.', 'error');
                    return;
                }
                
                isEligible = eligibilityResult.isEligible;
                eligibilityReason = eligibilityResult.reasons.join('; ');
            }
            
            // Check duplicate
            const submissionKey = state.currentMode === 'screening' ? `${patientId}_screening` : `${patientId}_day${day}`;
            if (state.submissions[submissionKey]) {
                showNotification(`Entry already exists for this patient/day!`, 'error');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                submittedBy: sessionStorage.getItem('username') || 'admin',
                patient_id: patientId,
                follow_up_day: day,
                form_type: state.currentMode
            };
            
            // Collect all form data including checkbox groups and radio groups
            const checkboxGroups = {};
            document.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked').forEach(cb => {
                if (cb.type === 'radio') {
                    data[cb.name] = cb.value;
                } else {
                    if (!checkboxGroups[cb.name]) checkboxGroups[cb.name] = [];
                    checkboxGroups[cb.name].push(cb.value);
                }
            });
            
            for (const [key, value] of formData.entries()) {
                if (!checkboxGroups[key] && !data[key]) data[key] = value;
            }
            for (const [key, values] of Object.entries(checkboxGroups)) {
                data[key] = values.join(', ');
            }
            
            // Add eligibility data for screening
            if (state.currentMode === 'screening') {
                data.is_eligible = isEligible ? 'Yes' : 'No';
                data.eligibility_reason = eligibilityReason;
            }
            
            // Check withdrawal conditions for follow-up (not screening)
            let shouldWithdraw = false;
            let withdrawalReason = '';
            
            if (state.currentMode !== 'screening' && state.patients[patientId]) {
                // Check for conditions that require withdrawal
                if (data.danger_signs_present === 'Yes') {
                    shouldWithdraw = true;
                    withdrawalReason = 'Danger signs or severe malaria present';
                }
                if (data.other_species_present === 'Yes') {
                    shouldWithdraw = true;
                    withdrawalReason = 'Other Plasmodium species detected';
                }
                if (data.serious_adverse_event === 'Yes') {
                    shouldWithdraw = true;
                    withdrawalReason = 'Serious adverse event';
                }
                
                if (shouldWithdraw) {
                    data.patient_withdrawn = 'Yes';
                    data.withdrawal_reason = withdrawalReason;
                    data.withdrawal_day = day;
                }
            }

            state.submissions[submissionKey] = data;
            
            // Save patient for screening
            if (state.currentMode === 'screening' && isEligible) {
                state.patients[patientId] = {
                    patientId: patientId,
                    patientName: data.patient_name,
                    healthCentre: data.health_centre_name,
                    district: data.district,
                    dateOfBirth: data.date_of_birth || '',
                    address: data.address_landmark || '',
                    enrollmentDate: data.date_of_visit || new Date().toISOString().split('T')[0],
                    screeningDate: data.date_of_visit || new Date().toISOString().split('T')[0],
                    ageYears: data.estimated_age_years || 0,
                    ageMonths: data.estimated_age_months || 0,
                    ageInMonths: (parseInt(data.estimated_age_years || 0) * 12) + parseInt(data.estimated_age_months || 0),
                    ageDisplay: data.age_display || '',
                    sex: data.sex,
                    weight: data.weight_kg,
                    screeningTemperature: data.temperature,
                    isEligible: true,
                    isWithdrawn: false,
                    withdrawalReason: '',
                    withdrawalDay: null,
                    completedDays: []
                };
            } else if (state.currentMode !== 'screening' && state.patients[patientId]) {
                if (!state.patients[patientId].completedDays.includes(day)) {
                    state.patients[patientId].completedDays.push(day);
                    state.patients[patientId].completedDays.sort((a, b) => a - b);
                }
                
                // Mark patient as withdrawn if conditions met
                if (shouldWithdraw) {
                    state.patients[patientId].isWithdrawn = true;
                    state.patients[patientId].withdrawalReason = withdrawalReason;
                    state.patients[patientId].withdrawalDay = day;
                }
                
                // Store medicine selection from Day 0
                if (day === 0 && data.study_medicine) {
                    state.patients[patientId].studyMedicine = data.study_medicine;
                    const medicineConfig = CONFIG.MEDICINES[data.study_medicine];
                    if (medicineConfig) {
                        state.patients[patientId].followUpDays = medicineConfig.followUpDays;
                        state.patients[patientId].maxFollowUpDay = medicineConfig.maxDay;
                    }
                }
            }
            
            saveToLocalStorage();
            updateCounts();

            if (state.isOnline) {
                await submitToServer(data);
            } else {
                saveOffline(data);
            }
            
            if (state.currentMode === 'screening' && isEligible) {
                showNotification(`âœ… Screening submitted successfully! Patient ${data.patient_name} is ELIGIBLE for enrollment.`, 'success');
                showVouchers(patientId, data);
            } else if (state.currentMode === 'screening' && !isEligible) {
                showNotification(`âŒ Screening submitted. Patient is NOT ELIGIBLE. Reason: ${eligibilityReason || 'Criteria not met'}`, 'warning');
                resetForm();
            } else if (shouldWithdraw) {
                showNotification(`â›” Day ${day} submitted. PATIENT IS NOW OUT OF STUDY. Reason: ${withdrawalReason}. No further follow-up allowed.`, 'warning');
                resetForm();
            } else {
                showNotification(`âœ… Day ${day} data submitted successfully!`, 'success');
                resetForm();
            }
        }

        async function submitToServer(data) {
            try {
                await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showNotification('Data submitted successfully!', 'success');
            } catch (error) {
                console.error('Submit error:', error);
                showNotification('Failed to submit - Saved offline', 'error');
                saveOffline(data);
            }
        }

        function saveOffline(data) {
            state.pendingSubmissions.push(data);
            saveToLocalStorage();
            updateCounts();
            showNotification('Data saved offline - Will sync when online', 'info');
        }

        async function syncPendingSubmissions() {
            if (state.pendingSubmissions.length === 0) return;
            showNotification('Syncing pending submissions...', 'info');
            const successfulSyncs = [];
            
            for (let i = 0; i < state.pendingSubmissions.length; i++) {
                try {
                    await fetch(CONFIG.SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state.pendingSubmissions[i])
                    });
                    successfulSyncs.push(i);
                } catch (error) {
                    console.error('Sync error:', error);
                }
            }

            if (successfulSyncs.length > 0) {
                state.pendingSubmissions = state.pendingSubmissions.filter((_, index) => !successfulSyncs.includes(index));
                saveToLocalStorage();
                updateCounts();
                showNotification(`Synced ${successfulSyncs.length} submission(s)`, 'success');
            }
        }

        function resetForm() {
            document.getElementById('dataForm').reset();
            document.getElementById('formCard').style.display = 'none';
            document.getElementById('daySelector').classList.remove('show');
            document.getElementById('modeIndicator').style.display = 'none';
            document.getElementById('scanPanel').style.display = 'none';
            document.getElementById('patientInfoBar').style.display = 'none';
            state.currentMode = null;
            state.selectedPatientId = null;
            state.selectedDay = -1;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // VOUCHER FUNCTIONS - Single Voucher Per Patient
        // ============================================
        function showVouchers(patientId, data) {
            const patient = state.patients[patientId];
            if (!patient) return;
            
            // Generate 4 identical voucher cards
            const grid = document.getElementById('voucherGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const card = document.createElement('div');
                card.className = 'voucher-card-mini';
                
                card.innerHTML = `
                    <!-- Header -->
                    <div class="voucher-mini-header">
                        <div class="voucher-mini-logo">
                            <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                                <rect width="50" height="50" fill="#004080" rx="4"/>
                                <text x="25" y="20" text-anchor="middle" fill="#ffffff" font-size="10" font-weight="bold" font-family="Arial">ICF</text>
                                <text x="25" y="32" text-anchor="middle" fill="#ffc107" font-size="8" font-weight="bold" font-family="Arial">SL</text>
                                <text x="25" y="44" text-anchor="middle" fill="#ffffff" font-size="6" font-family="Arial">2026</text>
                            </svg>
                        </div>
                        <div class="voucher-mini-title">
                            TES 2026 - SIERRA LEONE
                            <span>National Malaria Control Programme</span>
                        </div>
                    </div>
                    
                    <!-- Patient ID -->
                    <div class="voucher-mini-id">
                        <div class="voucher-mini-id-label">Patient ID</div>
                        <div class="voucher-mini-id-value">${patientId}</div>
                    </div>
                    
                    <!-- Body - Info fields then QR below -->
                    <div class="voucher-mini-body">
                        <div class="voucher-mini-info">
                            <div class="voucher-mini-field full-width">
                                <div class="voucher-mini-field-label">Patient Name</div>
                                <div class="voucher-mini-field-value">${patient.patientName || '---'}</div>
                            </div>
                            <div class="voucher-mini-field">
                                <div class="voucher-mini-field-label">Date of Birth</div>
                                <div class="voucher-mini-field-value">${patient.dateOfBirth || '---'}</div>
                            </div>
                            <div class="voucher-mini-field">
                                <div class="voucher-mini-field-label">Age</div>
                                <div class="voucher-mini-field-value">${patient.ageDisplay || (patient.ageInMonths ? patient.ageInMonths + ' months' : '---')}</div>
                            </div>
                            <div class="voucher-mini-field full-width">
                                <div class="voucher-mini-field-label">Health Facility</div>
                                <div class="voucher-mini-field-value">${patient.healthCentre || '---'}</div>
                            </div>
                            <div class="voucher-mini-field full-width">
                                <div class="voucher-mini-field-label">Address / Landmark</div>
                                <div class="voucher-mini-field-value">${patient.address || '---'}</div>
                            </div>
                        </div>
                        
                        <!-- QR Code - Bigger, centered below -->
                        <div class="voucher-mini-qr">
                            <div class="voucher-mini-qr-box" id="qr_${i}"></div>
                            <div class="voucher-mini-qr-text">Scan QR Code to Verify</div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="voucher-mini-footer">
                        <div class="voucher-mini-footer-text">Present this voucher at each follow-up visit</div>
                        <div class="voucher-mini-footer-days">ICF-SL Â© 2026</div>
                    </div>
                `;
                
                grid.appendChild(card);
                
                // Generate bigger QR code for this card
                setTimeout(() => {
                    const qrContainer = document.getElementById(`qr_${i}`);
                    if (qrContainer) {
                        const qrData = JSON.stringify({
                            id: patientId,
                            name: patient.patientName,
                            hf: patient.healthCentre,
                            dob: patient.dateOfBirth
                        });
                        
                        new QRCode(qrContainer, {
                            text: qrData,
                            width: 100,
                            height: 100,
                            colorDark: "#004080",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    }
                }, i * 100);
            }
            
            document.getElementById('voucherModal').classList.add('show');
        }

        function closeVoucherModal() {
            document.getElementById('voucherModal').classList.remove('show');
            resetForm();
        }

        function printVouchers() {
            window.print();
        }

        async function downloadVoucherPDF() {
            const patientId = document.querySelector('.voucher-mini-id-value')?.textContent || 'Unknown';
            
            showNotification('Generating PDF...', 'info');
            
            try {
                const voucherPage = document.getElementById('voucherA4Page');
                
                // Capture the A4 page as canvas
                const canvas = await html2canvas(voucherPage, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: voucherPage.scrollWidth,
                    height: voucherPage.scrollHeight
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // Create PDF with jsPDF - A4 size
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // A4 dimensions: 210mm x 297mm
                const pdfWidth = 210;
                const pdfHeight = 297;
                
                // Add image to fit A4
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                // Save PDF
                pdf.save(`TES_Vouchers_${patientId}.pdf`);
                
                showNotification('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('Error generating PDF. Try printing instead.', 'error');
            }
        }

        // Legacy function for compatibility
        function downloadVoucher() {
            downloadVoucherPDF();
        }
        
        function printVoucher() {
            printVouchers();
        }

        // ============================================
        // QR SCANNER
        // ============================================
        function openScannerModal() {
            document.getElementById('scannerModal').classList.add('show');
            startQRScanner();
        }

        function closeScannerModal() {
            document.getElementById('scannerModal').classList.remove('show');
            stopQRScanner();
        }

        function startQRScanner() {
            if (state.qrScanner) state.qrScanner.clear();
            state.qrScanner = new Html5Qrcode("qr-reader");
            state.qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => handleQRCodeScanned(decodedText),
                (errorMessage) => {}
            ).catch(err => {
                console.error('Scanner error:', err);
                showNotification('Camera access denied or not available', 'error');
            });
        }

        function stopQRScanner() {
            if (state.qrScanner) {
                state.qrScanner.stop().then(() => state.qrScanner.clear()).catch(err => console.error('Stop scanner error:', err));
            }
        }

        function handleQRCodeScanned(decodedText) {
            stopQRScanner();
            closeScannerModal();
            
            try {
                const data = JSON.parse(decodedText);
                const patientId = data.id;
                const scannedDay = data.day;
                
                if (!patientId || !state.patients[patientId]) {
                    showNotification('Patient not found in local database', 'error');
                    return;
                }
                selectPatientForFollowup(patientId, scannedDay, true); // true = from QR scan
            } catch (e) {
                if (state.patients[decodedText]) {
                    selectPatientForFollowup(decodedText, null, true); // true = from QR scan
                } else {
                    showNotification('Invalid QR code or patient not found', 'error');
                }
            }
        }

        // ============================================
        // FOLLOW-UP
        // ============================================
        function selectPatientForFollowup(patientId, preferredDay = null, fromQRScan = false) {
            const patient = state.patients[patientId];
            if (!patient) { showNotification('Patient not found', 'error'); return; }
            
            // Require QR scan for follow-up visits
            if (!fromQRScan) {
                showNotification('ðŸ“± Please SCAN the patient voucher QR code to proceed with follow-up visit.', 'warning');
                openScannerModal();
                return;
            }
            
            // Check if patient is withdrawn
            if (patient.isWithdrawn) {
                showNotification(`â›” PATIENT IS OUT OF STUDY (Withdrawn Day ${patient.withdrawalDay}). Reason: ${patient.withdrawalReason}. No further follow-up allowed.`, 'error');
                return;
            }
            
            state.selectedPatientId = patientId;
            state.currentMode = 'followup';
            
            // Hide scan panel
            document.getElementById('scanPanel').style.display = 'none';
            
            // Show mode indicator for follow-up
            const indicator = document.getElementById('modeIndicator');
            indicator.style.display = 'flex';
            indicator.className = 'mode-indicator followup';
            document.getElementById('currentModeLabel').textContent = `FOLLOW-UP: ${patient.patientName} (${patientId})`;
            
            document.getElementById('selectedPatientId').textContent = `${patientId} (${patient.patientName})`;
            updateDayButtons(patient);
            document.getElementById('daySelector').classList.add('show');
            document.getElementById('formCard').style.display = 'none';
            
            // If a specific day was scanned, automatically select it
            if (preferredDay !== null) {
                const completedDays = patient.completedDays || [];
                
                // Check if this day can be selected
                if (completedDays.includes(preferredDay)) {
                    showNotification(`Day ${preferredDay} already completed. Please select next available day.`, 'warning');
                } else {
                    // Verify sequential order
                    let followUpDays = CONFIG.FOLLOW_UP_DAYS;
                    if (patient.studyMedicine && CONFIG.MEDICINES[patient.studyMedicine]) {
                        followUpDays = CONFIG.MEDICINES[patient.studyMedicine].followUpDays;
                    }
                    const dayIndex = followUpDays.indexOf(preferredDay);
                    const previousDay = dayIndex > 0 ? followUpDays[dayIndex - 1] : null;
                    
                    if (previousDay === null || completedDays.includes(previousDay)) {
                        // Day is valid, auto-select it
                        showNotification(`Patient ${patient.patientName} - Opening Day ${preferredDay} form...`, 'success');
                        setTimeout(() => selectDay(preferredDay), 500);
                        return;
                    } else {
                        showNotification(`Cannot open Day ${preferredDay}. Please complete Day ${previousDay} first.`, 'warning');
                    }
                }
            } else {
                showNotification(`Patient ${patient.patientName} selected - Choose follow-up day`, 'success');
            }
            
            window.scrollTo({ top: document.getElementById('daySelector').offsetTop - 20, behavior: 'smooth' });
        }

        function updateDayButtons(patient) {
            const container = document.getElementById('dayButtons');
            const completedDays = patient.completedDays || [];
            const isWithdrawn = patient.isWithdrawn || false;
            
            // Get follow-up days based on patient's medicine (if selected)
            let followUpDays = CONFIG.FOLLOW_UP_DAYS; // Default all days
            if (patient.studyMedicine && CONFIG.MEDICINES[patient.studyMedicine]) {
                followUpDays = CONFIG.MEDICINES[patient.studyMedicine].followUpDays;
            }
            
            let html = '';
            followUpDays.forEach((day, index) => {
                const isCompleted = completedDays.includes(day);
                let isLocked = false;
                if (index > 0) {
                    const previousDay = followUpDays[index - 1];
                    isLocked = !completedDays.includes(previousDay);
                }
                
                let className = 'day-btn';
                let disabled = '';
                let label = `D${day}`;
                
                if (isCompleted) { 
                    className += ' completed'; 
                    disabled = 'disabled'; 
                    label += 'âœ“';
                } else if (isWithdrawn) { 
                    className += ' locked'; 
                    disabled = 'disabled'; 
                    label += 'âœ—';
                } else if (isLocked) { 
                    className += ' locked'; 
                    disabled = 'disabled'; 
                }
                
                html += `<button type="button" class="${className}" data-day="${day}" ${disabled} onclick="selectDay(${day})">${label}</button>`;
            });
            container.innerHTML = html;
        }

        function selectDay(day) {
            const patientId = state.selectedPatientId;
            if (!patientId) { showNotification('Please select a patient first', 'error'); return; }
            
            const patient = state.patients[patientId];
            const completedDays = patient.completedDays || [];
            
            // Check if patient is withdrawn
            if (patient.isWithdrawn) {
                showNotification(`â›” PATIENT IS OUT OF STUDY (Withdrawn Day ${patient.withdrawalDay}). Reason: ${patient.withdrawalReason}. No further follow-up allowed.`, 'error');
                return;
            }
            
            // Get follow-up days based on patient's medicine
            let followUpDays = CONFIG.FOLLOW_UP_DAYS;
            let maxDay = 42;
            if (patient.studyMedicine && CONFIG.MEDICINES[patient.studyMedicine]) {
                followUpDays = CONFIG.MEDICINES[patient.studyMedicine].followUpDays;
                maxDay = CONFIG.MEDICINES[patient.studyMedicine].maxDay;
            }
            
            if (completedDays.includes(day)) { showNotification(`Day ${day} already completed`, 'warning'); return; }
            
            const dayIndex = followUpDays.indexOf(day);
            if (dayIndex > 0) {
                const previousDay = followUpDays[dayIndex - 1];
                if (!completedDays.includes(previousDay)) { showNotification(`Please complete Day ${previousDay} first`, 'error'); return; }
            }
            
            state.selectedDay = day;
            document.getElementById('patient_id').value = patientId;
            document.getElementById('follow_up_day').value = day;
            document.getElementById('form_type').value = 'followup';
            
            // Update mode indicator with day info
            document.getElementById('currentModeLabel').textContent = `DAY ${day} FOLLOW-UP: ${patient.patientName} (${patientId})`;
            
            // Show and populate patient info bar
            document.getElementById('patientInfoBar').style.display = 'block';
            document.getElementById('infoPatientName').textContent = patient.patientName || '---';
            document.getElementById('infoPatientId').textContent = patientId;
            document.getElementById('infoPatientAge').textContent = patient.ageDisplay || `${patient.ageYears || 0}y ${patient.ageMonths || 0}m`;
            document.getElementById('infoPatientSex').textContent = patient.sex || '---';
            document.getElementById('infoPatientWeight').textContent = patient.weight ? `${patient.weight} kg` : '---';
            document.getElementById('infoHealthCentre').textContent = patient.healthCentre || '---';
            
            // Select correct form based on day
            let sections;
            if (day === 0) {
                sections = DAY0_SECTIONS;
            } else if (day === 1 || day === 2) {
                sections = DAYS_1_2_SECTIONS;
            } else {
                sections = DAYS_3_TO_42_SECTIONS.slice(); // Copy array
                // Add final assessment for the final day (Day 28 for AL, Day 42 for DHAPQ)
                if (day === maxDay) {
                    // Update the title to reflect the actual final day
                    const finalSection = JSON.parse(JSON.stringify(DAY42_FINAL_SECTION));
                    finalSection.title = `Overall Assessment - Final Day ${maxDay}`;
                    finalSection.description = `Case report form: final day of follow-up ${maxDay}`;
                    sections.push(finalSection);
                }
            }
            
            generateFormSections(sections);
            
            // Prefill patient info after form is generated
            prefillPatientInfo(patientId, day);
            
            document.getElementById('formCard').style.display = 'block';
            
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            
            showNotification(`Day ${day} case report form ready`, 'info');
            window.scrollTo({ top: document.getElementById('formCard').offsetTop - 20, behavior: 'smooth' });
        }

        // Prefill patient info in follow-up forms
        function prefillPatientInfo(patientId, day) {
            const patient = state.patients[patientId];
            if (!patient) return;
            
            // For Day 0: prefill temperature from screening
            if (day === 0 && patient.screeningTemperature) {
                const tempField = document.querySelector('input[name="temperature"]');
                if (tempField) {
                    tempField.value = patient.screeningTemperature;
                    tempField.readOnly = true;
                    tempField.style.backgroundColor = '#e9ecef';
                }
            }
            
            // Set today's date for visit_date
            const visitDateField = document.querySelector('input[name="visit_date"]');
            if (visitDateField) {
                visitDateField.value = new Date().toISOString().split('T')[0];
            }
            
            // Prefill medicine names for Days 1-2 if medicine was selected in Day 0
            if ((day === 1 || day === 2) && patient.studyMedicine) {
                const medicineConfig = CONFIG.MEDICINES[patient.studyMedicine];
                if (medicineConfig) {
                    setTimeout(() => {
                        const dose1NameField = document.querySelector('input[name="antimalarial_dose1_name"]');
                        const dose2NameField = document.querySelector('input[name="antimalarial_dose2_name"]');
                        
                        if (dose1NameField) {
                            dose1NameField.value = medicineConfig.name;
                        }
                        if (dose2NameField) {
                            dose2NameField.value = medicineConfig.name;
                        }
                    }, 100);
                }
            }
        }

        // ============================================
        // PATIENTS MODAL
        // ============================================
        function openPatientsModal() {
            const modal = document.getElementById('patientsModal');
            const body = document.getElementById('patientsModalBody');
            
            const patientsList = Object.values(state.patients).filter(p => p.isEligible);
            
            if (patientsList.length === 0) {
                body.innerHTML = '<div class="no-patients">No eligible patients enrolled yet</div>';
            } else {
                let html = '';
                patientsList.forEach(patient => {
                    const completedDays = patient.completedDays || [];
                    const isWithdrawn = patient.isWithdrawn || false;
                    
                    // Get follow-up days based on patient's medicine
                    let followUpDays = CONFIG.FOLLOW_UP_DAYS;
                    if (patient.studyMedicine && CONFIG.MEDICINES[patient.studyMedicine]) {
                        followUpDays = CONFIG.MEDICINES[patient.studyMedicine].followUpDays;
                    }
                    
                    const allCompleted = !isWithdrawn && completedDays.length === followUpDays.length;
                    
                    // Determine status
                    let statusClass = 'active';
                    let statusText = 'ACTIVE';
                    if (isWithdrawn) {
                        statusClass = 'withdrawn';
                        statusText = 'âŒ OUT OF STUDY';
                    } else if (allCompleted) {
                        statusClass = 'completed';
                        statusText = 'âœ“ COMPLETED';
                    }
                    
                    html += `<div class="patient-card ${isWithdrawn ? 'withdrawn-card' : ''}">
                        <div class="patient-card-header">
                            <span class="patient-id">${patient.patientId}</span>
                            <span class="patient-status ${statusClass}">${statusText}</span>
                        </div>
                        ${isWithdrawn ? `<div class="withdrawal-notice">
                            <strong>Withdrawn on Day ${patient.withdrawalDay}:</strong> ${patient.withdrawalReason}
                        </div>` : ''}
                        <div class="patient-info-grid">
                            <div class="patient-info-item"><span class="patient-info-label">NAME</span><span class="patient-info-value">${patient.patientName || '---'}</span></div>
                            <div class="patient-info-item"><span class="patient-info-label">AGE</span><span class="patient-info-value">${patient.ageDisplay || `${patient.ageYears || 0}y ${patient.ageMonths || 0}m`}</span></div>
                            <div class="patient-info-item"><span class="patient-info-label">HEALTH CENTRE</span><span class="patient-info-value">${patient.healthCentre || '---'}</span></div>
                            <div class="patient-info-item"><span class="patient-info-label">MEDICINE</span><span class="patient-info-value">${patient.studyMedicine || 'Not assigned'}</span></div>
                        </div>
                        <div class="patient-days-progress">
                            ${followUpDays.map(day => {
                                const isCompleted = completedDays.includes(day);
                                const dayIndex = followUpDays.indexOf(day);
                                const previousDay = dayIndex > 0 ? followUpDays[dayIndex - 1] : null;
                                const isPreviousCompleted = previousDay === null || completedDays.includes(previousDay);
                                const isPending = !isCompleted && isPreviousCompleted && !isWithdrawn;
                                const isBlocked = isWithdrawn && !isCompleted;
                                return `<span class="day-badge ${isCompleted ? 'completed' : isBlocked ? 'blocked' : isPending ? 'pending' : 'locked'}">D${day}${isCompleted ? 'âœ“' : isBlocked ? 'âœ—' : ''}</span>`;
                            }).join('')}
                        </div>
                        <div class="patient-actions">
                            ${isWithdrawn ? 
                                `<button class="patient-action-btn disabled" disabled>OUT OF STUDY</button>` :
                                `<button class="patient-action-btn followup" onclick="closePatientsModal(); openScannerModal()">ðŸ“± SCAN VOUCHER</button>`
                            }
                            <button class="patient-action-btn voucher" onclick="showVouchersFromList('${patient.patientId}')">VOUCHERS</button>
                        </div>
                    </div>`;
                });
                body.innerHTML = html;
            }
            modal.classList.add('show');
        }

        function closePatientsModal() { document.getElementById('patientsModal').classList.remove('show'); }
        function showVouchersFromList(patientId) { closePatientsModal(); if (state.patients[patientId]) showVouchers(patientId, state.patients[patientId]); }

        // ============================================
        // VIEW DATA MODAL
        // ============================================
        let currentDataTab = 'screening';
        let cachedData = { screening: null, followup: null, patients: null };

        function openViewDataModal() {
            document.getElementById('viewDataModal').classList.add('show');
            loadSheetData(currentDataTab);
        }

        function closeViewDataModal() {
            document.getElementById('viewDataModal').classList.remove('show');
        }

        function switchDataTab(tab) {
            currentDataTab = tab;
            document.querySelectorAll('.view-data-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-data-tab[onclick="switchDataTab('${tab}')"]`).classList.add('active');
            loadSheetData(tab);
        }

        async function loadSheetData(sheetName) {
            const body = document.getElementById('viewDataBody');
            body.innerHTML = '<div class="view-data-loading">Loading data from Google Sheets...</div>';

            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getData&sheet=${sheetName}`);
                const result = await response.json();

                if (result.success && result.data) {
                    cachedData[sheetName] = result.data;
                    renderDataTable(result.data, sheetName);
                } else {
                    body.innerHTML = `<div class="view-data-error">Error: ${result.error || 'Failed to load data'}</div>`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                // Fall back to local data if available
                if (sheetName === 'screening' || sheetName === 'followup') {
                    const localData = getLocalData(sheetName);
                    if (localData.length > 0) {
                        renderDataTable(localData, sheetName);
                        showNotification('Showing local data - Could not connect to server', 'warning');
                    } else {
                        body.innerHTML = '<div class="view-data-error">Could not connect to Google Sheets. Check your internet connection and Script URL.</div>';
                    }
                } else if (sheetName === 'patients') {
                    const patientData = Object.values(state.patients).map(p => ({
                        patient_id: p.patientId,
                        patient_name: p.patientName,
                        health_centre: p.healthCentre,
                        district: p.district,
                        age: p.age,
                        age_unit: p.ageUnit,
                        sex: p.sex,
                        screening_date: p.screeningDate,
                        completed_days: (p.completedDays || []).join(', ')
                    }));
                    if (patientData.length > 0) {
                        renderDataTable(patientData, sheetName);
                        showNotification('Showing local patient data', 'info');
                    } else {
                        body.innerHTML = '<div class="view-data-error">No local patient data available</div>';
                    }
                }
            }
        }

        function getLocalData(type) {
            const submissions = Object.values(state.submissions);
            if (type === 'screening') {
                return submissions.filter(s => s.form_type === 'screening');
            } else if (type === 'followup') {
                return submissions.filter(s => s.form_type === 'followup');
            }
            return [];
        }

        function renderDataTable(data, sheetName) {
            const body = document.getElementById('viewDataBody');
            
            if (!data || data.length === 0) {
                body.innerHTML = '<div class="view-data-error">No data available</div>';
                return;
            }

            // Get headers from first row
            const headers = Object.keys(data[0]);
            
            // Calculate stats
            const stats = calculateStats(data, sheetName);

            let html = `
                <button class="refresh-btn" onclick="loadSheetData('${sheetName}')">REFRESH DATA</button>
                <div class="data-stats">
                    <div class="data-stat">
                        <div class="data-stat-label">TOTAL RECORDS</div>
                        <div class="data-stat-value">${data.length}</div>
                    </div>
                    ${stats}
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${headers.map(h => `<th>${formatHeader(h)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr>
                                    ${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            body.innerHTML = html;
        }

        function formatHeader(header) {
            return header.replace(/_/g, ' ').toUpperCase();
        }

        function calculateStats(data, sheetName) {
            let statsHtml = '';
            
            if (sheetName === 'screening') {
                const eligible = data.filter(r => r.is_eligible === 'Yes').length;
                const notEligible = data.filter(r => r.is_eligible === 'No').length;
                statsHtml = `
                    <div class="data-stat">
                        <div class="data-stat-label">ELIGIBLE</div>
                        <div class="data-stat-value" style="color: #28a745;">${eligible}</div>
                    </div>
                    <div class="data-stat">
                        <div class="data-stat-label">NOT ELIGIBLE</div>
                        <div class="data-stat-value" style="color: #dc3545;">${notEligible}</div>
                    </div>
                `;
            } else if (sheetName === 'followup') {
                const dayGroups = {};
                data.forEach(r => {
                    const day = r.follow_up_day || 'Unknown';
                    dayGroups[day] = (dayGroups[day] || 0) + 1;
                });
                statsHtml = Object.entries(dayGroups).map(([day, count]) => `
                    <div class="data-stat">
                        <div class="data-stat-label">DAY ${day}</div>
                        <div class="data-stat-value">${count}</div>
                    </div>
                `).join('');
            } else if (sheetName === 'patients') {
                const active = data.filter(r => {
                    const completed = (r.completed_days || '').split(',').filter(d => d.trim()).length;
                    return completed < 10;
                }).length;
                statsHtml = `
                    <div class="data-stat">
                        <div class="data-stat-label">ACTIVE</div>
                        <div class="data-stat-value" style="color: #17a2b8;">${active}</div>
                    </div>
                    <div class="data-stat">
                        <div class="data-stat-label">COMPLETED</div>
                        <div class="data-stat-value" style="color: #28a745;">${data.length - active}</div>
                    </div>
                `;
            }
            
            return statsHtml;
        }

        // ============================================
        // DASHBOARD
        // ============================================
        let currentDashboardTab = 'overview';
        let dashboardCharts = {};

        function openDashboard() {
            document.getElementById('dashboardModal').classList.add('show');
            loadDashboard(currentDashboardTab);
        }

        function closeDashboard() {
            document.getElementById('dashboardModal').classList.remove('show');
            // Destroy all charts to prevent memory leaks
            Object.values(dashboardCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            dashboardCharts = {};
        }

        function switchDashboardTab(tab) {
            currentDashboardTab = tab;
            document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.dashboard-tab[onclick="switchDashboardTab('${tab}')"]`).classList.add('active');
            
            // Destroy existing charts
            Object.values(dashboardCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            dashboardCharts = {};
            
            loadDashboard(tab);
        }

        function loadDashboard(tab) {
            const body = document.getElementById('dashboardBody');
            
            // Get local data
            const screeningData = getLocalData('screening');
            const followupData = getLocalData('followup');
            const patientsData = Object.values(state.patients);
            
            if (tab === 'overview') {
                renderOverviewDashboard(body, screeningData, followupData, patientsData);
            } else if (tab === 'screening') {
                renderScreeningDashboard(body, screeningData);
            } else if (tab === 'followup') {
                renderFollowupDashboard(body, followupData);
            } else if (tab === 'patients') {
                renderPatientsDashboard(body, patientsData);
            }
        }

        function renderOverviewDashboard(body, screeningData, followupData, patientsData) {
            const totalScreened = screeningData.length;
            const eligible = screeningData.filter(r => r.is_eligible === 'Yes').length;
            const notEligible = totalScreened - eligible;
            const totalFollowups = followupData.length;
            const activePatients = patientsData.filter(p => (p.completedDays || []).length < 10).length;
            const completedPatients = patientsData.length - activePatients;
            
            body.innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card primary">
                        <div class="summary-card-value">${totalScreened}</div>
                        <div class="summary-card-label">Total Screened</div>
                    </div>
                    <div class="summary-card success">
                        <div class="summary-card-value">${eligible}</div>
                        <div class="summary-card-label">Eligible</div>
                    </div>
                    <div class="summary-card danger">
                        <div class="summary-card-value">${notEligible}</div>
                        <div class="summary-card-label">Not Eligible</div>
                    </div>
                    <div class="summary-card info">
                        <div class="summary-card-value">${totalFollowups}</div>
                        <div class="summary-card-label">Follow-ups</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-card-value">${activePatients}</div>
                        <div class="summary-card-label">Active Patients</div>
                    </div>
                    <div class="summary-card orange">
                        <div class="summary-card-value">${completedPatients}</div>
                        <div class="summary-card-label">Completed</div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div class="chart-card-title">ELIGIBILITY STATUS</div>
                        <div class="chart-container small">
                            <canvas id="eligibilityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">GENDER DISTRIBUTION</div>
                        <div class="chart-container small">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">PATIENTS BY HEALTH CENTRE</div>
                        <div class="chart-container">
                            <canvas id="healthCentreChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">FOLLOW-UPS BY DAY</div>
                        <div class="chart-container">
                            <canvas id="followupDayChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card full-width">
                        <div class="chart-card-title">ENROLLMENT TREND</div>
                        <div class="chart-container">
                            <canvas id="enrollmentTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Create charts
            setTimeout(() => {
                createEligibilityChart(screeningData);
                createGenderChart(screeningData);
                createHealthCentreChart(screeningData);
                createFollowupDayChart(followupData);
                createEnrollmentTrendChart(screeningData);
            }, 100);
        }

        function renderScreeningDashboard(body, screeningData) {
            body.innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card primary">
                        <div class="summary-card-value">${screeningData.length}</div>
                        <div class="summary-card-label">Total Screened</div>
                    </div>
                    <div class="summary-card success">
                        <div class="summary-card-value">${screeningData.filter(r => r.is_eligible === 'Yes').length}</div>
                        <div class="summary-card-label">Eligible</div>
                    </div>
                    <div class="summary-card danger">
                        <div class="summary-card-value">${screeningData.filter(r => r.is_eligible === 'No').length}</div>
                        <div class="summary-card-label">Not Eligible</div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div class="chart-card-title">ELIGIBILITY (DONUT)</div>
                        <div class="chart-container">
                            <canvas id="screeningEligibilityDonut"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">AGE DISTRIBUTION (HISTOGRAM)</div>
                        <div class="chart-container">
                            <canvas id="ageHistogram"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">TEMPERATURE DISTRIBUTION</div>
                        <div class="chart-container">
                            <canvas id="tempHistogram"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">PARASITE COUNT RANGES</div>
                        <div class="chart-container">
                            <canvas id="parasiteChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">SPECIES DETECTED</div>
                        <div class="chart-container">
                            <canvas id="speciesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">BY HEALTH CENTRE</div>
                        <div class="chart-container">
                            <canvas id="screeningByCentre"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                createScreeningEligibilityDonut(screeningData);
                createAgeHistogram(screeningData);
                createTempHistogram(screeningData);
                createParasiteChart(screeningData);
                createSpeciesChart(screeningData);
                createScreeningByCentre(screeningData);
            }, 100);
        }

        function renderFollowupDashboard(body, followupData) {
            const dayGroups = {};
            CONFIG.FOLLOW_UP_DAYS.forEach(d => dayGroups[d] = 0);
            followupData.forEach(r => {
                const day = parseInt(r.follow_up_day);
                if (!isNaN(day)) dayGroups[day] = (dayGroups[day] || 0) + 1;
            });
            
            body.innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card primary">
                        <div class="summary-card-value">${followupData.length}</div>
                        <div class="summary-card-label">Total Follow-ups</div>
                    </div>
                    ${CONFIG.FOLLOW_UP_DAYS.slice(0, 5).map(day => `
                        <div class="summary-card ${dayGroups[day] > 0 ? 'success' : 'warning'}">
                            <div class="summary-card-value">${dayGroups[day]}</div>
                            <div class="summary-card-label">Day ${day}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="dashboard-grid">
                    <div class="chart-card full-width">
                        <div class="chart-card-title">FOLLOW-UPS BY DAY (BAR CHART)</div>
                        <div class="chart-container">
                            <canvas id="followupBarChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">COMPLETION RATE (DONUT)</div>
                        <div class="chart-container">
                            <canvas id="completionDonut"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">ADVERSE EVENTS</div>
                        <div class="chart-container">
                            <canvas id="adverseEventsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">TEMPERATURE TRENDS</div>
                        <div class="chart-container">
                            <canvas id="tempTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">PARASITE CLEARANCE</div>
                        <div class="chart-container">
                            <canvas id="parasiteClearanceChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                createFollowupBarChart(followupData);
                createCompletionDonut(followupData);
                createAdverseEventsChart(followupData);
                createTempTrendChart(followupData);
                createParasiteClearanceChart(followupData);
            }, 100);
        }

        function renderPatientsDashboard(body, patientsData) {
            if (patientsData.length === 0) {
                body.innerHTML = '<div class="view-data-error">No patients enrolled yet</div>';
                return;
            }
            
            let html = `
                <div class="summary-cards">
                    <div class="summary-card primary">
                        <div class="summary-card-value">${patientsData.length}</div>
                        <div class="summary-card-label">Total Enrolled</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-card-value">${patientsData.filter(p => (p.completedDays || []).length < 10).length}</div>
                        <div class="summary-card-label">Active</div>
                    </div>
                    <div class="summary-card success">
                        <div class="summary-card-value">${patientsData.filter(p => (p.completedDays || []).length >= 10).length}</div>
                        <div class="summary-card-label">Completed All Days</div>
                    </div>
                </div>
                <p style="margin-bottom: 15px; color: #666; font-size: 13px;">Click on a patient to view details. Click on completed days to see follow-up data.</p>
            `;
            
            patientsData.forEach((patient, index) => {
                const completedDays = patient.completedDays || [];
                const allCompleted = completedDays.length >= 10;
                
                html += `
                    <div class="patient-detail-card">
                        <div class="patient-detail-header" onclick="togglePatientDetail(${index})">
                            <div>
                                <div class="patient-detail-name">${patient.patientName || 'Unknown'}</div>
                                <div class="patient-detail-id">${patient.patientId}</div>
                            </div>
                            <span class="patient-detail-status ${allCompleted ? 'completed' : 'active'}">${allCompleted ? 'COMPLETED' : 'ACTIVE'} (${completedDays.length}/10)</span>
                        </div>
                        <div class="patient-detail-body" id="patientDetail${index}">
                            <div class="patient-info-summary">
                                <div class="patient-info-item-sm">
                                    <div class="label">AGE</div>
                                    <div class="value">${patient.ageDisplay || `${patient.ageYears || 0}y ${patient.ageMonths || 0}m`}</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">SEX</div>
                                    <div class="value">${patient.sex || '---'}</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">WEIGHT</div>
                                    <div class="value">${patient.weight || '---'} kg</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">HEALTH CENTRE</div>
                                    <div class="value">${patient.healthCentre || '---'}</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">DISTRICT</div>
                                    <div class="value">${patient.district || '---'}</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">SCREENING DATE</div>
                                    <div class="value">${patient.screeningDate || '---'}</div>
                                </div>
                                <div class="patient-info-item-sm">
                                    <div class="label">TEMPERATURE</div>
                                    <div class="value">${patient.screeningTemperature || '---'}Â°C</div>
                                </div>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">FOLLOW-UP DAYS (Click to view details):</p>
                            <div class="day-timeline">
                                ${CONFIG.FOLLOW_UP_DAYS.map((day, dayIdx) => {
                                    const isCompleted = completedDays.includes(day);
                                    const prevDay = dayIdx > 0 ? CONFIG.FOLLOW_UP_DAYS[dayIdx - 1] : null;
                                    const isPending = !isCompleted && (prevDay === null || completedDays.includes(prevDay));
                                    let statusClass = isCompleted ? 'completed' : isPending ? 'pending' : 'locked';
                                    return `<div class="day-timeline-item ${statusClass}" onclick="showDayDetail('${patient.patientId}', ${day}, ${index})" id="dayItem_${index}_${day}">
                                        Day ${day} ${isCompleted ? 'âœ“' : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                            <div class="day-detail-panel" id="dayDetailPanel${index}"></div>
                        </div>
                    </div>
                `;
            });
            
            body.innerHTML = html;
        }

        function togglePatientDetail(index) {
            const detail = document.getElementById(`patientDetail${index}`);
            detail.classList.toggle('show');
        }

        function showDayDetail(patientId, day, patientIndex) {
            // Highlight selected day
            document.querySelectorAll(`#patientDetail${patientIndex} .day-timeline-item`).forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById(`dayItem_${patientIndex}_${day}`).classList.add('selected');
            
            // Get follow-up data for this patient and day
            const submissionKey = `${patientId}_day${day}`;
            const dayData = state.submissions[submissionKey];
            
            const panel = document.getElementById(`dayDetailPanel${patientIndex}`);
            
            if (!dayData) {
                panel.innerHTML = `<div class="day-detail-title">DAY ${day} - No Data Yet</div><p style="color: #666; font-size: 12px;">This day has not been completed yet.</p>`;
            } else {
                let detailHtml = `<div class="day-detail-title">DAY ${day} - ${dayData.visit_date || 'Date N/A'}</div>`;
                detailHtml += '<div class="day-detail-grid">';
                
                // Show relevant fields based on day
                const fieldsToShow = [
                    { key: 'temperature', label: 'Temperature' },
                    { key: 'avg_asexual_parasites', label: 'Parasite Count' },
                    { key: 'gametocytes_present', label: 'Gametocytes' },
                    { key: 'danger_signs_present', label: 'Danger Signs' },
                    { key: 'adverse_event_present', label: 'Adverse Event' },
                    { key: 'adverse_event_name', label: 'AE Name' },
                    { key: 'pcr_sample_collected', label: 'PCR Sample' },
                    { key: 'history_of_fever_24h', label: 'Fever History' }
                ];
                
                fieldsToShow.forEach(field => {
                    if (dayData[field.key]) {
                        detailHtml += `
                            <div class="day-detail-item">
                                <div class="label">${field.label}</div>
                                <div class="value">${dayData[field.key]}</div>
                            </div>
                        `;
                    }
                });
                
                detailHtml += '</div>';
                panel.innerHTML = detailHtml;
            }
            
            panel.classList.add('show');
        }

        // Chart creation functions
        function createEligibilityChart(data) {
            const eligible = data.filter(r => r.is_eligible === 'Yes').length;
            const notEligible = data.filter(r => r.is_eligible === 'No').length;
            
            const ctx = document.getElementById('eligibilityChart');
            if (!ctx) return;
            
            dashboardCharts.eligibility = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Eligible', 'Not Eligible'],
                    datasets: [{
                        data: [eligible, notEligible],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createGenderChart(data) {
            const male = data.filter(r => (r.sex || '').includes('Male')).length;
            const female = data.filter(r => (r.sex || '').includes('Female')).length;
            
            const ctx = document.getElementById('genderChart');
            if (!ctx) return;
            
            dashboardCharts.gender = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [male, female],
                        backgroundColor: ['#17a2b8', '#e83e8c']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createHealthCentreChart(data) {
            const centres = {};
            data.forEach(r => {
                const centre = r.health_centre_name || 'Unknown';
                centres[centre] = (centres[centre] || 0) + 1;
            });
            
            const ctx = document.getElementById('healthCentreChart');
            if (!ctx) return;
            
            dashboardCharts.healthCentre = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(centres).map(c => c.replace(' Government Hospital', '')),
                    datasets: [{
                        label: 'Patients',
                        data: Object.values(centres),
                        backgroundColor: '#004080'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createFollowupDayChart(data) {
            const days = {};
            CONFIG.FOLLOW_UP_DAYS.forEach(d => days[d] = 0);
            data.forEach(r => {
                const day = parseInt(r.follow_up_day);
                if (!isNaN(day)) days[day] = (days[day] || 0) + 1;
            });
            
            const ctx = document.getElementById('followupDayChart');
            if (!ctx) return;
            
            dashboardCharts.followupDay = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: CONFIG.FOLLOW_UP_DAYS.map(d => `Day ${d}`),
                    datasets: [{
                        label: 'Follow-ups',
                        data: CONFIG.FOLLOW_UP_DAYS.map(d => days[d]),
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createEnrollmentTrendChart(data) {
            // Group by date
            const byDate = {};
            data.forEach(r => {
                const date = r.date_of_visit || r.timestamp?.split('T')[0] || 'Unknown';
                byDate[date] = (byDate[date] || 0) + 1;
            });
            
            const sortedDates = Object.keys(byDate).sort();
            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += byDate[date];
                return cumulative;
            });
            
            const ctx = document.getElementById('enrollmentTrendChart');
            if (!ctx) return;
            
            dashboardCharts.enrollmentTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Cumulative Enrollment',
                        data: cumulativeData,
                        borderColor: '#fd7e14',
                        backgroundColor: 'rgba(253, 126, 20, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createScreeningEligibilityDonut(data) {
            const eligible = data.filter(r => r.is_eligible === 'Yes').length;
            const notEligible = data.filter(r => r.is_eligible === 'No').length;
            
            const ctx = document.getElementById('screeningEligibilityDonut');
            if (!ctx) return;
            
            dashboardCharts.screeningEligibility = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Eligible', 'Not Eligible'],
                    datasets: [{
                        data: [eligible, notEligible],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createAgeHistogram(data) {
            const ages = data.map(r => parseFloat(r.estimated_age) || 0).filter(a => a > 0);
            const bins = [0, 12, 24, 36, 48, 60];
            const binLabels = ['0-12m', '13-24m', '25-36m', '37-48m', '49-59m'];
            const binCounts = binLabels.map(() => 0);
            
            ages.forEach(age => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (age > bins[i] && age <= bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });
            
            const ctx = document.getElementById('ageHistogram');
            if (!ctx) return;
            
            dashboardCharts.ageHistogram = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Patients',
                        data: binCounts,
                        backgroundColor: '#6f42c1'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createTempHistogram(data) {
            const temps = data.map(r => parseFloat(r.temperature) || 0).filter(t => t > 35);
            const bins = [35, 36, 37, 37.5, 38, 39, 40, 42];
            const binLabels = ['35-36', '36-37', '37-37.5', '37.5-38', '38-39', '39-40', '40+'];
            const binCounts = binLabels.map(() => 0);
            
            temps.forEach(temp => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (temp >= bins[i] && temp < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });
            
            const ctx = document.getElementById('tempHistogram');
            if (!ctx) return;
            
            dashboardCharts.tempHistogram = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Patients',
                        data: binCounts,
                        backgroundColor: '#dc3545'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createParasiteChart(data) {
            const ranges = { '<2000': 0, '2000-50000': 0, '50000-100000': 0, '100000-200000': 0, '>200000': 0 };
            data.forEach(r => {
                const count = parseFloat(r.approx_parasite_count) || 0;
                if (count < 2000) ranges['<2000']++;
                else if (count <= 50000) ranges['2000-50000']++;
                else if (count <= 100000) ranges['50000-100000']++;
                else if (count <= 200000) ranges['100000-200000']++;
                else ranges['>200000']++;
            });
            
            const ctx = document.getElementById('parasiteChart');
            if (!ctx) return;
            
            dashboardCharts.parasite = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Patients',
                        data: Object.values(ranges),
                        backgroundColor: '#fd7e14'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createSpeciesChart(data) {
            const species = { 'P. falciparum': 0, 'P. vivax': 0, 'P. ovale': 0, 'P. malariae': 0 };
            data.forEach(r => {
                const sp = r.species || '';
                Object.keys(species).forEach(s => {
                    if (sp.includes(s)) species[s]++;
                });
            });
            
            const ctx = document.getElementById('speciesChart');
            if (!ctx) return;
            
            dashboardCharts.species = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(species),
                    datasets: [{
                        data: Object.values(species),
                        backgroundColor: ['#004080', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createScreeningByCentre(data) {
            const centres = {};
            data.forEach(r => {
                const centre = (r.health_centre_name || 'Unknown').replace(' Government Hospital', '');
                if (!centres[centre]) centres[centre] = { eligible: 0, notEligible: 0 };
                if (r.is_eligible === 'Yes') centres[centre].eligible++;
                else centres[centre].notEligible++;
            });
            
            const ctx = document.getElementById('screeningByCentre');
            if (!ctx) return;
            
            dashboardCharts.screeningByCentre = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(centres),
                    datasets: [
                        { label: 'Eligible', data: Object.values(centres).map(c => c.eligible), backgroundColor: '#28a745' },
                        { label: 'Not Eligible', data: Object.values(centres).map(c => c.notEligible), backgroundColor: '#dc3545' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        function createFollowupBarChart(data) {
            const days = {};
            CONFIG.FOLLOW_UP_DAYS.forEach(d => days[d] = 0);
            data.forEach(r => {
                const day = parseInt(r.follow_up_day);
                if (!isNaN(day)) days[day] = (days[day] || 0) + 1;
            });
            
            const ctx = document.getElementById('followupBarChart');
            if (!ctx) return;
            
            const colors = CONFIG.FOLLOW_UP_DAYS.map((d, i) => `hsl(${i * 36}, 70%, 50%)`);
            
            dashboardCharts.followupBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: CONFIG.FOLLOW_UP_DAYS.map(d => `Day ${d}`),
                    datasets: [{
                        label: 'Completed',
                        data: CONFIG.FOLLOW_UP_DAYS.map(d => days[d]),
                        backgroundColor: colors
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function createCompletionDonut(data) {
            const totalExpected = Object.keys(state.patients).length * 10;
            const totalCompleted = data.length;
            const remaining = Math.max(0, totalExpected - totalCompleted);
            
            const ctx = document.getElementById('completionDonut');
            if (!ctx) return;
            
            dashboardCharts.completion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [totalCompleted, remaining],
                        backgroundColor: ['#28a745', '#e9ecef']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createAdverseEventsChart(data) {
            const withAE = data.filter(r => r.adverse_event_present === 'Yes').length;
            const withoutAE = data.length - withAE;
            const serious = data.filter(r => r.serious_adverse_event === 'Yes').length;
            
            const ctx = document.getElementById('adverseEventsChart');
            if (!ctx) return;
            
            dashboardCharts.adverseEvents = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['No AE', 'AE (Non-Serious)', 'Serious AE'],
                    datasets: [{
                        data: [withoutAE, withAE - serious, serious],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createTempTrendChart(data) {
            const byDay = {};
            CONFIG.FOLLOW_UP_DAYS.forEach(d => byDay[d] = []);
            data.forEach(r => {
                const day = parseInt(r.follow_up_day);
                const temp = parseFloat(r.temperature);
                if (!isNaN(day) && !isNaN(temp)) byDay[day].push(temp);
            });
            
            const avgTemps = CONFIG.FOLLOW_UP_DAYS.map(d => {
                const temps = byDay[d];
                return temps.length > 0 ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) : null;
            });
            
            const ctx = document.getElementById('tempTrendChart');
            if (!ctx) return;
            
            dashboardCharts.tempTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: CONFIG.FOLLOW_UP_DAYS.map(d => `D${d}`),
                    datasets: [{
                        label: 'Avg Temp (Â°C)',
                        data: avgTemps,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function createParasiteClearanceChart(data) {
            const byDay = {};
            CONFIG.FOLLOW_UP_DAYS.forEach(d => byDay[d] = []);
            data.forEach(r => {
                const day = parseInt(r.follow_up_day);
                const count = parseFloat(r.avg_asexual_parasites);
                if (!isNaN(day) && !isNaN(count)) byDay[day].push(count);
            });
            
            const avgCounts = CONFIG.FOLLOW_UP_DAYS.map(d => {
                const counts = byDay[d];
                return counts.length > 0 ? Math.round(counts.reduce((a, b) => a + b, 0) / counts.length) : null;
            });
            
            const ctx = document.getElementById('parasiteClearanceChart');
            if (!ctx) return;
            
            dashboardCharts.parasiteClearance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: CONFIG.FOLLOW_UP_DAYS.map(d => `D${d}`),
                    datasets: [{
                        label: 'Avg Parasite Count',
                        data: avgCounts,
                        borderColor: '#004080',
                        backgroundColor: 'rgba(0, 64, 128, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
            });
        }

        // ============================================
        // UTILITY
        // ============================================
        function updateOnlineStatus() {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            indicator.className = state.isOnline ? 'status-indicator online' : 'status-indicator offline';
            text.textContent = state.isOnline ? 'ONLINE' : 'OFFLINE';
        }

        function updateCounts() {
            document.getElementById('pendingCount').textContent = state.pendingSubmissions.length;
            const eligibleCount = Object.values(state.patients).filter(p => p.isEligible).length;
            document.getElementById('screenedCount').textContent = eligibleCount;
            document.getElementById('patientCountBadge').textContent = eligibleCount;
        }

        function handleOnlineEvent() { state.isOnline = true; updateOnlineStatus(); showNotification('Back online - Syncing data...', 'info'); syncPendingSubmissions(); }
        function handleOfflineEvent() { state.isOnline = false; updateOnlineStatus(); showNotification('You are offline - Data will be saved locally', 'info'); }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            notification.className = `notification ${type} show`;
            text.textContent = message;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        // Modal close handlers
        document.getElementById('voucherModal').addEventListener('click', function(e) { if (e.target === this) closeVoucherModal(); });
        document.getElementById('scannerModal').addEventListener('click', function(e) { if (e.target === this) closeScannerModal(); });
        document.getElementById('patientsModal').addEventListener('click', function(e) { if (e.target === this) closePatientsModal(); });
        document.getElementById('viewDataModal').addEventListener('click', function(e) { if (e.target === this) closeViewDataModal(); });
        document.getElementById('dashboardModal').addEventListener('click', function(e) { if (e.target === this) closeDashboard(); });
        document.getElementById('dhis2Modal').addEventListener('click', function(e) { if (e.target === this) closeDhis2Modal(); });

        // ============================================
        // DHIS2 INTEGRATION
        // ============================================
        const dhis2State = {
            isConnected: false,
            currentProxyIndex: -1,
            programId: '',
            programStageId: '',
            trackedEntityTypeId: '',
            dataElementIds: {}
        };

        // Tracker Program Data Elements for TES
        const TES_DATA_ELEMENTS = [
            // Screening/Enrollment attributes
            { code: 'TES_SCREENING_NUM', name: 'TES Screening Number', valueType: 'TEXT' },
            { code: 'TES_PATIENT_NAME', name: 'TES Patient Name', valueType: 'TEXT' },
            { code: 'TES_PATIENT_ID', name: 'TES Patient ID', valueType: 'TEXT' },
            { code: 'TES_DOB', name: 'TES Date of Birth', valueType: 'DATE' },
            { code: 'TES_AGE_MONTHS', name: 'TES Age (Months)', valueType: 'INTEGER' },
            { code: 'TES_SEX', name: 'TES Sex', valueType: 'TEXT' },
            { code: 'TES_WEIGHT', name: 'TES Weight (kg)', valueType: 'NUMBER' },
            { code: 'TES_PHONE', name: 'TES Phone', valueType: 'PHONE_NUMBER' },
            // Clinical data
            { code: 'TES_TEMPERATURE', name: 'TES Temperature', valueType: 'NUMBER' },
            { code: 'TES_FEVER_HISTORY', name: 'TES Fever History 24h', valueType: 'BOOLEAN' },
            { code: 'TES_PARASITE_COUNT', name: 'TES Parasite Count', valueType: 'INTEGER' },
            { code: 'TES_SPECIES', name: 'TES Malaria Species', valueType: 'TEXT' },
            { code: 'TES_GAMETOCYTES', name: 'TES Gametocytes Present', valueType: 'BOOLEAN' },
            { code: 'TES_PCR_COLLECTED', name: 'TES PCR Collected', valueType: 'BOOLEAN' },
            { code: 'TES_ELIGIBLE', name: 'TES Eligible', valueType: 'BOOLEAN' },
            { code: 'TES_CONSENT', name: 'TES Consent Signed', valueType: 'BOOLEAN' },
            // Follow-up data
            { code: 'TES_FU_DAY', name: 'TES Follow-up Day', valueType: 'INTEGER' },
            { code: 'TES_FU_TEMP', name: 'TES Follow-up Temperature', valueType: 'NUMBER' },
            { code: 'TES_FU_PARASITES', name: 'TES Follow-up Parasite Count', valueType: 'INTEGER' },
            { code: 'TES_FU_DANGER_SIGNS', name: 'TES Danger Signs', valueType: 'BOOLEAN' },
            { code: 'TES_ADVERSE_EVENT', name: 'TES Adverse Event', valueType: 'BOOLEAN' },
            { code: 'TES_AE_DESCRIPTION', name: 'TES AE Description', valueType: 'LONG_TEXT' },
            { code: 'TES_SERIOUS_AE', name: 'TES Serious AE', valueType: 'BOOLEAN' },
            { code: 'TES_OUTCOME', name: 'TES Treatment Outcome', valueType: 'TEXT' }
        ];

        // Get org unit UID for a health facility name
        function getOrgUnitForFacility(facilityName) {
            return CONFIG.DHIS2.ORG_UNITS[facilityName] || null;
        }

        // Get all mapped org unit UIDs
        function getMappedOrgUnits() {
            return Object.values(CONFIG.DHIS2.ORG_UNITS).filter(uid => uid && !uid.startsWith('xxxxxxx'));
        }

        // Build proxy URL based on proxy type
        function buildProxyUrl(proxy, targetUrl, auth, method) {
            if (proxy.type === 'direct') {
                return targetUrl; // Direct connection
            } else if (proxy.type === 'gas') {
                let proxyUrl = proxy.url + '?url=' + encodeURIComponent(targetUrl);
                if (auth) {
                    proxyUrl += '&auth=' + encodeURIComponent(auth);
                }
                if (method && method !== 'GET') {
                    proxyUrl += '&method=' + method;
                }
                return proxyUrl;
            } else {
                // CORS proxy type
                return proxy.url + encodeURIComponent(targetUrl);
            }
        }

        // DHIS2 API call with automatic proxy fallback
        async function dhis2Fetch(endpoint, options = {}) {
            const targetUrl = CONFIG.DHIS2.SERVER_URL + endpoint;
            const auth = btoa(CONFIG.DHIS2.USERNAME + ':' + CONFIG.DHIS2.PASSWORD);
            const method = options.method || 'GET';
            
            const baseHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            // Try with current working proxy first (if we found one before)
            if (dhis2State.currentProxyIndex >= 0 && dhis2State.currentProxyIndex < CONFIG.PROXIES.length) {
                try {
                    const proxy = CONFIG.PROXIES[dhis2State.currentProxyIndex];
                    const proxyUrl = buildProxyUrl(proxy, targetUrl, auth, method);
                    
                    const fetchOptions = {
                        ...options,
                        headers: proxy.type === 'gas' 
                            ? { ...baseHeaders, ...options.headers }
                            : { ...baseHeaders, 'Authorization': 'Basic ' + auth, ...options.headers }
                    };
                    
                    const response = await fetch(proxyUrl, fetchOptions);
                    if (response.ok || response.status < 500) return response;
                } catch (e) {
                    console.log('Cached proxy failed, trying others...');
                }
            }

            // Try each proxy in order
            for (let i = 0; i < CONFIG.PROXIES.length; i++) {
                const proxy = CONFIG.PROXIES[i];
                
                try {
                    console.log(`Trying ${proxy.name}...`);
                    const proxyUrl = buildProxyUrl(proxy, targetUrl, auth, method);
                    
                    // For GAS proxy, auth is passed as parameter, not header
                    const fetchOptions = {
                        ...options,
                        headers: proxy.type === 'gas' 
                            ? { ...baseHeaders, ...options.headers }
                            : { ...baseHeaders, 'Authorization': 'Basic ' + auth, ...options.headers }
                    };
                    
                    // For direct connection, add CORS mode
                    if (proxy.type === 'direct') {
                        fetchOptions.mode = 'cors';
                    }
                    
                    const response = await fetch(proxyUrl, fetchOptions);
                    
                    if (response.ok || response.status < 500) {
                        dhis2State.currentProxyIndex = i;
                        console.log(`âœ… ${proxy.name} working!`);
                        return response;
                    }
                } catch (e) {
                    console.log(`âŒ ${proxy.name} failed:`, e.message);
                }
            }
            
            throw new Error('All connection methods failed. Check DHIS2 URL and credentials.');
        }

        // Test DHIS2 connection
        async function testDhis2Connection() {
            const statusDiv = document.getElementById('dhis2ConnectionStatus');
            statusDiv.innerHTML = '<div class="dhis2-status info">ðŸ”„ Testing connection...</div>';
            
            try {
                const response = await dhis2Fetch('/api/me');
                if (response.ok) {
                    const user = await response.json();
                    dhis2State.isConnected = true;
                    statusDiv.innerHTML = `<div class="dhis2-status success">âœ… Connected as: ${user.displayName || user.name}</div>`;
                    showNotification('DHIS2 connection successful!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                dhis2State.isConnected = false;
                statusDiv.innerHTML = `<div class="dhis2-status error">âŒ ${error.message}</div>`;
            }
        }

        // AUTO-SETUP: Creates everything in DHIS2 with one click
        async function autoSetupDhis2() {
            if (!state.isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }

            const btn = document.getElementById('autoSetupBtn');
            const logDiv = document.getElementById('dhis2SetupLog');
            
            btn.disabled = true;
            btn.innerHTML = 'â³ SETTING UP...';
            logDiv.style.display = 'block';
            logDiv.innerHTML = '';

            try {
                logEntry('dhis2SetupLog', 'ðŸš€ Starting DHIS2 Auto-Setup...', 'info');
                logEntry('dhis2SetupLog', `Server: ${CONFIG.DHIS2.SERVER_URL}`, 'info');

                // 1. Test connection
                logEntry('dhis2SetupLog', 'ðŸ”— Testing connection...', 'info');
                const meResponse = await dhis2Fetch('/api/me');
                if (!meResponse.ok) throw new Error('Connection failed');
                const user = await meResponse.json();
                logEntry('dhis2SetupLog', `âœ… Connected as: ${user.displayName}`, 'success');
                dhis2State.isConnected = true;

                // 2. Get or create tracked entity type
                logEntry('dhis2SetupLog', 'ðŸ‘¤ Setting up Tracked Entity Type...', 'info');
                let tetId = await findOrCreate('trackedEntityTypes', {
                    name: 'TES Patient',
                    code: 'TES_PATIENT'
                }, 'TES_PATIENT');
                dhis2State.trackedEntityTypeId = tetId;
                logEntry('dhis2SetupLog', `âœ… Tracked Entity Type: ${tetId}`, 'success');

                // 3. Create data elements
                logEntry('dhis2SetupLog', 'ðŸ“ Creating Data Elements...', 'info');
                for (const de of TES_DATA_ELEMENTS) {
                    try {
                        const deId = await findOrCreate('dataElements', {
                            name: de.name,
                            shortName: de.name.substring(0, 50),
                            code: de.code,
                            valueType: de.valueType,
                            domainType: 'TRACKER',
                            aggregationType: 'NONE'
                        }, de.code);
                        dhis2State.dataElementIds[de.code] = deId;
                        logEntry('dhis2SetupLog', `  âœ… ${de.code}`, 'success');
                    } catch (e) {
                        logEntry('dhis2SetupLog', `  âš ï¸ ${de.code} (may exist)`, 'info');
                    }
                }

                // 4. Create Program
                logEntry('dhis2SetupLog', 'ðŸ“‹ Creating Tracker Program...', 'info');
                const orgUnits = getMappedOrgUnits();
                const programId = await findOrCreate('programs', {
                    name: CONFIG.DHIS2.DATASET_NAME,
                    shortName: 'TES 2026',
                    code: CONFIG.DHIS2.PROGRAM_CODE || 'TES_2026_TRACKER',
                    programType: 'WITH_REGISTRATION',
                    trackedEntityType: { id: tetId },
                    organisationUnits: orgUnits.map(id => ({ id }))
                }, CONFIG.DHIS2.PROGRAM_CODE || 'TES_2026_TRACKER');
                dhis2State.programId = programId;
                logEntry('dhis2SetupLog', `âœ… Program created: ${programId}`, 'success');

                // 5. Create Program Stage
                logEntry('dhis2SetupLog', 'ðŸ“… Creating Program Stage...', 'info');
                const stageId = await findOrCreate('programStages', {
                    name: 'TES Visit',
                    code: 'TES_VISIT_STAGE',
                    program: { id: programId },
                    repeatable: true,
                    programStageDataElements: Object.keys(dhis2State.dataElementIds).map(code => ({
                        dataElement: { id: dhis2State.dataElementIds[code] },
                        compulsory: false
                    }))
                }, 'TES_VISIT_STAGE');
                dhis2State.programStageId = stageId;
                logEntry('dhis2SetupLog', `âœ… Program Stage: ${stageId}`, 'success');

                // Save state
                localStorage.setItem('tes_dhis2_state', JSON.stringify(dhis2State));

                logEntry('dhis2SetupLog', '', 'info');
                logEntry('dhis2SetupLog', 'ðŸŽ‰ AUTO-SETUP COMPLETE!', 'success');
                logEntry('dhis2SetupLog', `Program ID: ${programId}`, 'info');
                logEntry('dhis2SetupLog', `Org Units: ${orgUnits.length} facilities`, 'info');
                
                showNotification('âœ… DHIS2 setup complete!', 'success');

            } catch (error) {
                logEntry('dhis2SetupLog', `âŒ Error: ${error.message}`, 'error');
                showNotification('Setup failed: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'âš¡ AUTO-SETUP DHIS2 (One Click)';
            }
        }

        // Helper: Find existing or create new metadata
        async function findOrCreate(endpoint, payload, code) {
            // Search first
            try {
                const searchResp = await dhis2Fetch(`/api/${endpoint}?filter=code:eq:${code}&fields=id`);
                if (searchResp.ok) {
                    const data = await searchResp.json();
                    if (data[endpoint]?.length > 0) {
                        return data[endpoint][0].id;
                    }
                }
            } catch (e) { }

            // Create new
            const createResp = await dhis2Fetch(`/api/${endpoint}`, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            if (createResp.ok || createResp.status === 201) {
                const result = await createResp.json();
                return result.response?.uid || result.response?.lastImported || code;
            }
            
            // If conflict (already exists), try to find it
            if (createResp.status === 409) {
                const searchResp = await dhis2Fetch(`/api/${endpoint}?filter=code:eq:${code}&fields=id`);
                const data = await searchResp.json();
                if (data[endpoint]?.length > 0) {
                    return data[endpoint][0].id;
                }
            }
            
            throw new Error(`Failed to create ${endpoint}: ${createResp.status}`);
        }

        // SYNC: Push data to DHIS2
        async function syncDataToDhis2() {
            const btn = document.getElementById('syncBtn');
            const progressDiv = document.getElementById('dhis2SyncProgress');
            const progressBar = document.getElementById('dhis2ProgressBar');
            const resultDiv = document.getElementById('dhis2SyncResult');
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'ðŸ”„ SYNCING...';
            }
            if (progressDiv) progressDiv.style.display = 'block';
            if (progressBar) progressBar.style.width = '10%';
            if (resultDiv) resultDiv.style.display = 'none';

            try {
                // Load saved DHIS2 state
                const savedState = localStorage.getItem('tes_dhis2_state');
                if (savedState) {
                    Object.assign(dhis2State, JSON.parse(savedState));
                }

                // Gather data
                const patients = Object.values(state.patients);
                const eligiblePatients = patients.filter(p => p.isEligible);
                const submissions = state.submissions;
                
                if (progressBar) progressBar.style.width = '30%';

                let syncedCount = 0;
                let errorCount = 0;

                // Sync each eligible patient
                for (const patient of eligiblePatients) {
                    try {
                        const orgUnit = getOrgUnitForFacility(patient.health_centre_name);
                        if (!orgUnit || orgUnit.startsWith('xxxxxxx')) {
                            console.log(`Skipping ${patient.patient_id}: No org unit mapping for ${patient.health_centre_name}`);
                            continue;
                        }

                        // Create/Update Tracked Entity Instance
                        const teiPayload = {
                            trackedEntityType: dhis2State.trackedEntityTypeId,
                            orgUnit: orgUnit,
                            attributes: [
                                { attribute: dhis2State.dataElementIds['TES_PATIENT_ID'], value: patient.patient_identity_number || patient.patient_id },
                                { attribute: dhis2State.dataElementIds['TES_PATIENT_NAME'], value: patient.patient_name || '' },
                                { attribute: dhis2State.dataElementIds['TES_SCREENING_NUM'], value: patient.patient_screening_number || '' }
                            ].filter(a => a.attribute && a.value)
                        };

                        // For simplicity, we'll use events instead of full tracker
                        const eventPayload = {
                            program: dhis2State.programId,
                            programStage: dhis2State.programStageId,
                            orgUnit: orgUnit,
                            eventDate: patient.date_of_visit || new Date().toISOString().split('T')[0],
                            status: 'COMPLETED',
                            dataValues: [
                                { dataElement: dhis2State.dataElementIds['TES_PATIENT_NAME'], value: patient.patient_name },
                                { dataElement: dhis2State.dataElementIds['TES_PATIENT_ID'], value: patient.patient_identity_number },
                                { dataElement: dhis2State.dataElementIds['TES_WEIGHT'], value: patient.weight_kg },
                                { dataElement: dhis2State.dataElementIds['TES_TEMPERATURE'], value: patient.temperature },
                                { dataElement: dhis2State.dataElementIds['TES_PARASITE_COUNT'], value: patient.approx_parasite_count },
                                { dataElement: dhis2State.dataElementIds['TES_ELIGIBLE'], value: patient.isEligible ? 'true' : 'false' }
                            ].filter(dv => dv.dataElement && dv.value !== undefined && dv.value !== '')
                        };

                        const eventResp = await dhis2Fetch('/api/events', {
                            method: 'POST',
                            body: JSON.stringify(eventPayload)
                        });

                        if (eventResp.ok || eventResp.status === 201) {
                            syncedCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (e) {
                        errorCount++;
                        console.error('Sync error for patient:', e);
                    }
                }

                if (progressBar) progressBar.style.width = '100%';

                // Show result
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="dhis2-status ${errorCount === 0 ? 'success' : 'warning'}">
                            <h3 style="margin: 0 0 10px 0;">${errorCount === 0 ? 'âœ… Sync Complete!' : 'âš ï¸ Sync Completed with Errors'}</h3>
                            <p><strong>Synced:</strong> ${syncedCount} patients</p>
                            ${errorCount > 0 ? `<p><strong>Errors:</strong> ${errorCount}</p>` : ''}
                            <p style="margin-top: 10px; font-size: 11px; color: #666;">
                                ${new Date().toLocaleString()}
                            </p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }

                showNotification(`âœ… Synced ${syncedCount} patients to DHIS2`, 'success');

            } catch (error) {
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="dhis2-status error">
                            <h3 style="margin: 0 0 10px 0;">âŒ Sync Failed</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }
                showNotification('Sync failed: ' + error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'ðŸš€ SYNC TO DHIS2';
                }
                setTimeout(() => {
                    if (progressDiv) progressDiv.style.display = 'none';
                }, 2000);
            }
        }

        // Update sync stats display
        function updateSyncStats() {
            const patients = Object.values(state.patients);
            const screeningCount = patients.filter(p => p.isEligible).length;
            const followupCount = Object.keys(state.submissions).filter(k => k.includes('_')).length;
            const patientsCount = patients.length;
            
            // User view
            const el1 = document.getElementById('syncScreeningCount');
            const el2 = document.getElementById('syncFollowupCount');
            const el3 = document.getElementById('syncPatientsCount');
            if (el1) el1.textContent = screeningCount;
            if (el2) el2.textContent = followupCount;
            if (el3) el3.textContent = patientsCount;
            
            // Admin view
            const el4 = document.getElementById('adminSyncScreening');
            const el5 = document.getElementById('adminSyncFollowup');
            if (el4) el4.textContent = screeningCount;
            if (el5) el5.textContent = followupCount;
        }

        // Open DHIS2 Modal
        function openDhis2Modal() {
            document.getElementById('dhis2Modal').classList.add('show');
            
            if (state.isAdmin) {
                document.getElementById('dhis2UserView').style.display = 'none';
                document.getElementById('dhis2AdminView').style.display = 'block';
                
                // Show admin info
                const serverEl = document.getElementById('adminServerUrl');
                const userEl = document.getElementById('adminUsername');
                const orgEl = document.getElementById('adminOrgCount');
                
                if (serverEl) serverEl.textContent = CONFIG.DHIS2.SERVER_URL;
                if (userEl) userEl.textContent = CONFIG.DHIS2.USERNAME;
                if (orgEl) orgEl.textContent = Object.keys(CONFIG.DHIS2.ORG_UNITS).length;
            } else {
                document.getElementById('dhis2UserView').style.display = 'block';
                document.getElementById('dhis2AdminView').style.display = 'none';
            }
            
            updateSyncStats();
        }

        function closeDhis2Modal() {
            document.getElementById('dhis2Modal').classList.remove('show');
        }

        function showDhis2Status(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) el.innerHTML = `<div class="dhis2-status ${type}">${message}</div>`;
        }

        function logEntry(logId, message, type = 'info') {
            const el = document.getElementById(logId);
            if (el) {
                const time = new Date().toLocaleTimeString();
                el.innerHTML += `<div class="dhis2-log-entry ${type}">[${time}] ${message}</div>`;
                el.scrollTop = el.scrollHeight;
            }
        }

        init();
    </script>
</body>
</html>
